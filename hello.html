<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NearCheck Lite - Attendance System</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Base Styles & Variables */
        :root {
            /* Color Palette */
            --primary-color: #007AFF;
            /* Apple's signature blue */
            --primary-hover: #0066CC;
            --primary-active: #0052A3;
            --secondary-color: #34C759;
            /* Apple green */
            --danger-color: #FF3B30;
            /* Apple red */
            --warning-color: #FF9500;
            /* Apple orange */
            --background-color: #FFFFFF;
            --card-background: #F2F2F7;
            --text-primary: #1C1C1E;
            --text-secondary: #636366;
            --text-tertiary: #8E8E93;
            --border-color: #D1D1D6;
            --shadow-color: rgba(0, 0, 0, 0.1);

            /* Dark Mode Colors */
            --dark-background: #1C1C1E;
            --dark-card: #2C2C2E;
            --dark-text-primary: #F2F2F7;
            --dark-text-secondary: #AEAEB2;
            --dark-border-color: #3A3A3C;

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 48px;

            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-size-sm: 13px;
            --font-size-md: 15px;
            --font-size-lg: 17px;
            --font-size-xl: 20px;
            --font-size-xxl: 28px;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Border Radius */
            --border-radius-sm: 6px;
            --border-radius-md: 12px;
            --border-radius-lg: 18px;
            --border-radius-circle: 50%;

            /* Shadows */
            --shadow-sm: 0 1px 3px var(--shadow-color);
            --shadow-md: 0 4px 8px var(--shadow-color);
            --shadow-lg: 0 8px 16px var(--shadow-color);
            --shadow-xl: 0 12px 24px var(--shadow-color);

            /* Transitions */
            --transition-fast: 0.15s cubic-bezier(0.25, 0.1, 0.25, 1);
            --transition-medium: 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            --transition-slow: 0.45s cubic-bezier(0.25, 0.1, 0.25, 1);
            --spring-transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);

            /* Z-index */
            --z-index-base: 1;
            --z-index-drawer: 100;
            --z-index-modal: 200;
            --z-index-toast: 300;
        }

        /* Dark Mode */
        .dark-theme {
            --background-color: var(--dark-background);
            --card-background: var(--dark-card);
            --text-primary: var(--dark-text-primary);
            --text-secondary: var(--dark-text-secondary);
            --border-color: var(--dark-border-color);
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        /* Font Sizes */
        .font-small {
            --font-size-sm: 12px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-xxl: 24px;
        }

        .font-medium {
            /* Default sizes */
        }

        .font-large {
            --font-size-sm: 15px;
            --font-size-md: 17px;
            --font-size-lg: 19px;
            --font-size-xl: 22px;
            --font-size-xxl: 30px;
        }

        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 100%;
            height: 100%;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-md);
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            transition: background-color var(--transition-medium), color var(--transition-medium);
            overflow-x: hidden;
        }

        /* Typography */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-md);
            line-height: 1.3;
        }

        h1 {
            font-size: var(--font-size-xxl);
        }

        h2 {
            font-size: var(--font-size-xl);
        }

        h3 {
            font-size: var(--font-size-lg);
        }

        p {
            margin-bottom: var(--spacing-md);
            color: var(--text-secondary);
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }

        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            position: relative;
            padding-top: 60px;
            /* For header */
        }

        /* Header */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--background-color);
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            z-index: var(--z-index-base);
            transition: background-color var(--transition-medium), border-color var(--transition-medium);
        }

        .app-header .logo {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin: 0 auto;
        }

        .drawer-button,
        .back-button {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-circle);
            transition: background-color var(--transition-fast);
        }

        .drawer-button:hover,
        .back-button:hover {
            background-color: rgba(var(--primary-color), 0.1);
        }

        /* Drawer */
        .app-drawer {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background-color: var(--background-color);
            box-shadow: var(--shadow-lg);
            z-index: var(--z-index-drawer);
            transition: transform var(--spring-transition);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }

        .app-drawer.open {
            transform: translateX(280px);
        }

        .drawer-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-circle);
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-semibold);
            margin-right: var(--spacing-md);
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: var(--font-weight-semibold);
        }

        .user-role {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .drawer-nav ul {
            list-style: none;
            padding: var(--spacing-md) 0;
        }

        .drawer-nav li {
            margin-bottom: var(--spacing-xs);
        }

        .drawer-nav a {
            display: flex;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-lg);
            color: var(--text-primary);
            transition: background-color var(--transition-fast);
        }

        .drawer-nav a:hover {
            background-color: rgba(var(--primary-color), 0.1);
            color: var(--primary-color);
            text-decoration: none;
        }

        .drawer-nav a i {
            margin-right: var(--spacing-md);
            width: 24px;
            text-align: center;
        }

        .drawer-nav .active a {
            color: var(--primary-color);
            background-color: rgba(var(--primary-color), 0.1);
            border-right: 3px solid var(--primary-color);
        }

        .drawer-footer {
            margin-top: auto;
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        .drawer-footer a {
            display: flex;
            align-items: center;
            color: var(--danger-color);
        }

        .drawer-footer a i {
            margin-right: var(--spacing-md);
        }

        /* Main Content */
        .dashboard-main {
            flex: 1;
            padding: var(--spacing-lg);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .page-title,
        .greeting {
            margin-bottom: var(--spacing-xl);
        }

        /* Cards */
        .dashboard-card,
        .section-card,
        .stat-card {
            background-color: var(--card-background);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast), background-color var(--transition-medium);
        }

        .dashboard-card:hover,
        .section-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .dashboard-card {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .card-icon {
            font-size: var(--font-size-xl);
            color: var(--primary-color);
            margin-right: var(--spacing-md);
        }

        .card-content {
            flex: 1;
        }

        .card-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-xs);
        }

        .card-label {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        /* Section Cards */
        .sections-grid,
        .sections-carousel {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--spacing-md);
        }

        .section-card {
            display: flex;
            flex-direction: column;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
        }

        .section-name {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-xs);
        }

        .section-menu-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--border-radius-circle);
            transition: background-color var(--transition-fast);
        }

        .section-menu-button:hover {
            background-color: rgba(var(--primary-color), 0.1);
            color: var(--primary-color);
        }

        .section-meta {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-md);
        }

        .section-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-lg);
        }

        .attendance-summary {
            display: flex;
            align-items: center;
        }

        .attendance-percent {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            margin-right: var(--spacing-sm);
        }

        .attendance-label {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .students-count {
            display: flex;
            align-items: center;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .students-count i {
            margin-right: var(--spacing-xs);
        }

        /* Buttons */
        button,
        .button {
            border: none;
            border-radius: var(--border-radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        button:disabled,
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        button i,
        .button i {
            margin-right: var(--spacing-xs);
        }

        .primary-button {
            background-color: var(--primary-color);
            color: white;
        }

        .primary-button:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .primary-button:active:not(:disabled) {
            background-color: var(--primary-active);
            transform: translateY(0);
        }

        .secondary-button {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .secondary-button:hover:not(:disabled) {
            background-color: rgba(var(--primary-color), 0.1);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .secondary-button:active:not(:disabled) {
            background-color: rgba(var(--primary-color), 0.2);
            transform: translateY(0);
        }

        .danger-button {
            background-color: var(--danger-color);
            color: white;
        }

        .danger-button:hover:not(:disabled) {
            background-color: #E0352B;
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .danger-button:active:not(:disabled) {
            background-color: #C62F26;
            transform: translateY(0);
        }

        .action-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--border-radius-circle);
            transition: all var(--transition-fast);
        }

        .action-button:hover {
            background-color: rgba(var(--primary-color), 0.1);
            color: var(--primary-color);
        }

        /* Forms */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: var(--font-size-md);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
            background-color: var(--background-color);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color), 0.1);
        }

        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .form-check input {
            margin-right: var(--spacing-sm);
        }

        .form-check label {
            margin-bottom: 0;
            font-weight: var(--font-weight-regular);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .char-counter {
            text-align: right;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }

        /* Range Slider */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
            margin: var(--spacing-md) 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .range-value {
            text-align: center;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--primary-color);
        }

        .range-info {
            text-align: center;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .status-badge.present {
            background-color: rgba(52, 199, 89, 0.1);
            color: #34C759;
        }

        .status-badge.absent {
            background-color: rgba(255, 59, 48, 0.1);
            color: #FF3B30;
        }

        .status-badge.active {
            background-color: rgba(0, 122, 255, 0.1);
            color: var(--primary-color);
        }

        .status-badge.inactive {
            background-color: rgba(142, 142, 147, 0.1);
            color: var(--text-secondary);
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(var(--background-color), 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-index-modal);
            backdrop-filter: blur(4px);
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(var(--primary-color), 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-message {
            font-size: var(--font-size-md);
            color: var(--text-primary);
        }

        /* Modal */
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-index-modal);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--background-color);
            border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalFadeIn var(--transition-medium);
            transform-origin: center center;
            transition: all var(--transition-medium);
        }

        .wide-modal {
            max-width: 800px;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin-bottom: 0;
        }

        .close-button {
            background: none;
            border: none;
            font-size: var(--font-size-lg);
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--border-radius-circle);
            transition: background-color var(--transition-fast);
        }

        .close-button:hover {
            background-color: rgba(var(--primary-color), 0.1);
            color: var(--primary-color);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background-color: var(--background-color);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            z-index: var(--z-index-modal);
            min-width: 200px;
            overflow: hidden;
            animation: contextMenuFadeIn var(--transition-fast);
            transform-origin: top left;
        }

        @keyframes contextMenuFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .context-menu ul {
            list-style: none;
        }

        .context-menu li {
            border-bottom: 1px solid var(--border-color);
        }

        .context-menu li:last-child {
            border-bottom: none;
        }

        .menu-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            background: none;
            border: none;
            text-align: left;
            color: var(--text-primary);
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }

        .menu-item:hover {
            background-color: rgba(var(--primary-color), 0.1);
        }

        .menu-item i {
            margin-right: var(--spacing-md);
            width: 20px;
            text-align: center;
        }

        /* Error & Info Messages */
        .error-message,
        .info-message {
            position: fixed;
            top: var(--spacing-lg);
            left: 50%;
            transform: translateX(-50%);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 90%;
            width: 400px;
            z-index: var(--z-index-toast);
            animation: toastSlideIn 0.3s ease-out;
            box-shadow: var(--shadow-lg);
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .error-message {
            background-color: #FFEBEE;
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        .info-message {
            background-color: #E8F5E9;
            color: var(--secondary-color);
            border-left: 4px solid var(--secondary-color);
        }

        .error-content,
        .info-content {
            display: flex;
            align-items: center;
        }

        .error-content i,
        .info-content i {
            margin-right: var(--spacing-md);
        }

        .error-details {
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-xs);
            color: var(--text-primary);
        }

        .close-error,
        .close-info {
            background: none;
            border: none;
            color: inherit;
            margin-left: var(--spacing-md);
            cursor: pointer;
        }

        .fade-out {
            animation: toastFadeOut 0.3s ease-in forwards;
        }

        @keyframes toastFadeOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-lg);
            grid-column: 1 / -1;
        }

        .empty-icon {
            font-size: 48px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            opacity: 0.6;
        }

        .empty-state h3 {
            margin-bottom: var(--spacing-sm);
        }

        .empty-state p {
            margin-bottom: var(--spacing-lg);
        }

        /* Lists */
        .activity-list,
        .checkin-list,
        .attendance-list,
        .student-list {
            list-style: none;
        }

        .activity-item,
        .checkin-item,
        .attendance-item,
        .student-item {
            background-color: var(--card-background);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        }

        .activity-item:hover,
        .checkin-item:hover,
        .attendance-item:hover,
        .student-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .activity-icon,
        .checkin-icon {
            font-size: var(--font-size-xl);
            margin-right: var(--spacing-md);
        }

        .activity-details,
        .checkin-details {
            flex: 1;
        }

        .activity-title,
        .checkin-title {
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--spacing-xs);
        }

        .activity-meta,
        .checkin-meta {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .checkin-status {
            display: inline-block;
            margin-top: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        /* Student Items */
        .student-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .student-name {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius-circle);
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-semibold);
            margin-right: var(--spacing-md);
        }

        .student-details {
            flex: 1;
        }

        .student-display-name {
            font-weight: var(--font-weight-medium);
        }

        .student-username {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .student-status {
            margin: 0 var(--spacing-md);
        }

        .student-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        /* Attendance Items */
        .attendance-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: var(--spacing-md);
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
        }

        .attendance-date {
            display: flex;
            flex-direction: column;
        }

        .attendance-day {
            font-weight: var(--font-weight-medium);
        }

        .attendance-time {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .attendance-status,
        .attendance-distance,
        .attendance-actions {
            text-align: center;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Skeleton Loading */
        .skeleton {
            background-color: var(--border-color);
            border-radius: var(--border-radius-md);
            position: relative;
            overflow: hidden;
        }

        .skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr 1fr;
            }

            .sections-grid,
            .sections-carousel {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
            }

            .attendance-item {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
                gap: var(--spacing-sm);
            }

            .attendance-date {
                grid-column: 1;
                grid-row: 1;
            }

            .attendance-class {
                grid-column: 2;
                grid-row: 1;
            }

            .attendance-status {
                grid-column: 1;
                grid-row: 2;
            }

            .attendance-distance {
                grid-column: 2;
                grid-row: 2;
            }
        }

        @media (max-width: 480px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions button {
                width: 100%;
            }

            .attendance-item {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto;
            }

            .attendance-date {
                grid-column: 1;
                grid-row: 1;
            }

            .attendance-class {
                grid-column: 1;
                grid-row: 2;
            }

            .attendance-status {
                grid-column: 1;
                grid-row: 3;
            }

            .attendance-distance {
                grid-column: 1;
                grid-row: 4;
            }
        }

        /* Dark Mode Toggle Animation */
        .dark-mode-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            border-radius: 13px;
            background-color: var(--border-color);
            cursor: pointer;
            transition: background-color var(--transition-medium);
        }

        .dark-mode-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: white;
            transition: transform var(--transition-medium);
        }

        .dark-theme .dark-mode-toggle {
            background-color: var(--primary-color);
        }

        .dark-theme .dark-mode-toggle::after {
            transform: translateX(24px);
        }

        /* Physics-based animations */
        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-primary);
        }
    </style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div class="loading-message">Loading...</div>
    </div>

    <!-- Modal Overlay -->
    <div id="modal-overlay" style="display: none;"></div>

    <!-- Error Container (will be added dynamically) -->

    <!-- Main App Container -->
    <div id="app-container"></div>

    <!-- Firebase SDKs will be loaded dynamically -->

    <!-- Your JavaScript -->
    <script>
        // Enhanced Configuration
        const CONFIG = {
            appName: "NearCheck Lite",
            maxLocationRange: 200, // meters
            minLocationRange: 10, // meters
            defaultLocationRange: 100, // meters
            nameChangeWindow: 30, // days
            autoCheckinReminderTime: 15, // minutes
            sessionTimeout: 8, // hours
            privacyPolicyURL: "https://nearcheck.com/privacy",
            termsOfServiceURL: "https://nearcheck.com/terms",
            supportEmail: "support@nearcheck.com",
            minTeacherAge: 20,
            minStudentAge: 13,
            maxNameLength: 50,
            maxSectionNameLength: 30,
            maxSubjectLength: 30
        };

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDFBb1l7GHsPbCMT9_XI6Lqc88dxaAydTQ",
            authDomain: "lite-50af2.firebaseapp.com",
            databaseURL: "https://lite-50af2-default-rtdb.firebaseio.com",
            projectId: "lite-50af2",
            storageBucket: "lite-50af2.firebasestorage.app",
            messagingSenderId: "259126907909",
            appId: "1:259126907909:web:2026713fbcd6cd4442f86c",
            measurementId: "G-9DSQJ1PMHY"
        };

        // Global State Management
        class AppState {
            constructor() {
                this.currentUser = null;
                this.currentRole = null;
                this.currentView = 'auth';
                this.authView = 'signin';
                this.sections = [];
                this.activeSession = null;
                this.enrolledSections = [];
                this.uiTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                this.fontSize = 'medium';
                this.locationPermission = false;
                this.notificationPermission = false;
                this.drawerOpen = false;
                this.isLoading = false;
                this.loadingMessage = '';
                this.error = null;
                this.info = null;
                this.signupRole = 'student';
                this.selectedSection = null;
                this.attendanceRecords = [];
                this.studentsList = [];
                this.reportsData = {};
                this.settings = {
                    notifications: true,
                    darkMode: false,
                    fontSize: 'medium',
                    keepSignedIn: true
                };
            }

            reset() {
                this.currentUser = null;
                this.currentRole = null;
                this.currentView = 'auth';
                this.authView = 'signin';
                this.sections = [];
                this.activeSession = null;
                this.enrolledSections = [];
                this.drawerOpen = false;
                this.isLoading = false;
                this.loadingMessage = '';
                this.error = null;
                this.info = null;
            }
        }

        const APP_STATE = new AppState();

        // DOM Elements Manager
        class DomManager {
            constructor() {
                this.appContainer = document.getElementById('app-container');
                this.loadingScreen = document.getElementById('loading-screen');
                this.modalOverlay = document.getElementById('modal-overlay');
                this.initElements();
            }

            initElements() {
                if (!this.appContainer) {
                    this.appContainer = document.createElement('div');
                    this.appContainer.id = 'app-container';
                    document.body.appendChild(this.appContainer);
                }

                if (!this.loadingScreen) {
                    this.loadingScreen = document.createElement('div');
                    this.loadingScreen.id = 'loading-screen';
                    this.loadingScreen.innerHTML = `
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <div class="loading-message"></div>
                </div>
            `;
                    document.body.appendChild(this.loadingScreen);
                }

                if (!this.modalOverlay) {
                    this.modalOverlay = document.createElement('div');
                    this.modalOverlay.id = 'modal-overlay';
                    document.body.appendChild(this.modalOverlay);
                }
            }

            clearAppContainer() {
                if (this.appContainer) {
                    this.appContainer.innerHTML = '';
                }
            }

            showLoading(message = '') {
                APP_STATE.isLoading = true;
                APP_STATE.loadingMessage = message;

                if (this.loadingScreen) {
                    this.loadingScreen.style.display = 'flex';
                    const messageElement = this.loadingScreen.querySelector('.loading-message');
                    if (messageElement && message) {
                        messageElement.textContent = message;
                    }
                }
            }

            hideLoading() {
                APP_STATE.isLoading = false;
                APP_STATE.loadingMessage = '';

                if (this.loadingScreen) {
                    this.loadingScreen.style.display = 'none';
                }
            }

            showModal(content) {
                if (!this.modalOverlay) {
                    this.modalOverlay = document.createElement('div');
                    this.modalOverlay.id = 'modal-overlay';
                    document.body.appendChild(this.modalOverlay);
                }

                this.modalOverlay.innerHTML = content;
                this.modalOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Prevent scrolling
            }

            hideModal() {
                if (this.modalOverlay) {
                    this.modalOverlay.style.display = 'none';
                    document.body.style.overflow = ''; // Re-enable scrolling
                }
            }
        }

        const DOM = new DomManager();

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase and load the app
            initializeFirebase();

            // Set up theme based on user preference
            setupTheme();

            // Add service worker for PWA
            registerServiceWorker();
        });

        // Firebase Initialization
        function initializeFirebase() {
            DOM.showLoading("Initializing...");

            // Check for cached user
            const cachedUser = localStorage.getItem('nearcheck_user');
            if (cachedUser) {
                try {
                    const userData = JSON.parse(cachedUser);
                    APP_STATE.currentUser = userData;
                    APP_STATE.currentRole = userData.role;
                    loadDashboard();
                    DOM.hideLoading();
                    return;
                } catch (e) {
                    console.error("Error parsing cached user:", e);
                    localStorage.removeItem('nearcheck_user');
                }
            }

            // Dynamically load Firebase SDKs
            const firebaseScripts = [
                'https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js',
                'https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js',
                'https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js',
                'https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js',
                'https://www.gstatic.com/firebasejs/9.6.0/firebase-messaging-compat.js'
            ];

            loadScripts(firebaseScripts, () => {
                try {
                    // Initialize Firebase
                    firebase.initializeApp(firebaseConfig);

                    // Set persistence based on user preference
                    const persistence = APP_STATE.settings.keepSignedIn ?
                        firebase.auth.Auth.Persistence.LOCAL :
                        firebase.auth.Auth.Persistence.SESSION;

                    firebase.auth().setPersistence(persistence)
                        .then(() => {
                            // Check auth state
                            firebase.auth().onAuthStateChanged((user) => {
                                if (user) {
                                    handleUserSignedIn(user);
                                } else {
                                    handleUserSignedOut();
                                }
                            });
                        })
                        .catch((error) => {
                            showError("Initialization failed. Please refresh.", error);
                        });
                } catch (error) {
                    showError("Failed to initialize Firebase.", error);
                }
            });
        }

        // Handle user sign in
        async function handleUserSignedIn(user) {
            DOM.showLoading("Loading your data...");

            try {
                // Get user data from Firestore
                const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    APP_STATE.currentUser = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        ...userData
                    };

                    APP_STATE.currentRole = userData.role;

                    // Cache user data
                    localStorage.setItem('nearcheck_user', JSON.stringify({
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        role: userData.role
                    }));

                    // Check email verification for teachers
                    if (!user.emailVerified && APP_STATE.currentRole === 'teacher') {
                        await firebase.auth().signOut();
                        showEmailVerificationModal(user.email);
                        return;
                    }

                    // Load appropriate view based on role
                    loadDashboard();

                    // Check for location permission
                    checkLocationPermission();

                    // Load user settings
                    loadSettings();
                } else {
                    // User document doesn't exist (shouldn't happen)
                    await firebase.auth().signOut();
                    showError("User data not found. Please contact support.");
                }
            } catch (error) {
                showError("Failed to load your data.", error);
            } finally {
                setTimeout(() => {
                    DOM.hideLoading();
                }, 500);
            }
        }

        // Handle user sign out
        async function handleUserSignedOut() {
            try {
                // Clear cached user
                localStorage.removeItem('nearcheck_user');

                // Reset app state
                APP_STATE.reset();

                // Render auth view
                renderAuthView();
            } catch (error) {
                console.error("Error during sign out:", error);
            } finally {
                setTimeout(() => {
                    DOM.hideLoading();
                }, 500);
            }
        }

        // Load appropriate dashboard based on role
        function loadDashboard() {
            if (APP_STATE.currentRole === 'teacher') {
                loadTeacherDashboard();
            } else {
                loadStudentDashboard();
            }
        }

        // Show email verification modal
        async function showEmailVerificationModal(email) {
            const modalContent = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Email Verification Required</h3>
            </div>
            <div class="modal-body">
                <p>We've sent a verification email to <strong>${escapeHtml(email)}</strong>. Please verify your email to continue.</p>
                <p>If you didn't receive the email, check your spam folder or request a new verification email.</p>
                <div id="verification-status" class="status-message"></div>
            </div>
            <div class="modal-footer">
                <button class="secondary-button" id="resend-verification">Resend Verification</button>
                <button class="primary-button" id="refresh-after-verify">I've Verified My Email</button>
            </div>
        </div>
    `;

            DOM.showModal(modalContent);

            const resendButton = document.getElementById('resend-verification');
            const refreshButton = document.getElementById('refresh-after-verify');
            const statusElement = document.getElementById('verification-status');

            resendButton.addEventListener('click', async () => {
                try {
                    resendButton.disabled = true;
                    statusElement.textContent = "Sending verification email...";
                    statusElement.className = "status-message info";

                    const user = firebase.auth().currentUser;
                    if (!user) {
                        throw new Error("No user is currently signed in.");
                    }

                    await user.sendEmailVerification();
                    statusElement.textContent = "Verification email sent successfully!";
                    statusElement.className = "status-message success";

                    // Re-enable button after 30 seconds to prevent spamming
                    setTimeout(() => {
                        resendButton.disabled = false;
                    }, 30000);

                } catch (error) {
                    console.error("Email verification error:", error);
                    statusElement.textContent = `Failed to resend verification email: ${error.message}`;
                    statusElement.className = "status-message error";
                    resendButton.disabled = false;
                }
            });

            refreshButton.addEventListener('click', async () => {
                try {
                    refreshButton.disabled = true;
                    statusElement.textContent = "Checking verification status...";
                    statusElement.className = "status-message info";

                    const user = firebase.auth().currentUser;
                    if (!user) {
                        throw new Error("No user is currently signed in.");
                    }

                    // Force refresh of user data
                    await user.reload();

                    if (user.emailVerified) {
                        DOM.hideModal();
                        location.reload();
                    } else {
                        statusElement.textContent = "Email not verified yet. Please check your inbox.";
                        statusElement.className = "status-message warning";
                        refreshButton.disabled = false;
                    }
                } catch (error) {
                    console.error("Verification check error:", error);
                    statusElement.textContent = `Error checking verification status: ${error.message}`;
                    statusElement.className = "status-message error";
                    refreshButton.disabled = false;
                }
            });
        }

        // Helper function to prevent XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Render Authentication View
        function renderAuthView() {
            DOM.clearAppContainer();

            const authContainer = document.createElement('div');
            authContainer.className = 'auth-container';

            // Logo
            const logo = document.createElement('div');
            logo.className = 'auth-logo';
            logo.innerHTML = `
        <div class="logo-icon"><i class="fas fa-map-marker-alt"></i></div>
        <h1>${escapeHtml(CONFIG.appName)}</h1>
        <p>Smart geolocation attendance system</p>
    `;

            // Auth Card
            const authCard = document.createElement('div');
            authCard.className = 'auth-card';

            if (APP_STATE.authView === 'signin') {
                authCard.innerHTML = `
            <h2>Sign In</h2>
            <form id="signin-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required autocomplete="current-password">
                    <a href="#" class="forgot-password" id="forgot-password">Forgot password?</a>
                </div>
                <div class="form-check">
                    <input type="checkbox" id="remember-me" checked>
                    <label for="remember-me">Keep me signed in</label>
                </div>
                <button type="submit" class="primary-button">Sign In</button>
            </form>
            <div class="auth-footer">
                <p>New to NearCheck? <a href="#" id="switch-to-signup">Sign up</a></p>
                <p class="terms-notice">By continuing, you agree to our <a href="${CONFIG.termsOfServiceURL}" target="_blank">Terms</a> and <a href="${CONFIG.privacyPolicyURL}" target="_blank">Privacy Policy</a>.</p>
            </div>
        `;
            } else if (APP_STATE.authView === 'signup') {
                authCard.innerHTML = `
            <h2>Create Account</h2>
            <div class="role-selector">
                <button type="button" class="role-option ${APP_STATE.signupRole === 'teacher' ? 'active' : ''}" id="teacher-role">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>I'm a Teacher</span>
                </button>
                <button type="button" class="role-option ${APP_STATE.signupRole === 'student' ? 'active' : ''}" id="student-role">
                    <i class="fas fa-user-graduate"></i>
                    <span>I'm a Student</span>
                </button>
            </div>
            <form id="signup-form">
                <div class="form-group">
                    <label for="fullname">Full Name</label>
                    <input type="text" id="fullname" required maxlength="${CONFIG.maxNameLength}" autocomplete="name">
                </div>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="signup-password">Password (min 8 characters)</label>
                    <input type="password" id="signup-password" required minlength="8" autocomplete="new-password">
                    <div class="password-strength" id="password-strength"></div>
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" required minlength="8" autocomplete="new-password">
                </div>
                ${APP_STATE.signupRole === 'teacher' ? `
                <div class="form-group">
                    <label for="birthdate">Birthdate (Must be ${CONFIG.minTeacherAge}+)</label>
                    <div class="birthdate-inputs">
                        <select id="birth-day" required>
                            <option value="" disabled selected>Day</option>
                            ${Array.from({length: 31}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')
        } <
        /select> <
        select id = "birth-month"
        required >
            <
            option value = ""
        disabled selected > Month < /option> <
            option value = "1" > January < /option> <
            option value = "2" > February < /option> <
            option value = "3" > March < /option> <
            option value = "4" > April < /option> <
            option value = "5" > May < /option> <
            option value = "6" > June < /option> <
            option value = "7" > July < /option> <
            option value = "8" > August < /option> <
            option value = "9" > September < /option> <
            option value = "10" > October < /option> <
            option value = "11" > November < /option> <
            option value = "12" > December < /option> <
            /select> <
            select id = "birth-year"
        required >
            <
            option value = ""
        disabled selected > Year < /option>
        $ {
            Array.from({
                length: 100
            }, (_, i) => {
                const year = new Date().getFullYear() - i;
                return `<option value="${year}">${year}</option>`;
            }).join('')
        } <
        /select> <
        /div> <
        /div>
        ` : ` <
        div class = "form-check" >
        <
        input type = "checkbox"
        id = "age-confirm"
        required >
            <
            label
        for = "age-confirm" > I confirm I 'm ${CONFIG.minStudentAge} years or older</label> <
            /div>
        `}
                <div class="form-check">
                    <input type="checkbox" id="remember-signup" checked>
                    <label for="remember-signup">Keep me signed in</label>
                </div>
                <button type="submit" class="primary-button">Create Account</button>
            </form>
            <div class="auth-footer">
                <p>Already have an account? <a href="#" id="switch-to-signin">Sign in</a></p>
                <p class="terms-notice">By creating an account, you agree to our <a href="${CONFIG.termsOfServiceURL}" target="_blank">Terms</a> and <a href="${CONFIG.privacyPolicyURL}" target="_blank">Privacy Policy</a>.</p>
            </div>
        `;
        }
        else if (APP_STATE.authView === 'forgot') {
            authCard.innerHTML = `
            <h2>Reset Password</h2>
            <form id="forgot-form">
                <div class="form-group">
                    <label for="reset-email">Email</label>
                    <input type="email" id="reset-email" required autocomplete="username">
                </div>
                <button type="submit" class="primary-button">Send Reset Link</button>
            </form>
            <div class="auth-footer">
                <p>Remember your password? <a href="#" id="switch-to-signin">Sign in</a></p>
            </div>
        `;
        }

        authContainer.appendChild(logo);
        authContainer.appendChild(authCard);
        DOM.appContainer.appendChild(authContainer);

        // Add event listeners
        setupAuthEventListeners();
        }

        // Setup auth event listeners
        function setupAuthEventListeners() {
            if (APP_STATE.authView === 'signin') {
                const signinForm = document.getElementById('signin-form');
                if (signinForm) {
                    signinForm.addEventListener('submit', handleSignIn);
                }

                const switchToSignup = document.getElementById('switch-to-signup');
                if (switchToSignup) {
                    switchToSignup.addEventListener('click', (e) => {
                        e.preventDefault();
                        APP_STATE.authView = 'signup';
                        APP_STATE.signupRole = 'student';
                        renderAuthView();
                    });
                }

                const forgotPassword = document.getElementById('forgot-password');
                if (forgotPassword) {
                    forgotPassword.addEventListener('click', (e) => {
                        e.preventDefault();
                        APP_STATE.authView = 'forgot';
                        renderAuthView();
                    });
                }

                // Set remember me preference
                const rememberMe = document.getElementById('remember-me');
                if (rememberMe) {
                    rememberMe.addEventListener('change', (e) => {
                        APP_STATE.settings.keepSignedIn = e.target.checked;
                    });
                }
            } else if (APP_STATE.authView === 'signup') {
                const signupForm = document.getElementById('signup-form');
                if (signupForm) {
                    signupForm.addEventListener('submit', handleSignUp);
                }

                const switchToSignin = document.getElementById('switch-to-signin');
                if (switchToSignin) {
                    switchToSignin.addEventListener('click', (e) => {
                        e.preventDefault();
                        APP_STATE.authView = 'signin';
                        renderAuthView();
                    });
                }

                const teacherRole = document.getElementById('teacher-role');
                if (teacherRole) {
                    teacherRole.addEventListener('click', (e) => {
                        e.preventDefault();
                        APP_STATE.signupRole = 'teacher';
                        renderAuthView();
                    });
                }

                const studentRole = document.getElementById('student-role');
                if (studentRole) {
                    studentRole.addEventListener('click', (e) => {
                        e.preventDefault();
                        APP_STATE.signupRole = 'student';
                        renderAuthView();
                    });
                }

                // Password strength indicator
                const passwordInput = document.getElementById('signup-password');
                const strengthIndicator = document.getElementById('password-strength');

                if (passwordInput && strengthIndicator) {
                    passwordInput.addEventListener('input', () => {
                        const password = passwordInput.value;
                        const strength = calculatePasswordStrength(password);

                        strengthIndicator.innerHTML = '';
                        strengthIndicator.className = 'password-strength';

                        if (password.length > 0) {
                            const strengthBar = document.createElement('div');
                            strengthBar.className = `strength-bar strength-${strength.level}`;
                            strengthBar.style.width = `${strength.score * 25}%`;

                            const strengthText = document.createElement('span');
                            strengthText.textContent = strength.text;

                            strengthIndicator.appendChild(strengthBar);
                            strengthIndicator.appendChild(strengthText);
                            strengthIndicator.style.display = 'block';
                        } else {
                            strengthIndicator.style.display = 'none';
                        }
                    });
                }

                // Set remember me preference
                const rememberSignup = document.getElementById('remember-signup');
                if (rememberSignup) {
                    rememberSignup.addEventListener('change', (e) => {
                        APP_STATE.settings.keepSignedIn = e.target.checked;
                    });
                }
            } else if (APP_STATE.authView === 'forgot') {
                const forgotForm = document.getElementById('forgot-form');
                if (forgotForm) {
                    forgotForm.addEventListener('submit', handleForgotPassword);
                }

                const switchToSignin = document.getElementById('switch-to-signin');
                if (switchToSignin) {
                    switchToSignin.addEventListener('click', (e) => {
                        e.preventDefault();
                        APP_STATE.authView = 'signin';
                        renderAuthView();
                    });
                }
            }
        }

        // Calculate password strength
        function calculatePasswordStrength(password) {
            let score = 0;

            // Length check
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;

            // Complexity checks
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;

            // Determine level and text
            let level, text;
            if (score <= 1) {
                level = 'weak';
                text = 'Weak';
            } else if (score <= 3) {
                level = 'medium';
                text = 'Medium';
            } else {
                level = 'strong';
                text = 'Strong';
            }

            return {
                score,
                level,
                text
            };
        }

        // Handle Sign In
        async function handleSignIn(e) {
            e.preventDefault();
            DOM.showLoading("Signing in...");

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                // Set persistence based on user preference
                const persistence = APP_STATE.settings.keepSignedIn ?
                    firebase.auth.Auth.Persistence.LOCAL :
                    firebase.auth.Auth.Persistence.SESSION;

                await firebase.auth().setPersistence(persistence);

                // Sign in with email and password
                await firebase.auth().signInWithEmailAndPassword(email, password);

                // The rest is handled by the auth state listener
            } catch (error) {
                DOM.hideLoading();

                let errorMessage = "Sign in failed. Please check your credentials.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No account found with this email.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect password. Please try again.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many failed attempts. Please try again later or reset your password.";
                }

                showError(errorMessage, error);
            }
        }

        // Handle Sign Up
        async function handleSignUp(e) {
            e.preventDefault();
            DOM.showLoading("Creating your account...");

            const fullName = document.getElementById('fullname').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const role = APP_STATE.signupRole;

            try {
                // Validate inputs
                if (fullName.length > CONFIG.maxNameLength) {
                    throw new Error(`Name must be less than ${CONFIG.maxNameLength} characters.`);
                }

                if (password !== confirmPassword) {
                    throw new Error("Passwords don't match.");
                }

                // Additional validation for teachers
                if (role === 'teacher') {
                    const day = document.getElementById('birth-day').value;
                    const month = document.getElementById('birth-month').value;
                    const year = document.getElementById('birth-year').value;

                    if (!day || !month || !year) {
                        throw new Error("Please select a valid birthdate.");
                    }

                    // Calculate age
                    const birthDate = new Date(year, month - 1, day);
                    const age = calculateAge(birthDate);

                    if (age < CONFIG.minTeacherAge) {
                        throw new Error(`You must be at least ${CONFIG.minTeacherAge} years old to register as a teacher.`);
                    }
                }

                // Set persistence based on user preference
                const persistence = APP_STATE.settings.keepSignedIn ?
                    firebase.auth.Auth.Persistence.LOCAL :
                    firebase.auth.Auth.Persistence.SESSION;

                await firebase.auth().setPersistence(persistence);

                // Create user
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Generate username
                const username = generateUsername(fullName, role);

                // Set display name
                await user.updateProfile({
                    displayName: fullName
                });

                // Prepare user data
                const userData = {
                    uid: user.uid,
                    email: email,
                    displayName: fullName,
                    username: username,
                    role: role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Add birthdate for teachers
                if (role === 'teacher') {
                    const day = document.getElementById('birth-day').value;
                    const month = document.getElementById('birth-month').value;
                    const year = document.getElementById('birth-year').value;
                    userData.birthdate = `${month}/${day}/${year}`;
                }

                // Create user document
                await firebase.firestore().collection('users').doc(user.uid).set(userData);

                // Send email verification
                await user.sendEmailVerification({
                    url: window.location.href
                });

                // Success
                if (role === 'teacher') {
                    showEmailVerificationModal(email);
                } else {
                    // For students, check if they came from an invite link
                    const urlParams = new URLSearchParams(window.location.search);
                    const sectionId = urlParams.get('sectionid');

                    if (sectionId) {
                        // Join the section
                        await joinSection(sectionId);
                    } else {
                        showInfo("Account created successfully! Please check your email for verification.");
                        APP_STATE.authView = 'signin';
                        renderAuthView();
                    }
                }
            } catch (error) {
                DOM.hideLoading();

                let errorMessage = "Account creation failed.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already registered. Please sign in.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password is too weak. Please use a stronger password.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Please enter a valid email address.";
                }

                showError(errorMessage, error);
            }
        }

        // Calculate age from birthdate
        function calculateAge(birthDate) {
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            return age;
        }

        // Handle Forgot Password
        async function handleForgotPassword(e) {
            e.preventDefault();
            DOM.showLoading("Sending reset link...");

            const email = document.getElementById('reset-email').value;

            try {
                await firebase.auth().sendPasswordResetEmail(email, {
                    url: window.location.href
                });

                DOM.hideLoading();
                showInfo("Password reset link sent to your email. Please check your inbox.");
                APP_STATE.authView = 'signin';
                renderAuthView();
            } catch (error) {
                DOM.hideLoading();

                let errorMessage = "Failed to send reset link.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No account found with this email.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Please enter a valid email address.";
                }

                showError(errorMessage, error);
            }
        }

        // Generate Username
        function generateUsername(fullName, role) {
            const cleanName = fullName.toLowerCase().replace(/[^a-z]/g, '');
            const randomId = Math.floor(1000 + Math.random() * 9000);
            return `${cleanName.substring(0, 10)}${randomId}@${role}`;
        }

        // Load Teacher Dashboard
        function loadTeacherDashboard() {
            APP_STATE.currentView = 'teacher-dashboard';
            renderTeacherDashboard();
            loadTeacherSections();
        }

        // Render Teacher Dashboard
        function renderTeacherDashboard() {
            DOM.clearAppContainer();

            // Header
            const header = document.createElement('header');
            header.className = 'app-header';
            header.innerHTML = `
        <button class="drawer-button" id="drawer-button"><i class="fas fa-bars"></i></button>
        <div class="logo">${CONFIG.appName}</div>
        <button class="create-section-button" id="create-section-button"><i class="fas fa-plus"></i> Create Section</button>
    `;

            // Main Content
            const main = document.createElement('main');
            main.className = 'dashboard-main';

            // Greeting
            const greeting = document.createElement('div');
            greeting.className = 'greeting';
            const now = new Date();
            const hour = now.getHours();
            let timeOfDay = 'day';
            if (hour < 12) timeOfDay = 'morning';
            else if (hour < 18) timeOfDay = 'afternoon';
            else timeOfDay = 'evening';

            const firstName = APP_STATE.currentUser.displayName.split(' ')[0];
            greeting.innerHTML = `<h2>Good ${timeOfDay}, ${firstName}</h2>`;

            // Dashboard Cards
            const dashboardCards = document.createElement('div');
            dashboardCards.className = 'dashboard-cards';

            // Active Sessions Card
            const activeSessionsCard = document.createElement('div');
            activeSessionsCard.className = 'dashboard-card';
            const activeSessionsCount = APP_STATE.sections.filter(s => s.activeSession).length;
            activeSessionsCard.innerHTML = `
        <div class="card-icon"><i class="fas fa-chalkboard-teacher"></i></div>
        <div class="card-content">
            <div class="card-value">${activeSessionsCount}</div>
            <div class="card-label">Active Sessions</div>
        </div>
    `;
            activeSessionsCard.addEventListener('click', () => navigateToView('sections'));

            // Sections Card
            const sectionsCard = document.createElement('div');
            sectionsCard.className = 'dashboard-card';
            sectionsCard.innerHTML = `
        <div class="card-icon"><i class="fas fa-layer-group"></i></div>
        <div class="card-content">
            <div class="card-value">${APP_STATE.sections.length}</div>
            <div class="card-label">Sections</div>
        </div>
    `;
            sectionsCard.addEventListener('click', () => navigateToView('sections'));

            // Students Card
            const studentsCard = document.createElement('div');
            studentsCard.className = 'dashboard-card';
            const totalStudents = APP_STATE.sections.reduce((sum, section) => sum + (section.studentCount || 0), 0);
            studentsCard.innerHTML = `
        <div class="card-icon"><i class="fas fa-users"></i></div>
        <div class="card-content">
            <div class="card-value">${totalStudents}</div>
            <div class="card-label">Students</div>
        </div>
    `;
            studentsCard.addEventListener('click', () => navigateToView('students'));

            // Attendance Rate Card
            const attendanceCard = document.createElement('div');
            attendanceCard.className = 'dashboard-card';
            attendanceCard.innerHTML = `
        <div class="card-icon"><i class="fas fa-calendar-check"></i></div>
        <div class="card-content">
            <div class="card-value">${calculateAverageAttendance()}%</div>
            <div class="card-label">Avg Attendance</div>
        </div>
    `;
            attendanceCard.addEventListener('click', () => navigateToView('reports'));

            dashboardCards.appendChild(activeSessionsCard);
            dashboardCards.appendChild(sectionsCard);
            dashboardCards.appendChild(studentsCard);
            dashboardCards.appendChild(attendanceCard);

            // Recent Activity
            const recentActivity = document.createElement('div');
            recentActivity.className = 'recent-activity';
            recentActivity.innerHTML = `
        <h3>Recent Activity</h3>
        <div class="activity-list" id="activity-list">
            <div class="activity-item skeleton"></div>
            <div class="activity-item skeleton"></div>
            <div class="activity-item skeleton"></div>
        </div>
    `;

            // Sections Carousel
            const sectionsTitle = document.createElement('div');
            sectionsTitle.className = 'section-title';
            sectionsTitle.innerHTML = `
        <h3>Your Sections</h3>
        <a href="#" id="view-all-sections">View All</a>
    `;

            const carousel = document.createElement('div');
            carousel.className = 'sections-carousel';
            carousel.id = 'sections-carousel';

            // Loading skeleton or sections
            if (APP_STATE.sections.length === 0) {
                for (let i = 0; i < 3; i++) {
                    const skeletonCard = document.createElement('div');
                    skeletonCard.className = 'section-card skeleton';
                    skeletonCard.innerHTML = `
                <div class="section-name skeleton" style="width: 70%; height: 24px;"></div>
                <div class="section-info skeleton" style="width: 100%; height: 16px; margin-top: 8px;"></div>
                <div class="section-info skeleton" style="width: 80%; height: 16px; margin-top: 4px;"></div>
                <div class="section-button skeleton" style="width: 100%; height: 36px; margin-top: 12px;"></div>
            `;
                    carousel.appendChild(skeletonCard);
                }
            } else {
                // Only show 3 most recent sections in the carousel
                const recentSections = APP_STATE.sections.slice(0, 3);
                recentSections.forEach(section => {
                    const sectionCard = createSectionCard(section);
                    carousel.appendChild(sectionCard);
                });
            }

            // Drawer
            const drawer = document.createElement('div');
            drawer.className = 'app-drawer';
            drawer.id = 'app-drawer';
            drawer.innerHTML = `
        <div class="drawer-header">
            <div class="user-info">
                <div class="user-avatar">${getInitials(APP_STATE.currentUser.displayName)}</div>
                <div class="user-details">
                    <div class="user-name">${APP_STATE.currentUser.displayName}</div>
                    <div class="user-role">Teacher</div>
                </div>
            </div>
        </div>
        <nav class="drawer-nav">
            <ul>
                <li class="${APP_STATE.currentView === 'teacher-dashboard' ? 'active' : ''}"><a href="#" data-view="teacher-dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="${APP_STATE.currentView === 'sections' ? 'active' : ''}"><a href="#" data-view="sections"><i class="fas fa-layer-group"></i> My Sections</a></li>
                <li class="${APP_STATE.currentView === 'students' ? 'active' : ''}"><a href="#" data-view="students"><i class="fas fa-users"></i> My Students</a></li>
                <li class="${APP_STATE.currentView === 'reports' ? 'active' : ''}"><a href="#" data-view="reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li class="${APP_STATE.currentView === 'settings' ? 'active' : ''}"><a href="#" data-view="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>
        <div class="drawer-footer">
            <a href="#" id="signout-button"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
        </div>
    `;

            main.appendChild(greeting);
            main.appendChild(dashboardCards);
            main.appendChild(recentActivity);
            main.appendChild(sectionsTitle);
            main.appendChild(carousel);

            DOM.appContainer.appendChild(header);
            DOM.appContainer.appendChild(drawer);
            DOM.appContainer.appendChild(main);

            // Load recent activity
            loadRecentActivity();

            // Add event listeners
            setupTeacherDashboardEventListeners();
        }

        // Calculate average attendance rate
        function calculateAverageAttendance() {
            if (APP_STATE.sections.length === 0) return 0;

            let totalRate = 0;
            let count = 0;

            APP_STATE.sections.forEach(section => {
                if (section.lastAttendance) {
                    const present = section.lastAttendance.presentCount || 0;
                    const total = section.lastAttendance.totalStudents || 0;
                    if (total > 0) {
                        totalRate += (present / total) * 100;
                        count++;
                    }
                }
            });

            return count > 0 ? Math.round(totalRate / count) : 0;
        }

        // Load recent activity
        async function loadRecentActivity() {
            const activityList = document.getElementById('activity-list');
            if (!activityList) return;

            try {
                const querySnapshot = await firebase.firestore().collection('attendance')
                    .where('teacherId', '==', APP_STATE.currentUser.uid)
                    .orderBy('checkInTime', 'desc')
                    .limit(3)
                    .get();

                activityList.innerHTML = '';

                if (querySnapshot.empty) {
                    activityList.innerHTML = '<div class="empty-activity">No recent activity yet</div>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const record = doc.data();
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';

                    const date = record.checkInTime.toDate();
                    const section = APP_STATE.sections.find(s => s.id === record.sectionId);
                    const sectionName = section ? section.name : 'Unknown Section';

                    activityItem.innerHTML = `
                <div class="activity-icon">
                    <i class="fas fa-${record.status === 'present' ? 'check-circle' : 'times-circle'}"></i>
                </div>
                <div class="activity-details">
                    <div class="activity-title">${record.studentName || 'Student'} marked ${record.status}</div>
                    <div class="activity-meta">${sectionName}  ${formatTime(date)}</div>
                </div>
            `;

                    activityList.appendChild(activityItem);
                });
            } catch (error) {
                activityList.innerHTML = '<div class="empty-activity">Failed to load activity</div>';
                console.error("Error loading activity:", error);
            }
        }

        // Setup teacher dashboard event listeners
        function setupTeacherDashboardEventListeners() {
            document.getElementById('drawer-button').addEventListener('click', toggleDrawer);
            document.getElementById('create-section-button').addEventListener('click', showCreateSectionForm);
            document.getElementById('signout-button').addEventListener('click', handleSignOut);
            document.getElementById('view-all-sections').addEventListener('click', (e) => {
                e.preventDefault();
                navigateToView('sections');
            });

            // Drawer navigation
            document.querySelectorAll('.drawer-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.target.getAttribute('data-view');
                    navigateToView(view);
                });
            });
        }

        // Create Section Card
        function createSectionCard(section) {
            const card = document.createElement('div');
            card.className = 'section-card';
            card.dataset.sectionId = section.id;

            const lastAttendance = section.lastAttendance || {};
            const presentCount = lastAttendance.presentCount || 0;
            const totalStudents = lastAttendance.totalStudents || 0;
            const attendancePercent = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;

            card.innerHTML = `
        <div class="section-header">
            <h3 class="section-name">${section.name}</h3>
            <button class="section-menu-button"><i class="fas fa-ellipsis-v"></i></button>
        </div>
        <div class="section-meta">
            <span class="section-id">ID: ${section.id}</span>
            <span class="section-schedule">${formatSchedule(section.schedule)}</span>
        </div>
        <div class="section-stats">
            <div class="attendance-summary">
                <div class="attendance-percent">${attendancePercent}%</div>
                <div class="attendance-label">Last Attendance</div>
            </div>
            <div class="students-count">
                <i class="fas fa-users"></i> ${totalStudents} students
            </div>
        </div>
        <button class="primary-button start-session-button" ${section.activeSession ? 'disabled' : ''}>
            ${section.activeSession ? 'Session Active' : 'Start Attendance'}
        </button>
    `;

            // Add event listeners
            card.querySelector('.start-session-button').addEventListener('click', () => startAttendanceSession(section.id));
            card.querySelector('.section-menu-button').addEventListener('click', (e) => showSectionMenu(e, section));

            return card;
        }

        // Load Teacher Sections
        async function loadTeacherSections() {
            DOM.showLoading("Loading your sections...");

            try {
                const querySnapshot = await firebase.firestore().collection('sections')
                    .where('teacherId', '==', APP_STATE.currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();

                APP_STATE.sections = [];
                const sectionPromises = [];

                querySnapshot.forEach((doc) => {
                    const section = {
                        id: doc.id,
                        ...doc.data()
                    };
                    APP_STATE.sections.push(section);

                    // Get last attendance for each section
                    sectionPromises.push(
                        firebase.firestore().collection('attendance')
                        .where('sectionId', '==', doc.id)
                        .orderBy('checkInTime', 'desc')
                        .limit(1)
                        .get()
                        .then(attendanceSnapshot => {
                            if (!attendanceSnapshot.empty) {
                                section.lastAttendance = {
                                    presentCount: 0,
                                    totalStudents: 0
                                };

                                // Count present/absent for the last session
                                const sessionId = attendanceSnapshot.docs[0].data().sessionId;
                                return firebase.firestore().collection('attendance')
                                    .where('sessionId', '==', sessionId)
                                    .get()
                                    .then(sessionAttendance => {
                                        section.lastAttendance.totalStudents = sessionAttendance.size;
                                        section.lastAttendance.presentCount = Array.from(sessionAttendance.docs).filter(
                                            d => d.data().status === 'present'
                                        ).length;
                                    });
                            }
                        })
                    );

                    // Get student count for each section
                    sectionPromises.push(
                        firebase.firestore().collection('enrollments')
                        .where('sectionId', '==', doc.id)
                        .get()
                        .then(enrollments => {
                            section.studentCount = enrollments.size;
                        })
                    );
                });

                await Promise.all(sectionPromises);

                // Check for active sessions
                await checkActiveSessions();

                // Update UI
                if (APP_STATE.currentView === 'teacher-dashboard') {
                    renderTeacherDashboard();
                } else if (APP_STATE.currentView === 'sections') {
                    renderSectionsView();
                }

                DOM.hideLoading();
            } catch (error) {
                DOM.hideLoading();
                showError("Failed to load sections.", error);
            }
        }

        // Start Attendance Session
        async function startAttendanceSession(sectionId) {
            DOM.showLoading("Preparing session...");

            try {
                // Get current location
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });

                const location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };

                // Get section details for check-in range
                const section = APP_STATE.sections.find(s => s.id === sectionId);
                const range = section?.checkinRange || CONFIG.defaultLocationRange;

                // Start session in Firestore
                const sessionData = {
                    sectionId: sectionId,
                    teacherId: APP_STATE.currentUser.uid,
                    startTime: firebase.firestore.FieldValue.serverTimestamp(),
                    location: new firebase.firestore.GeoPoint(location.lat, location.lng),
                    range: range,
                    status: 'active'
                };

                const docRef = await firebase.firestore().collection('sessions').add(sessionData);

                // Update section with active session
                await firebase.firestore().collection('sections').doc(sectionId).update({
                    activeSession: docRef.id,
                    lastSessionStart: sessionData.startTime
                });

                // Success
                DOM.hideLoading();
                await loadTeacherSections();
                showInfo("Attendance session started successfully!");
            } catch (error) {
                DOM.hideLoading();

                if (error.code === error.PERMISSION_DENIED) {
                    showError("Location access is required to start a session. Please enable location services.");
                } else {
                    showError("Failed to start session.", error);
                }
            }
        }

        // Check for Active Sessions (teacher)
        async function checkActiveSessions() {
            const now = new Date();
            const checkPromises = [];

            APP_STATE.sections.forEach(section => {
                if (section.activeSession) {
                    checkPromises.push(
                        firebase.firestore().collection('sessions').doc(section.activeSession).get()
                        .then((doc) => {
                            if (doc.exists) {
                                const session = doc.data();
                                const startTime = session.startTime.toDate();
                                const elapsedHours = (now - startTime) / (1000 * 60 * 60);

                                if (elapsedHours > CONFIG.sessionTimeout || session.status === 'ended') {
                                    // Session expired or ended
                                    return firebase.firestore().collection('sections').doc(section.id).update({
                                        activeSession: null
                                    });
                                }
                            } else {
                                // Session document doesn't exist
                                return firebase.firestore().collection('sections').doc(section.id).update({
                                    activeSession: null
                                });
                            }
                        })
                    );
                }
            });

            try {
                await Promise.all(checkPromises);

                // Refresh data if any sessions were ended
                if (checkPromises.length > 0) {
                    await loadTeacherSections();
                }
            } catch (error) {
                console.error("Error checking active sessions:", error);
            }
        }

        // Render Sections View
        function renderSectionsView() {
            DOM.clearAppContainer();

            // Header
            const header = document.createElement('header');
            header.className = 'app-header';
            header.innerHTML = `
        <button class="drawer-button" id="drawer-button"><i class="fas fa-bars"></i></button>
        <div class="logo">${CONFIG.appName}</div>
        <button class="create-section-button" id="create-section-button"><i class="fas fa-plus"></i> Create Section</button>
    `;

            // Main Content
            const main = document.createElement('main');
            main.className = 'dashboard-main';

            // Page Title
            const pageTitle = document.createElement('div');
            pageTitle.className = 'page-title';
            pageTitle.innerHTML = '<h2>My Sections</h2>';

            // Sections Grid
            const sectionsGrid = document.createElement('div');
            sectionsGrid.className = 'sections-grid';
            sectionsGrid.id = 'sections-grid';

            // Loading skeleton or sections
            if (APP_STATE.sections.length === 0) {
                sectionsGrid.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-layer-group"></i></div>
                <h3>No Sections Yet</h3>
                <p>Create your first section to start taking attendance</p>
                <button class="primary-button" id="create-first-section">Create Section</button>
            </div>
        `;
            } else {
                APP_STATE.sections.forEach(section => {
                    const sectionCard = createSectionCard(section);
                    sectionsGrid.appendChild(sectionCard);
                });
            }

            // Drawer (same as dashboard)
            const drawer = document.createElement('div');
            drawer.className = 'app-drawer';
            drawer.id = 'app-drawer';
            drawer.innerHTML = `
        <div class="drawer-header">
            <div class="user-info">
                <div class="user-avatar">${getInitials(APP_STATE.currentUser.displayName)}</div>
                <div class="user-details">
                    <div class="user-name">${APP_STATE.currentUser.displayName}</div>
                    <div class="user-role">Teacher</div>
                </div>
            </div>
        </div>
        <nav class="drawer-nav">
            <ul>
                <li class="${APP_STATE.currentView === 'teacher-dashboard' ? 'active' : ''}"><a href="#" data-view="teacher-dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="${APP_STATE.currentView === 'sections' ? 'active' : ''}"><a href="#" data-view="sections"><i class="fas fa-layer-group"></i> My Sections</a></li>
                <li class="${APP_STATE.currentView === 'students' ? 'active' : ''}"><a href="#" data-view="students"><i class="fas fa-users"></i> My Students</a></li>
                <li class="${APP_STATE.currentView === 'reports' ? 'active' : ''}"><a href="#" data-view="reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li class="${APP_STATE.currentView === 'settings' ? 'active' : ''}"><a href="#" data-view="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>
        <div class="drawer-footer">
            <a href="#" id="signout-button"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
        </div>
    `;

            main.appendChild(pageTitle);
            main.appendChild(sectionsGrid);

            DOM.appContainer.appendChild(header);
            DOM.appContainer.appendChild(drawer);
            DOM.appContainer.appendChild(main);

            // Add event listeners
            document.getElementById('drawer-button').addEventListener('click', toggleDrawer);
            document.getElementById('create-section-button').addEventListener('click', showCreateSectionForm);
            document.getElementById('signout-button').addEventListener('click', handleSignOut);

            if (document.getElementById('create-first-section')) {
                document.getElementById('create-first-section').addEventListener('click', showCreateSectionForm);
            }

            // Drawer navigation
            document.querySelectorAll('.drawer-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.target.getAttribute('data-view');
                    navigateToView(view);
                });
            });
        }

        // Show Create Section Form (for teachers)
        function showCreateSectionForm() {
            const modalContent = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Section</h3>
                <button class="close-button"><i class="fas fa-times"></i></button>
            </div>
            <form id="create-section-form">
                <div class="form-group">
                    <label for="section-name">Section Name</label>
                    <input type="text" id="section-name" required maxlength="${CONFIG.maxSectionNameLength}">
                    <div class="char-counter"><span id="section-name-counter">0</span>/${CONFIG.maxSectionNameLength}</div>
                </div>
                <div class="form-group">
                    <label for="section-subject">Subject</label>
                    <input type="text" id="section-subject" required maxlength="${CONFIG.maxSubjectLength}">
                    <div class="char-counter"><span id="section-subject-counter">0</span>/${CONFIG.maxSubjectLength}</div>
                </div>
                <div class="form-group">
                    <label>Schedule</label>
                    <div class="schedule-selector" id="schedule-selector">
                        <button type="button" class="day-button" data-day="monday">Mon</button>
                        <button type="button" class="day-button" data-day="tuesday">Tue</button>
                        <button type="button" class="day-button" data-day="wednesday">Wed</button>
                        <button type="button" class="day-button" data-day="thursday">Thu</button>
                        <button type="button" class="day-button" data-day="friday">Fri</button>
                        <button type="button" class="day-button" data-day="saturday">Sat</button>
                        <button type="button" class="day-button" data-day="sunday">Sun</button>
                    </div>
                    <div class="time-inputs" id="time-inputs">
                        <!-- Will be populated with selected days -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="checkin-range">Check-in Range (meters)</label>
                    <input type="range" id="checkin-range" min="${CONFIG.minLocationRange}" max="${CONFIG.maxLocationRange}" value="${CONFIG.defaultLocationRange}" step="5">
                    <div class="range-value"><span id="range-value">${CONFIG.defaultLocationRange}</span>m</div>
                    <div class="range-info">Minimum: ${CONFIG.minLocationRange}m, Maximum: ${CONFIG.maxLocationRange}m</div>
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary-button" id="cancel-section">Cancel</button>
                    <button type="submit" class="primary-button">Create Section</button>
                </div>
            </form>
        </div>
    `;

            DOM.showModal(modalContent);

            // Add event listeners
            document.querySelector('.close-button').addEventListener('click', () => DOM.hideModal());
            document.getElementById('cancel-section').addEventListener('click', () => DOM.hideModal());

            // Character counters
            document.getElementById('section-name').addEventListener('input', (e) => {
                document.getElementById('section-name-counter').textContent = e.target.value.length;
            });

            document.getElementById('section-subject').addEventListener('input', (e) => {
                document.getElementById('section-subject-counter').textContent = e.target.value.length;
            });

            // Range slider
            const rangeSlider = document.getElementById('checkin-range');
            const rangeValue = document.getElementById('range-value');
            rangeSlider.addEventListener('input', (e) => {
                rangeValue.textContent = e.target.value;
            });

            // Day selection
            const selectedDays = {};
            document.querySelectorAll('.day-button').forEach(button => {
                button.addEventListener('click', () => {
                    const day = button.dataset.day;
                    if (selectedDays[day]) {
                        button.classList.remove('selected');
                        delete selectedDays[day];
                        updateTimeInputs(document.getElementById('time-inputs'), selectedDays);
                    } else {
                        button.classList.add('selected');
                        selectedDays[day] = {
                            start: '09:00',
                            end: '10:00'
                        };
                        updateTimeInputs(document.getElementById('time-inputs'), selectedDays);
                    }
                });
            });

            // Form submission
            document.getElementById('create-section-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                if (Object.keys(selectedDays).length === 0) {
                    showError("Please select at least one day for the schedule.");
                    return;
                }

                const sectionName = document.getElementById('section-name').value.trim();
                const subject = document.getElementById('section-subject').value.trim();
                const checkinRange = parseInt(document.getElementById('checkin-range').value);

                // Validate inputs
                if (!sectionName || !subject) {
                    showError("Please fill in all required fields.");
                    return;
                }

                if (checkinRange < CONFIG.minLocationRange || checkinRange > CONFIG.maxLocationRange) {
                    showError(`Check-in range must be between ${CONFIG.minLocationRange}m and ${CONFIG.maxLocationRange}m.`);
                    return;
                }

                // Format schedule
                const schedule = {};
                for (const day in selectedDays) {
                    schedule[day] = selectedDays[day];
                }

                DOM.showLoading("Creating section...");

                try {
                    // Create section
                    await firebase.firestore().collection('sections').add({
                        name: sectionName,
                        subject: subject,
                        teacherId: APP_STATE.currentUser.uid,
                        teacherName: APP_STATE.currentUser.displayName,
                        schedule: schedule,
                        checkinRange: checkinRange,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        studentCount: 0
                    });

                    DOM.hideLoading();
                    DOM.hideModal();
                    await loadTeacherSections();
                    showInfo("Section created successfully!");
                } catch (error) {
                    DOM.hideLoading();
                    showError("Failed to create section.", error);
                }
            });
        }

        // Update time inputs for selected days
        function updateTimeInputs(container, selectedDays) {
            container.innerHTML = '';

            Object.entries(selectedDays).forEach(([day, times]) => {
                const dayGroup = document.createElement('div');
                dayGroup.className = 'time-input-group';
                dayGroup.innerHTML = `
            <label>${day.charAt(0).toUpperCase() + day.slice(1)} Time</label>
            <div class="time-input-row">
                <input type="time" value="${times.start}" class="time-start" data-day="${day}">
                <span>to</span>
                <input type="time" value="${times.end}" class="time-end" data-day="${day}">
            </div>
        `;

                container.appendChild(dayGroup);

                // Add event listeners for time changes
                dayGroup.querySelector('.time-start').addEventListener('change', (e) => {
                    selectedDays[day].start = e.target.value;
                });

                dayGroup.querySelector('.time-end').addEventListener('change', (e) => {
                    selectedDays[day].end = e.target.value;
                });
            });
        }

        // Show Section Menu (for teachers)
        function showSectionMenu(e, section) {
            e.stopPropagation();

            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.top = `${e.clientY}px`;
            menu.style.left = `${e.clientX}px`;
            menu.innerHTML = `
        <ul>
            <li><button class="menu-item" data-action="view"><i class="fas fa-eye"></i> View Section</button></li>
            <li><button class="menu-item" data-action="invite"><i class="fas fa-user-plus"></i> Invite Students</button></li>
            <li><button class="menu-item" data-action="manage"><i class="fas fa-users-cog"></i> Manage Students</button></li>
            <li><button class="menu-item" data-action="edit"><i class="fas fa-edit"></i> Edit Section</button></li>
            <li><button class="menu-item" data-action="delete"><i class="fas fa-trash"></i> Delete Section</button></li>
        </ul>
    `;

            document.body.appendChild(menu);

            // Close menu when clicking elsewhere
            const closeMenu = () => {
                document.body.removeChild(menu);
                document.removeEventListener('click', closeMenu);
            };

            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 100);

            // Menu actions
            menu.querySelector('[data-action="view"]').addEventListener('click', () => {
                closeMenu();
                viewSectionDetails(section);
            });

            menu.querySelector('[data-action="invite"]').addEventListener('click', () => {
                closeMenu();
                showInviteStudentsModal(section);
            });

            menu.querySelector('[data-action="manage"]').addEventListener('click', () => {
                closeMenu();
                showManageStudentsModal(section);
            });

            menu.querySelector('[data-action="edit"]').addEventListener('click', () => {
                closeMenu();
                showEditSectionModal(section);
            });

            menu.querySelector('[data-action="delete"]').addEventListener('click', () => {
                closeMenu();
                showDeleteSectionModal(section);
            });
        }

        // View Section Details
        function viewSectionDetails(section) {
            APP_STATE.selectedSection = section;
            navigateToView('section-details');
        }

        // Render Section Details View
        function renderSectionDetailsView() {
            if (!APP_STATE.selectedSection) {
                navigateToView('sections');
                return;
            }

            const section = APP_STATE.selectedSection;
            DOM.clearAppContainer();

            // Header
            const header = document.createElement('header');
            header.className = 'app-header';
            header.innerHTML = `
        <button class="drawer-button" id="drawer-button"><i class="fas fa-bars"></i></button>
        <div class="logo">${CONFIG.appName}</div>
        <button class="back-button" id="back-button"><i class="fas fa-arrow-left"></i> Back</button>
    `;

            // Main Content
            const main = document.createElement('main');
            main.className = 'dashboard-main';

            // Section Header
            const sectionHeader = document.createElement('div');
            sectionHeader.className = 'section-details-header';
            sectionHeader.innerHTML = `
        <div class="section-info">
            <h2>${section.name}</h2>
            <p class="section-subject">${section.subject}</p>
            <p class="section-id">Section ID: ${section.id}</p>
        </div>
        <div class="section-actions">
            <button class="primary-button" id="start-session-btn" ${section.activeSession ? 'disabled' : ''}>
                ${section.activeSession ? 'Session Active' : 'Start Attendance'}
            </button>
        </div>
    `;

            // Section Stats
            const sectionStats = document.createElement('div');
            sectionStats.className = 'section-stats-grid';

            // Student Count
            const studentStat = document.createElement('div');
            studentStat.className = 'stat-card';
            studentStat.innerHTML = `
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <div class="stat-value">${section.studentCount || 0}</div>
        <div class="stat-label">Students</div>
    `;

            // Attendance Rate
            const attendanceStat = document.createElement('div');
            attendanceStat.className = 'stat-card';
            const lastAttendance = section.lastAttendance || {};
            const presentCount = lastAttendance.presentCount || 0;
            const totalStudents = lastAttendance.totalStudents || 0;
            const attendancePercent = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;
            attendanceStat.innerHTML = `
        <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
        <div class="stat-value">${attendancePercent}%</div>
        <div class="stat-label">Attendance</div>
    `;

            // Sessions Count
            const sessionsStat = document.createElement('div');
            sessionsStat.className = 'stat-card';
            sessionsStat.innerHTML = `
        <div class="stat-icon"><i class="fas fa-chalkboard"></i></div>
        <div class="stat-value">${section.sessionCount || 0}</div>
        <div class="stat-label">Sessions</div>
    `;

            sectionStats.appendChild(studentStat);
            sectionStats.appendChild(attendanceStat);
            sectionStats.appendChild(sessionsStat);

            // Schedule
            const scheduleSection = document.createElement('div');
            scheduleSection.className = 'section-schedule-card';
            scheduleSection.innerHTML = `
        <h3><i class="fas fa-calendar-alt"></i> Schedule</h3>
        <div class="schedule-days" id="schedule-days">
            ${Object.entries(section.schedule || {}).map(([day, times]) => ` <
                div class = "schedule-day" >
                <
                span class = "day-name" > $ {
                    day.charAt(0).toUpperCase() + day.slice(1)
                } < /span> <
                span class = "day-time" > $ {
                    times.start
                } - $ {
                    times.end
                } < /span> <
                /div>
            `).join('')}
        </div>
    `;

            // Recent Sessions
            const sessionsSection = document.createElement('div');
            sessionsSection.className = 'section-sessions-card';
            sessionsSection.innerHTML = `
        <div class="sessions-header">
            <h3><i class="fas fa-history"></i> Recent Sessions</h3>
            <a href="#" id="view-all-sessions">View All</a>
        </div>
        <div class="sessions-list" id="sessions-list">
            <div class="session-item skeleton"></div>
            <div class="session-item skeleton"></div>
        </div>
    `;

            main.appendChild(sectionHeader);
            main.appendChild(sectionStats);
            main.appendChild(scheduleSection);
            main.appendChild(sessionsSection);

            // Drawer
            const drawer = document.createElement('div');
            drawer.className = 'app-drawer';
            drawer.id = 'app-drawer';
            drawer.innerHTML = `
        <div class="drawer-header">
            <div class="user-info">
                <div class="user-avatar">${getInitials(APP_STATE.currentUser.displayName)}</div>
                <div class="user-details">
                    <div class="user-name">${APP_STATE.currentUser.displayName}</div>
                    <div class="user-role">Teacher</div>
                </div>
            </div>
        </div>
        <nav class="drawer-nav">
            <ul>
                <li class="${APP_STATE.currentView === 'teacher-dashboard' ? 'active' : ''}"><a href="#" data-view="teacher-dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="${APP_STATE.currentView === 'sections' ? 'active' : ''}"><a href="#" data-view="sections"><i class="fas fa-layer-group"></i> My Sections</a></li>
                <li class="${APP_STATE.currentView === 'students' ? 'active' : ''}"><a href="#" data-view="students"><i class="fas fa-users"></i> My Students</a></li>
                <li class="${APP_STATE.currentView === 'reports' ? 'active' : ''}"><a href="#" data-view="reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li class="${APP_STATE.currentView === 'settings' ? 'active' : ''}"><a href="#" data-view="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>
        <div class="drawer-footer">
            <a href="#" id="signout-button"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
        </div>
    `;

            DOM.appContainer.appendChild(header);
            DOM.appContainer.appendChild(drawer);
            DOM.appContainer.appendChild(main);

            // Load recent sessions
            loadRecentSessions(section.id);

            // Add event listeners
            document.getElementById('drawer-button').addEventListener('click', toggleDrawer);
            document.getElementById('back-button').addEventListener('click', () => navigateToView('sections'));
            document.getElementById('signout-button').addEventListener('click', handleSignOut);
            document.getElementById('start-session-btn').addEventListener('click', () => startAttendanceSession(section.id));
            document.getElementById('view-all-sessions').addEventListener('click', (e) => {
                e.preventDefault();
                navigateToView('section-sessions');
            });

            // Drawer navigation
            document.querySelectorAll('.drawer-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.target.getAttribute('data-view');
                    navigateToView(view);
                });
            });
        }

        // Load recent sessions for a section
        async function loadRecentSessions(sectionId) {
            const sessionsList = document.getElementById('sessions-list');
            if (!sessionsList) return;

            try {
                const querySnapshot = await firebase.firestore().collection('sessions')
                    .where('sectionId', '==', sectionId)
                    .orderBy('startTime', 'desc')
                    .limit(5)
                    .get();

                sessionsList.innerHTML = '';

                if (querySnapshot.empty) {
                    sessionsList.innerHTML = '<div class="empty-sessions">No sessions yet</div>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const session = doc.data();
                    const sessionItem = document.createElement('div');
                    sessionItem.className = 'session-item';

                    const date = session.startTime.toDate();
                    const attendanceCount = session.attendanceCount || 0;
                    const studentCount = session.studentCount || 0;
                    const attendancePercent = studentCount > 0 ? Math.round((attendanceCount / studentCount) * 100) : 0;

                    sessionItem.innerHTML = `
                <div class="session-date">${formatDate(date)}</div>
                <div class="session-time">${formatTime(date)}</div>
                <div class="session-attendance">
                    <div class="attendance-bar" style="width: ${attendancePercent}%"></div>
                    <span>${attendancePercent}%</span>
                </div>
                <button class="session-details-button"><i class="fas fa-chevron-right"></i></button>
            `;

                    sessionItem.addEventListener('click', () => {
                        viewSessionDetails(doc.id);
                    });

                    sessionsList.appendChild(sessionItem);
                });
            } catch (error) {
                sessionsList.innerHTML = '<div class="empty-sessions">Failed to load sessions</div>';
                console.error("Error loading sessions:", error);
            }
        }

        // View Session Details
        async function viewSessionDetails(sessionId) {
            DOM.showLoading("Loading session details...");

            try {
                const doc = await firebase.firestore().collection('sessions').doc(sessionId).get();
                if (!doc.exists) {
                    throw new Error("Session not found");
                }

                const session = doc.data();
                APP_STATE.selectedSession = session;

                // Get attendance records for this session
                const querySnapshot = await firebase.firestore().collection('attendance')
                    .where('sessionId', '==', sessionId)
                    .get();

                DOM.hideLoading();

                const attendanceRecords = [];
                querySnapshot.forEach(doc => {
                    attendanceRecords.push(doc.data());
                });

                APP_STATE.selectedSession.attendance = attendanceRecords;
                showSessionDetailsModal();
            } catch (error) {
                DOM.hideLoading();
                showError("Failed to load session details.", error);
            }
        }

        // Show Session Details Modal
        function showSessionDetailsModal() {
            const session = APP_STATE.selectedSession;
            if (!session) return;

            const startTime = session.startTime.toDate();
            const presentCount = session.attendance.filter(a => a.status === 'present').length;
            const absentCount = session.attendance.filter(a => a.status === 'absent').length;
            const attendancePercent = session.attendance.length > 0 ?
                Math.round((presentCount / session.attendance.length) * 100) : 0;

            const modalContent = `
        <div class="modal-content wide-modal">
            <div class="modal-header">
                <h3>Session Details</h3>
                <button class="close-button"><i class="fas fa-times"></i></button>
            </div>
            <div class="session-summary">
                <div class="summary-card">
                    <div class="summary-value">${formatDate(startTime)}</div>
                    <div class="summary-label">Date</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${formatTime(startTime)}</div>
                    <div class="summary-label">Time</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${presentCount}</div>
                    <div class="summary-label">Present</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${absentCount}</div>
                    <div class="summary-label">Absent</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${attendancePercent}%</div>
                    <div class="summary-label">Attendance</div>
                </div>
            </div>
            <div class="attendance-list-container">
                <div class="attendance-list-header">
                    <div class="attendance-student">Student</div>
                    <div class="attendance-status">Status</div>
                    <div class="attendance-distance">Distance</div>
                    <div class="attendance-time">Time</div>
                </div>
                <div class="attendance-list" id="attendance-list">
                    ${session.attendance.map(record => {
                        const time = record.checkInTime.toDate();
                        return `
                        <div class="attendance-item">
                            <div class="attendance-student">
                                <div class="student-avatar">${getInitials(record.studentName)}</div>
                                <div class="student-name">${record.studentName}</div>
                            </div>
                            <div class="attendance-status">
                                <span class="status-badge ${record.status}">${record.status}</span>
                            </div>
                            <div class="attendance-distance">
                                ${record.distance ? `${Math.round(record.distance)}m` : 'N/A'}
                            </div>
                            <div class="attendance-time">
                                ${formatTime(time)}
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;

            DOM.showModal(modalContent);

            // Add event listeners
            document.querySelector('.close-button').addEventListener('click', () => DOM.hideModal());
        }

        // Show Invite Students Modal
        function showInviteStudentsModal(section) {
            const inviteUrl = `${window.location.origin}${window.location.pathname}?sectionid=${section.id}`;

            const modalContent = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Invite Students</h3>
                <button class="close-button"><i class="fas fa-times"></i></button>
            </div>
            <div class="invite-content">
                <div class="invite-methods">
                    <div class="invite-method">
                        <h4>Share Link</h4>
                        <div class="invite-url">
                            <input type="text" value="${inviteUrl}" id="invite-url" readonly>
                            <button class="copy-button" id="copy-invite"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                    <div class="invite-method">
                        <h4>QR Code</h4>
                        <div class="qr-code-container" id="qr-code-container">
                            <div class="qr-placeholder">Generating QR Code...</div>
                        </div>
                    </div>
                </div>
                <div class="invite-footer">
                    <p>Students will need this code to join: <strong>${section.id}</strong></p>
                </div>
            </div>
        </div>
    `;

            DOM.showModal(modalContent);

            // Add event listeners
            document.querySelector('.close-button').addEventListener('click', () => DOM.hideModal());
            document.getElementById('copy-invite').addEventListener('click', () => {
                copyToClipboard(inviteUrl);
                showInfo("Invite link copied to clipboard!");
            });

            // Generate QR code dynamically
            generateQRCode(document.getElementById('qr-code-container'), inviteUrl);
        }

        // Show Manage Students Modal
        async function showManageStudentsModal(section) {
            DOM.showLoading("Loading students...");

            try {
                // Get enrollments and student data
                const enrollmentsQuery = await firebase.firestore().collection('enrollments')
                    .where('sectionId', '==', section.id)
                    .get();

                const enrollments = [];
                const studentPromises = [];

                enrollmentsQuery.forEach((doc) => {
                    const enrollment = {
                        id: doc.id,
                        ...doc.data()
                    };
                    enrollments.push(enrollment);

                    studentPromises.push(
                        firebase.firestore().collection('users').doc(enrollment.studentId).get()
                        .then((studentDoc) => {
                            if (studentDoc.exists) {
                                enrollment.studentData = studentDoc.data();
                            }
                            return enrollment;
                        })
                    );
                });

                await Promise.all(studentPromises);
                DOM.hideLoading();

                const modalContent = `
            <div class="modal-content wide-modal">
                <div class="modal-header">
                    <h3>Manage Students - ${section.name}</h3>
                    <button class="close-button"><i class="fas fa-times"></i></button>
                </div>
                <div class="student-list-container">
                    <div class="student-list-header">
                        <div class="student-name">Student Name</div>
                        <div class="student-status">Status</div>
                        <div class="student-actions">Actions</div>
                    </div>
                    <div class="student-list" id="student-list">
                        ${enrollments.map(enrollment => `
                            <div class="student-item">
                                <div class="student-name">
                                    <div class="student-avatar">${getInitials(enrollment.studentData.displayName)}</div>
                                    <div class="student-details">
                                        <div class="student-display-name">${enrollment.studentData.displayName}</div>
                                        <div class="student-username">${enrollment.studentData.username}</div>
                                    </div>
                                </div>
                                <div class="student-status">
                                    <span class="status-badge ${enrollment.status}">${enrollment.status}</span>
                                </div>
                                <div class="student-actions">
                                    <button class="action-button view-button" data-action="view" data-student-id="${enrollment.studentId}"><i class="fas fa-eye"></i></button>
                                    <button class="action-button remove-button" data-action="remove" data-enrollment-id="${enrollment.id}" data-student-name="${enrollment.studentData.displayName}"><i class="fas fa-user-minus"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="primary-button" id="add-student-button"><i class="fas fa-user-plus"></i> Add Student</button>
                </div>
            </div>
        `;

                DOM.showModal(modalContent);

                // Add event listeners
                document.querySelector('.close-button').addEventListener('click', () => DOM.hideModal());

                document.querySelectorAll('[data-action="view"]').forEach(button => {
                    button.addEventListener('click', () => {
                        const studentId = button.dataset.studentId;
                        viewStudentAttendance(studentId, section.id);
                    });
                });

                document.querySelectorAll('[data-action="remove"]').forEach(button => {
                    button.addEventListener('click', () => {
                        const enrollmentId = button.dataset.enrollmentId;
                        const studentName = button.dataset.studentName;

                        showConfirmation(
                            "Remove Student",
                            `Are you sure you want to remove ${studentName} from this section?`,
                            "Remove",
                            "Cancel",
                            async () => {
                                DOM.showLoading("Removing student...");

                                try {
                                    await firebase.firestore().collection('enrollments').doc(enrollmentId).delete();
                                    DOM.hideLoading();
                                    showInfo("Student removed successfully.");
                                    showManageStudentsModal(section);
                                } catch (error) {
                                    DOM.hideLoading();
                                    showError("Failed to remove student.", error);
                                }
                            }
                        );
                    });
                });

                document.getElementById('add-student-button').addEventListener('click', () => {
                    showAddStudentModal(section);
                });
            } catch (error) {
                DOM.hideLoading();
                showError("Failed to load students.", error);
            }
        }

        // Show Add Student Modal
        function showAddStudentModal(section) {
            const modalContent = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Student to ${section.name}</h3>
                <button class="close-button"><i class="fas fa-times"></i></button>
            </div>
            <form id="add-student-form">
                <div class="form-group">
                    <label for="student-email">Student Email</label>
                    <input type="email" id="student-email" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary-button" id="cancel-add-student">Cancel</button>
                    <button type="submit" class="primary-button">Add Student</button>
                </div>
            </form>
        </div>
    `;

            DOM.showModal(modalContent);

            // Add event listeners
            document.querySelector('.close-button').addEventListener('click', () => DOM.hideModal());
            document.getElementById('cancel-add-student').addEventListener('click', () => DOM.hideModal());

            // Form submission
            document.getElementById('add-student-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const studentEmail = document.getElementById('student-email').value.trim();

                DOM.showLoading("Adding student...");

                try {
                    // First find the user by email
                    const querySnapshot = await firebase.firestore().collection('users')
                        .where('email', '==', studentEmail)
                        .where('role', '==', 'student')
                        .get();

                    if (querySnapshot.empty) {
                        throw new Error("No student found with that email.");
                    }

                    const studentDoc = querySnapshot.docs[0];
                    const studentId = studentDoc.id;

                    // Check if already enrolled
                    const enrollmentSnapshot = await firebase.firestore().collection('enrollments')
                        .where('sectionId', '==', section.id)
                        .where('studentId', '==', studentId)
                        .get();

                    if (!enrollmentSnapshot.empty) {
                        throw new Error("Student is already enrolled in this section.");
                    }

                    // Create enrollment
                    await firebase.firestore().collection('enrollments').add({
                        sectionId: section.id,
                        studentId: studentId,
                        enrolledAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'active'
                    });

                    DOM.hideLoading();
                    showInfo("Student added successfully!");
                    showManageStudentsModal(section);
                } catch (error) {
                    DOM.hideLoading();
                    showError(error.message, error);
                }
            });
        }

        // View Student Attendance
        async function viewStudentAttendance(studentId, sectionId) {
            DOM.showLoading("Loading attendance records...");

            try {
                const [studentDoc, attendanceSnapshot] = await Promise.all([
                    firebase.firestore().collection('users').doc(studentId).get(),
                    firebase.firestore().collection('attendance')
                    .where('sectionId', '==', sectionId)
                    .where('studentId', '==', studentId)
                    .orderBy('checkInTime', 'desc')
                    .get()
                ]);

                if (!studentDoc.exists) {
                    throw new Error("Student not found");
                }

                const student = studentDoc.data();
                const attendanceRecords = [];

                attendanceSnapshot.forEach(doc => {
                    attendanceRecords.push(doc.data());
                });

                // Calculate stats
                const totalRecords = attendanceRecords.length;
                const presentCount = attendanceRecords.filter(r => r.status === 'present').length;
                const absentCount = attendanceRecords.filter(r => r.status === 'absent').length;
                const attendancePercentage = totalRecords > 0 ? Math.round((presentCount / totalRecords) * 100) : 0;

                DOM.hideLoading();

                const modalContent = `
            <div class="modal-content wide-modal">
                <div class="modal-header">
                    <h3>${student.displayName}'s Attendance</h3>
                    <button class="close-button"><i class="fas fa-times"></i></button>
                </div>
                <div class="attendance-summary">
                    <div class="summary-card">
                        <div class="summary-value">${totalRecords}</div>
                        <div class="summary-label">Total Sessions</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${presentCount}</div>
                        <div class="summary-label">Present</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${absentCount}</div>
                        <div class="summary-label">Absent</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${attendancePercentage}%</div>
                        <div class="summary-label">Attendance</div>
                    </div>
                </div>
                <div class="attendance-list-container">
                    <div class="attendance-list-header">
                        <div class="attendance-date">Date</div>
                        <div class="attendance-status">Status</div>
                        <div class="attendance-distance">Distance</div>
                        <div class="attendance-actions">Actions</div>
                    </div>
                    <div class="attendance-list" id="attendance-list">
                        ${attendanceRecords.map(record => {
                            const recordDate = record.checkInTime.toDate();
                            return `
                            <div class="attendance-item">
                                <div class="attendance-date">
                                    <div class="attendance-day">${formatDate(recordDate)}</div>
                                    <div class="attendance-time">${formatTime(recordDate)}</div>
                                </div>
                                <div class="attendance-status">
                                    <span class="status-badge ${record.status}">${record.status.charAt(0).toUpperCase() + record.status.slice(1)}</span>
                                </div>
                                <div class="attendance-distance">
                                    ${record.distance ? `${Math.round(record.distance)}m` : 'N/A'}
                                </div>
                                <div class="attendance-actions">
                                    <button class="action-button edit-button" data-action="edit" data-record-id="${record.id}"><i class="fas fa-edit"></i></button>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;

                DOM.showModal(modalContent);

                // Add event listeners
                document.querySelector('.close-button').addEventListener('click', () => DOM.hideModal());

                // Edit buttons would be implemented here
            } catch (error) {
                DOM.hideLoading();
                showError("Failed to load attendance records.", error);
            }
        }

        // Show Edit Section Modal
        function showEditSectionModal(section) {
            const modalContent = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Section</h3>
                <button class="close-button"><i class="fas fa-times"></i></button>
            </div>
            <form id="edit-section-form">
                <div class="form-group">
                    <label for="edit-section-name">Section Name</label>
                    <input type="text" id="edit-section-name" value="${section.name}" required maxlength="${CONFIG.maxSectionNameLength}">
                    <div class="char-counter"><span id="edit-section-name-counter">${section.name.length}</span>/${CONFIG.maxSectionNameLength}</div>
                </div>
                <div class="form-group">
                    <label for="edit-section-subject">Subject</label>
                    <input type="text" id="edit-section-subject" value="${section.subject || ''}" required maxlength="${CONFIG.maxSubjectLength}">
                    <div class="char-counter"><span id="edit-section-subject-counter">${section.subject?.length || 0}</span>/${CONFIG.maxSubjectLength}</div>
                </div>
                <div class="form-group">
                    <label for="edit-checkin-range">Check-in Range (meters)</label>
                    <input type="range" id="edit-checkin-range" min="${CONFIG.minLocationRange}" max="${CONFIG.maxLocationRange}" value="${section.checkinRange || CONFIG.defaultLocationRange}" step="5">
                    <div class="range-value"><span id="edit-range-value">${section.checkinRange || CONFIG.defaultLocationRange}</span>m</div>
                    <div class="range-info">Minimum: ${CONFIG.minLocationRange}m, Maximum: ${CONFIG.maxLocationRange}m</div>
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary-button" id="cancel-edit">Cancel</button>
                    <button type="submit" class="primary-button">Save Changes</button>
                </div>
            </form>
        </div>
    `;

            DOM.showModal(modalContent);

            // Add event listeners
            document.querySelector('.close-button').addEventListener('click', () => DOM.hideModal());
            document.getElementById('cancel-edit').addEventListener('click', () => DOM.hideModal());

            // Character counters
            document.getElementById('edit-section-name').addEventListener('input', (e) => {
                document.getElementById('edit-section-name-counter').textContent = e.target.value.length;
            });

            document.getElementById('edit-section-subject').addEventListener('input', (e) => {
                document.getElementById('edit-section-subject-counter').textContent = e.target.value.length;
            });

            // Range slider
            const rangeSlider = document.getElementById('edit-checkin-range');
            const rangeValue = document.getElementById('edit-range-value');
            rangeSlider.addEventListener('input', (e) => {
                rangeValue.textContent = e.target.value;
            });

            // Form submission
            document.getElementById('edit-section-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const sectionName = document.getElementById('edit-section-name').value.trim();
                const subject = document.getElementById('edit-section-subject').value.trim();
                const checkinRange = parseInt(document.getElementById('edit-checkin-range').value);

                // Validate range
                if (checkinRange < CONFIG.minLocationRange || checkinRange > CONFIG.maxLocationRange) {
                    showError(`Check-in range must be between ${CONFIG.minLocationRange}m and ${CONFIG.maxLocationRange}m.`);
                    return;
                }

                DOM.showLoading("Updating section...");

                try {
                    await firebase.firestore().collection('sections').doc(section.id).update({
                        name: sectionName,
                        subject: subject,
                        checkinRange: checkinRange
                    });

                    DOM.hideLoading();
                    DOM.hideModal();
                    await loadTeacherSections();
                    showInfo("Section updated successfully!");
                } catch (error) {
                    DOM.hideLoading();
                    showError("Failed to update section.", error);
                }
            });
        }

        // Show Delete Section Modal
        function showDeleteSectionModal(section) {
            showConfirmation(
                "Delete Section",
                `Are you sure you want to permanently delete ${section.name}? This will also remove all attendance records and cannot be undone.`,
                "Delete",
                "Cancel",
                () => {
                    // First prompt for password
                    showPasswordPrompt(
                        "Confirm Deletion",
                        "Please enter your password to confirm deletion:",
                        async (password) => {
                                DOM.showLoading("Deleting section...");

                                try {
                                    // Reauthenticate
                                    const credential = firebase.auth.EmailAuthProvider.credential(
                                        APP_STATE.currentUser.email,
                                        password
                                    );

                                    await APP_STATE.currentUser.reauthenticateWithCredential(credential);

                                    // Delete section and related data
                                    const batch = firebase.firestore().batch();
                                    const sectionRef = firebase.firestore().collection('sections').doc(section.id);

                                    batch.delete(sectionRef);

                                    // Delete enrollments
                                    const enrollmentsQuery = await firebase.firestore().collection('enrollments')
                                        .where('sectionId', '==', section.id)
                                        .get();

                                    enrollmentsQuery.forEach(doc => {
                                        batch.delete(doc.ref);
                                    });

                                    await batch.commit();

                                    DOM.hideLoading();
                                    showInfo("Section deleted successfully.");
                                    navigateToView('sections');
                                } catch (error) {
                                    DOM.hideLoading();

                                    let errorMessage = "Failed to delete section.";
                                    if (error.code === 'auth/wrong-password') {
                                        errorMessage = "Incorrect password. Please try again.";
                                    }

                                    showError(errorMessage, error);
                                }
                            },
                            () => {
                                // Cancelled
                            }
                    );
                }
            );
        }

        // Load Student Dashboard
        function loadStudentDashboard() {
            APP_STATE.currentView = 'student-dashboard';
            renderStudentDashboard();
            loadStudentSections();
        }

        // Render Student Dashboard
        function renderStudentDashboard() {
            DOM.clearAppContainer();

            // Header
            const header = document.createElement('header');
            header.className = 'app-header';
            header.innerHTML = `
        <button class="drawer-button" id="drawer-button"><i class="fas fa-bars"></i></button>
        <div class="logo">${CONFIG.appName}</div>
        <button class="enroll-button" id="enroll-button"><i class="fas fa-plus"></i> Enroll</button>
    `;

            // Main Content
            const main = document.createElement('main');
            main.className = 'dashboard-main';

            // Greeting
            const greeting = document.createElement('div');
            greeting.className = 'greeting';
            const now = new Date();
            const hour = now.getHours();
            let timeOfDay = 'day';
            if (hour < 12) timeOfDay = 'morning';
            else if (hour < 18) timeOfDay = 'afternoon';
            else timeOfDay = 'evening';

            const firstName = APP_STATE.currentUser.displayName.split(' ')[0];
            greeting.innerHTML = `<h2>Good ${timeOfDay}, ${firstName}</h2>`;

            // Dashboard Cards
            const dashboardCards = document.createElement('div');
            dashboardCards.className = 'dashboard-cards';

            // Active Sessions Card
            const activeSessionsCard = document.createElement('div');
            activeSessionsCard.className = 'dashboard-card';
            const activeSessionsCount = APP_STATE.enrolledSections.filter(s => s.activeSession).length;
            activeSessionsCard.innerHTML = `
        <div class="card-icon"><i class="fas fa-chalkboard"></i></div>
        <div class="card-content">
            <div class="card-value">${activeSessionsCount}</div>
            <div class="card-label">Active Classes</div>
        </div>
    `;
            activeSessionsCard.addEventListener('click', () => navigateToView('attendance'));

            // Sections Card
            const sectionsCard = document.createElement('div');
            sectionsCard.className = 'dashboard-card';
            sectionsCard.innerHTML = `
        <div class="card-icon"><i class="fas fa-layer-group"></i></div>
        <div class="card-content">
            <div class="card-value">${APP_STATE.enrolledSections.length}</div>
            <div class="card-label">Classes</div>
        </div>
    `;
            sectionsCard.addEventListener('click', () => navigateToView('sections'));

            // Attendance Rate Card
            const attendanceCard = document.createElement('div');
            attendanceCard.className = 'dashboard-card';
            attendanceCard.innerHTML = `
        <div class="card-icon"><i class="fas fa-calendar-check"></i></div>
        <div class="card-content">
            <div class="card-value">${calculateStudentAttendance()}%</div>
            <div class="card-label">Attendance</div>
        </div>
    `;
            attendanceCard.addEventListener('click', () => navigateToView('attendance'));

            dashboardCards.appendChild(activeSessionsCard);
            dashboardCards.appendChild(sectionsCard);
            dashboardCards.appendChild(attendanceCard);

            // Recent Check-ins
            const recentCheckins = document.createElement('div');
            recentCheckins.className = 'recent-checkins';
            recentCheckins.innerHTML = `
        <h3>Recent Check-ins</h3>
        <div class="checkin-list" id="checkin-list">
            <div class="checkin-item skeleton"></div>
            <div class="checkin-item skeleton"></div>
            <div class="checkin-item skeleton"></div>
        </div>
    `;

            // Sections Carousel
            const sectionsTitle = document.createElement('div');
            sectionsTitle.className = 'section-title';
            sectionsTitle.innerHTML = `
        <h3>Your Classes</h3>
        <a href="#" id="view-all-classes">View All</a>
    `;

            const carousel = document.createElement('div');
            carousel.className = 'sections-carousel';
            carousel.id = 'sections-carousel';

            // Loading skeleton or sections
            if (APP_STATE.enrolledSections.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
            <div class="empty-icon"><i class="fas fa-book-open"></i></div>
            <h3>No Enrolled Classes</h3>
            <p>You haven't enrolled in any classes yet. Use the button above to join a class.</p>
            <button class="primary-button" id="enroll-empty-button">Enroll Now</button>
        `;
                carousel.appendChild(emptyState);
            } else {
                // Only show 3 most recent sections in the carousel
                const recentSections = APP_STATE.enrolledSections.slice(0, 3);
                recentSections.forEach(section => {
                    const sectionCard = createStudentSectionCard(section);
                    carousel.appendChild(sectionCard);
                });
            }

            // Drawer
            const drawer = document.createElement('div');
            drawer.className = 'app-drawer';
            drawer.id = 'app-drawer';
            drawer.innerHTML = `
        <div class="drawer-header">
            <div class="user-info">
                <div class="user-avatar">${getInitials(APP_STATE.currentUser.displayName)}</div>
                <div class="user-details">
                    <div class="user-name">${APP_STATE.currentUser.displayName}</div>
                    <div class="user-role">Student</div>
                </div>
            </div>
        </div>
        <nav class="drawer-nav">
            <ul>
                <li class="${APP_STATE.currentView === 'student-dashboard' ? 'active' : ''}"><a href="#" data-view="student-dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="${APP_STATE.currentView === 'sections' ? 'active' : ''}"><a href="#" data-view="sections"><i class="fas fa-layer-group"></i> My Classes</a></li>
                <li class="${APP_STATE.currentView === 'attendance' ? 'active' : ''}"><a href="#" data-view="attendance"><i class="fas fa-calendar-check"></i> My Attendance</a></li>
                <li class="${APP_STATE.currentView === 'settings' ? 'active' : ''}"><a href="#" data-view="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>
        <div class="drawer-footer">
            <a href="#" id="signout-button"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
        </div>
    `;

            main.appendChild(greeting);
            main.appendChild(dashboardCards);
            main.appendChild(recentCheckins);
            main.appendChild(sectionsTitle);
            main.appendChild(carousel);

            DOM.appContainer.appendChild(header);
            DOM.appContainer.appendChild(drawer);
            DOM.appContainer.appendChild(main);

            // Load recent check-ins
            loadRecentCheckins();

            // Add event listeners
            setupStudentDashboardEventListeners();
        }

        // Calculate student attendance rate
        function calculateStudentAttendance() {
            if (APP_STATE.attendanceRecords.length === 0) return 0;

            const presentCount = APP_STATE.attendanceRecords.filter(r => r.status === 'present').length;
            return Math.round((presentCount / APP_STATE.attendanceRecords.length) * 100);
        }

        // Load recent check-ins
        async function loadRecentCheckins() {
            const checkinList = document.getElementById('checkin-list');
            if (!checkinList) return;

            try {
                // Get recent attendance records
                const querySnapshot = await firebase.firestore().collection('attendance')
                    .where('studentId', '==', APP_STATE.currentUser.uid)
                    .orderBy('checkInTime', 'desc')
                    .limit(3)
                    .get();

                checkinList.innerHTML = '';

                if (querySnapshot.empty) {
                    checkinList.innerHTML = '<div class="empty-checkins">No recent check-ins yet</div>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const record = doc.data();
                    const checkinItem = document.createElement('div');
                    checkinItem.className = 'checkin-item';

                    const date = record.checkInTime.toDate();
                    const section = APP_STATE.enrolledSections.find(s => s.id === record.sectionId);
                    const sectionName = section ? section.name : 'Unknown Class';

                    checkinItem.innerHTML = `
                <div class="checkin-icon">
                    <i class="fas fa-${record.status === 'present' ? 'check-circle' : 'times-circle'}"></i>
                </div>
                <div class="checkin-details">
                    <div class="checkin-title">${sectionName}</div>
                    <div class="checkin-meta">${formatDate(date)}  ${formatTime(date)}</div>
                    <div class="checkin-status ${record.status}">${record.status.charAt(0).toUpperCase() + record.status.slice(1)}</div>
                </div>
            `;

                    checkinList.appendChild(checkinItem);
                });
            } catch (error) {
                checkinList.innerHTML = '<div class="empty-checkins">Failed to load check-ins</div>';
                console.error("Error loading check-ins:", error);
            }
        }

        // Setup student dashboard event listeners
        function setupStudentDashboardEventListeners() {
            document.getElementById('drawer-button').addEventListener('click', toggleDrawer);
            document.getElementById('enroll-button').addEventListener('click', showEnrollSectionForm);
            document.getElementById('signout-button').addEventListener('click', handleSignOut);
            document.getElementById('view-all-classes').addEventListener('click', (e) => {
                e.preventDefault();
                navigateToView('sections');
            });

            if (document.getElementById('enroll-empty-button')) {
                document.getElementById('enroll-empty-button').addEventListener('click', showEnrollSectionForm);
            }

            // Drawer navigation
            document.querySelectorAll('.drawer-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.target.getAttribute('data-view');
                    navigateToView(view);
                });
            });
        }

        // Create Student Section Card
        function createStudentSectionCard(section) {
            const card = document.createElement('div');
            card.className = 'section-card';
            card.dataset.sectionId = section.id;

            // Check if there's an active session
            const hasActiveSession = section.activeSession ? true : false;
            const isInRange = section.inRange || false;

            card.innerHTML = `
        <div class="section-header">
            <h3 class="section-name">${section.name}</h3>
            <button class="section-menu-button"><i class="fas fa-ellipsis-v"></i></button>
        </div>
        <div class="section-meta">
            <span class="teacher-name"><i class="fas fa-chalkboard-teacher"></i> ${section.teacherName}</span>
            <span class="section-schedule">${formatSchedule(section.schedule)}</span>
        </div>
        <div class="session-status">
            ${hasActiveSession ? `
                <div class="status-indicator active"></div>
                <span>Session Active</span>
            ` : `
                <div class="status-indicator inactive"></div>
                <span>No Active Session</span>
            `}
        </div>
        <div class="action-buttons">
            <button class="primary-button checkin-button" ${!hasActiveSession ? 'disabled' : ''}>
                ${isInRange ? 'Check In Now' : 'Too Far Away'}
            </button>
            <button class="secondary-button absent-button" ${!hasActiveSession ? 'disabled' : ''}>
                Mark Absent
            </button>
        </div>
    `;

            // Add event listeners
            if (hasActiveSession) {
                card.querySelector('.checkin-button').addEventListener('click', () => handleStudentCheckIn(section.id));
                card.querySelector('.absent-button').addEventListener('click', () => markStudentAbsent(section.id));
            }

            card.querySelector('.section-menu-button').addEventListener('click', (e) => showStudentSectionMenu(e, section));

            return card;
        }

        // Load Student Sections
        async function loadStudentSections() {
            DOM.showLoading("Loading your classes...");

            try {
                // First get enrollments
                const enrollmentsQuery = await firebase.firestore().collection('enrollments')
                    .where('studentId', '==', APP_STATE.currentUser.uid)
                    .get();

                const enrollments = [];
                const sectionPromises = [];

                enrollmentsQuery.forEach((doc) => {
                    const enrollment = {
                        id: doc.id,
                        ...doc.data()
                    };
                    enrollments.push(enrollment);

                    sectionPromises.push(
                        firebase.firestore().collection('sections').doc(enrollment.sectionId).get()
                        .then((sectionDoc) => {
                            if (sectionDoc.exists) {
                                const section = {
                                    id: sectionDoc.id,
                                    ...sectionDoc.data(),
                                    enrollmentId: doc.id
                                };

                                // Get teacher name
                                return firebase.firestore().collection('users').doc(section.teacherId).get()
                                    .then((teacherDoc) => {
                                        if (teacherDoc.exists) {
                                            section.teacherName = teacherDoc.data().displayName;
                                        }
                                        return section;
                                    });
                            }
                            return null;
                        })
                    );
                });

                // Wait for all sections to load
                const sections = await Promise.all(sectionPromises);
                APP_STATE.enrolledSections = sections.filter(s => s !== null);

                // Check for active sessions and student's distance
                await checkStudentActiveSessions();

                // Load attendance records
                await loadStudentAttendanceRecords();

                // Update UI
                if (APP_STATE.currentView === 'student-dashboard') {
                    renderStudentDashboard();
                } else if (APP_STATE.currentView === 'sections') {
                    renderStudentSectionsView();
                }

                DOM.hideLoading();
            } catch (error) {
                DOM.hideLoading();
                showError("Failed to load your classes.", error);
            }
        }

        // Check for active sessions and student's distance
        async function checkStudentActiveSessions() {
            const now = new Date();
            const checkPromises = [];

            // Get student's current location
            let studentLocation = null;
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });

                studentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
            } catch (error) {
                console.error("Error getting student location:", error);
            }

            APP_STATE.enrolledSections.forEach(section => {
                if (section.activeSession) {
                    checkPromises.push(
                        firebase.firestore().collection('sessions').doc(section.activeSession).get()
                        .then((doc) => {
                            if (doc.exists) {
                                const session = doc.data();
                                const startTime = session.startTime.toDate();
                                const elapsedHours = (now - startTime) / (1000 * 60 * 60);

                                if (elapsedHours > CONFIG.sessionTimeout || session.status === 'ended') {
                                    // Session expired or ended
                                    section.activeSession = null;
                                    section.inRange = false;
                                } else if (studentLocation) {
                                    // Calculate distance to session location
                                    const distance = calculateDistance(
                                        studentLocation.lat,
                                        studentLocation.lng,
                                        session.location.latitude,
                                        session.location.longitude
                                    );

                                    section.inRange = distance <= session.range;
                                } else {
                                    section.inRange = false;
                                }
                            } else {
                                // Session document doesn't exist
                                section.activeSession = null;
                                section.inRange = false;
                            }
                        })
                    );
                } else {
                    section.inRange = false;
                }
            });

            try {
                await Promise.all(checkPromises);
            } catch (error) {
                console.error("Error checking active sessions:", error);
            }
        }

        // Calculate distance between two points in meters
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const 1 = lat1 * Math.PI / 180;
            const 2 = lat2 * Math.PI / 180;
            const  = (lat2 - lat1) * Math.PI / 180;
            const  = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin( / 2) * Math.sin( / 2) +
                Math.cos(1) * Math.cos(2) *
                Math.sin( / 2) * Math.sin( / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        // Load student attendance records
        async function loadStudentAttendanceRecords() {
            try {
                const querySnapshot = await firebase.firestore().collection('attendance')
                    .where('studentId', '==', APP_STATE.currentUser.uid)
                    .orderBy('checkInTime', 'desc')
                    .get();

                APP_STATE.attendanceRecords = [];
                querySnapshot.forEach(doc => {
                    APP_STATE.attendanceRecords.push(doc.data());
                });
            } catch (error) {
                console.error("Error loading attendance records:", error);
            }
        }

        // Handle Student Check-in
        async function handleStudentCheckIn(sectionId) {
            DOM.showLoading("Checking in...");

            try {
                // Get current location
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });

                const location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };

                // Get section and active session
                const section = APP_STATE.enrolledSections.find(s => s.id === sectionId);
                if (!section || !section.activeSession) {
                    throw new Error("No active session found for this class.");
                }

                const sessionDoc = await firebase.firestore().collection('sessions').doc(section.activeSession).get();
                if (!sessionDoc.exists) {
                    throw new Error("Session not found.");
                }

                const session = sessionDoc.data();
                const sessionLocation = session.location;

                // Calculate distance to session location
                const distance = calculateDistance(
                    location.lat,
                    location.lng,
                    sessionLocation.latitude,
                    sessionLocation.longitude
                );

                // Check if student is within range
                if (distance > session.range) {
                    throw new Error(`You are ${Math.round(distance)}m away from the class location (max ${session.range}m). Please move closer to check in.`);
                }

                // Create attendance record
                await firebase.firestore().collection('attendance').add({
                    sectionId: sectionId,
                    sessionId: section.activeSession,
                    studentId: APP_STATE.currentUser.uid,
                    studentName: APP_STATE.currentUser.displayName,
                    checkInTime: firebase.firestore.FieldValue.serverTimestamp(),
                    location: new firebase.firestore.GeoPoint(location.lat, location.lng),
                    distance: distance,
                    status: 'present'
                });

                // Update session attendance count
                await firebase.firestore().collection('sessions').doc(section.activeSession).update({
                    attendanceCount: firebase.firestore.FieldValue.increment(1)
                });

                DOM.hideLoading();
                showInfo("Checked in successfully!");
                await loadStudentSections();
            } catch (error) {
                DOM.hideLoading();

                if (error.code === error.PERMISSION_DENIED) {
                    showError("Location access is required to check in. Please enable location services.");
                } else {
                    showError(error.message, error);
                }
            }
        }

        // Mark Student Absent
        async function markStudentAbsent(sectionId) {
            showConfirmation(
                "Mark Yourself Absent",
                "Are you sure you want to mark yourself absent for this class?",
                "Mark Absent",
                "Cancel",
                async () => {
                    DOM.showLoading("Marking absent...");

                    try {
                        // Get section and active session
                        const section = APP_STATE.enrolledSections.find(s => s.id === sectionId);
                        if (!section || !section.activeSession) {
                            throw new Error("No active session found for this class.");
                        }

                        // Create attendance record
                        await firebase.firestore().collection('attendance').add({
                            sectionId: sectionId,
                            sessionId: section.activeSession,
                            studentId: APP_STATE.currentUser.uid,
                            studentName: APP_STATE.currentUser.displayName,
                            checkInTime: firebase.firestore.FieldValue.serverTimestamp(),
                            status: 'absent',
                            note: 'Marked absent by student'
                        });

                        DOM.hideLoading();
                        showInfo("You have been marked absent for this class.");
                        await loadStudentSections();
                    } catch (error) {
                        DOM.hideLoading();
                        showError("Failed to mark absent.", error);
                    }
                }
            );
        }

        // Show Student Section Menu
        function showStudentSectionMenu(e, section) {
            e.stopPropagation();

            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.top = `${e.clientY}px`;
            menu.style.left = `${e.clientX}px`;
            menu.innerHTML = `
        <ul>
            <li><button class="menu-item" data-action="view"><i class="fas fa-eye"></i> View Class</button></li>
            <li><button class="menu-item" data-action="attendance"><i class="fas fa-calendar-check"></i> View Attendance</button></li>
            <li><button class="menu-item" data-action="leave"><i class="fas fa-sign-out-alt"></i> Leave Class</button></li>
        </ul>
    `;

            document.body.appendChild(menu);

            // Close menu when clicking elsewhere
            const closeMenu = () => {
                document.body.removeChild(menu);
                document.removeEventListener('click', closeMenu);
            };

            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 100);

            // Menu actions
            menu.querySelector('[data-action="view"]').addEventListener('click', () => {
                closeMenu();
                viewStudentSectionDetails(section);
            });

            menu.querySelector('[data-action="attendance"]').addEventListener('click', () => {
                closeMenu();
                viewStudentAttendance(APP_STATE.currentUser.uid, section.id);
            });

            menu.querySelector('[data-action="leave"]').addEventListener('click', () => {
                closeMenu();
                showLeaveSectionModal(section);
            });
        }

        // View Student Section Details
        function viewStudentSectionDetails(section) {
            APP_STATE.selectedSection = section;
            navigateToView('section-details');
        }

        // Render Student Section Details View
        function renderStudentSectionDetailsView() {
            if (!APP_STATE.selectedSection) {
                navigateToView('sections');
                return;
            }

            const section = APP_STATE.selectedSection;
            DOM.clearAppContainer();

            // Header
            const header = document.createElement('header');
            header.className = 'app-header';
            header.innerHTML = `
        <button class="drawer-button" id="drawer-button"><i class="fas fa-bars"></i></button>
        <div class="logo">${CONFIG.appName}</div>
        <button class="back-button" id="back-button"><i class="fas fa-arrow-left"></i> Back</button>
    `;

            // Main Content
            const main = document.createElement('main');
            main.className = 'dashboard-main';

            // Section Header
            const sectionHeader = document.createElement('div');
            sectionHeader.className = 'section-details-header';
            sectionHeader.innerHTML = `
        <div class="section-info">
            <h2>${section.name}</h2>
            <p class="section-subject">${section.subject}</p>
            <p class="teacher-name"><i class="fas fa-chalkboard-teacher"></i> ${section.teacherName}</p>
        </div>
        <div class="section-status">
            ${section.activeSession ? `
                <div class="status-indicator active"></div>
                <span>Session Active</span>
            ` : `
                <div class="status-indicator inactive"></div>
                <span>No Active Session</span>
            `}
        </div>
    `;

            // Section Stats
            const sectionStats = document.createElement('div');
            sectionStats.className = 'section-stats-grid';

            // Attendance Rate
            const attendanceStat = document.createElement('div');
            attendanceStat.className = 'stat-card';
            const attendanceRecords = APP_STATE.attendanceRecords.filter(r => r.sectionId === section.id);
            const presentCount = attendanceRecords.filter(r => r.status === 'present').length;
            const attendancePercent = attendanceRecords.length > 0 ? Math.round((presentCount / attendanceRecords.length) * 100) : 0;
            attendanceStat.innerHTML = `
        <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
        <div class="stat-value">${attendancePercent}%</div>
        <div class="stat-label">Attendance</div>
    `;

            // Sessions Count
            const sessionsStat = document.createElement('div');
            sessionsStat.className = 'stat-card';
            sessionsStat.innerHTML = `
        <div class="stat-icon"><i class="fas fa-chalkboard"></i></div>
        <div class="stat-value">${attendanceRecords.length}</div>
        <div class="stat-label">Sessions</div>
    `;

            sectionStats.appendChild(attendanceStat);
            sectionStats.appendChild(sessionsStat);

            // Schedule
            const scheduleSection = document.createElement('div');
            scheduleSection.className = 'section-schedule-card';
            scheduleSection.innerHTML = `
        <h3><i class="fas fa-calendar-alt"></i> Schedule</h3>
        <div class="schedule-days" id="schedule-days">
            ${Object.entries(section.schedule || {}).map(([day, times]) => ` <
                div class = "schedule-day" >
                <
                span class = "day-name" > $ {
                    day.charAt(0).toUpperCase() + day.slice(1)
                } < /span> <
                span class = "day-time" > $ {
                    times.start
                } - $ {
                    times.end
                } < /span> <
                /div>
            `).join('')}
        </div>
    `;

            // Recent Attendance
            const attendanceSection = document.createElement('div');
            attendanceSection.className = 'section-attendance-card';
            attendanceSection.innerHTML = `
        <div class="attendance-header">
            <h3><i class="fas fa-history"></i> Recent Attendance</h3>
            <a href="#" id="view-all-attendance">View All</a>
        </div>
        <div class="attendance-list" id="attendance-list">
            ${attendanceRecords.slice(0, 3).map(record => {
                const date = record.checkInTime.toDate();
                return `
                <div class="attendance-item">
                    <div class="attendance-date">
                        <div class="attendance-day">${formatDate(date)}</div>
                        <div class="attendance-time">${formatTime(date)}</div>
                    </div>
                    <div class="attendance-status">
                        <span class="status-badge ${record.status}">${record.status.charAt(0).toUpperCase() + record.status.slice(1)}</span>
                    </div>
                    <div class="attendance-distance">
                        ${record.distance ? `${Math.round(record.distance)}m` : 'N/A'}
                    </div>
                </div>
                `;
            }).join('')}
        </div>
    `;

            // Check-in Button
            const checkinSection = document.createElement('div');
            checkinSection.className = 'checkin-section';
            checkinSection.innerHTML = `
        <button class="primary-button checkin-button" ${!section.activeSession ? 'disabled' : ''}>
            ${section.inRange ? 'Check In Now' : 'Too Far Away'}
        </button>
        <button class="secondary-button absent-button" ${!section.activeSession ? 'disabled' : ''}>
            Mark Absent
        </button>
    `;

            main.appendChild(sectionHeader);
            main.appendChild(sectionStats);
            main.appendChild(scheduleSection);
            main.appendChild(attendanceSection);
            main.appendChild(checkinSection);

            // Drawer
            const drawer = document.createElement('div');
            drawer.className = 'app-drawer';
            drawer.id = 'app-drawer';
            drawer.innerHTML = `
        <div class="drawer-header">
            <div class="user-info">
                <div class="user-avatar">${getInitials(APP_STATE.currentUser.displayName)}</div>
                <div class="user-details">
                    <div class="user-name">${APP_STATE.currentUser.displayName}</div>
                    <div class="user-role">Student</div>
                </div>
            </div>
        </div>
        <nav class="drawer-nav">
            <ul>
                <li class="${APP_STATE.currentView === 'student-dashboard' ? 'active' : ''}"><a href="#" data-view="student-dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="${APP_STATE.currentView === 'sections' ? 'active' : ''}"><a href="#" data-view="sections"><i class="fas fa-layer-group"></i> My Classes</a></li>
                <li class="${APP_STATE.currentView === 'attendance' ? 'active' : ''}"><a href="#" data-view="attendance"><i class="fas fa-calendar-check"></i> My Attendance</a></li>
                <li class="${APPSTYLE.currentView === 'settings' ? 'active' : ''}"><a href="#" data-view="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>
        <div class="drawer-footer">
            <a href="#" id="signout-button"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
        </div>
    `;

            DOM.appContainer.appendChild(header);
            DOM.appContainer.appendChild(drawer);
            DOM.appContainer.appendChild(main);

            // Add event listeners
            document.getElementById('drawer-button').addEventListener('click', toggleDrawer);
            document.getElementById('back-button').addEventListener('click', () => navigateToView('sections'));
            document.getElementById('signout-button').addEventListener('click', handleSignOut);
            document.getElementById('view-all-attendance').addEventListener('click', (e) => {
                e.preventDefault();
                viewStudentAttendance(APP_STATE.currentUser.uid, section.id);
            });

            if (section.activeSession) {
                document.querySelector('.checkin-button').addEventListener('click', () => handleStudentCheckIn(section.id));
                document.querySelector('.absent-button').addEventListener('click', () => markStudentAbsent(section.id));
            }

            // Drawer navigation
            document.querySelectorAll('.drawer-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.target.getAttribute('data-view');
                    navigateToView(view);
                });
            });
        }

        // Show Leave Section Modal
        function showLeaveSectionModal(section) {
            showConfirmation(
                "Leave Class",
                `Are you sure you want to leave ${section.name}? You will need an invite code to rejoin.`,
                "Leave Class",
                "Cancel",
                async () => {
                    DOM.showLoading("Leaving class...");

                    try {
                        // Find enrollment
                        const enrollmentQuery = await firebase.firestore().collection('enrollments')
                            .where('sectionId', '==', section.id)
                            .where('studentId', '==', APP_STATE.currentUser.uid)
                            .get();

                        if (enrollmentQuery.empty) {
                            throw new Error("Enrollment not found.");
                        }

                        // Delete enrollment
                        await firebase.firestore().collection('enrollments').doc(enrollmentQuery.docs[0].id).delete();

                        DOM.hideLoading();
                        showInfo("You have left the class.");
                        await loadStudentSections();
                        navigateToView('sections');
                    } catch (error) {
                        DOM.hideLoading();
                        showError("Failed to leave class.", error);
                    }
                }
            );
        }

        // Show Enroll Section Form
        function showEnrollSectionForm() {
            const modalContent = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Join a Class</h3>
                <button class="close-button"><i class="fas fa-times"></i></button>
            </div>
            <form id="enroll-section-form">
                <div class="form-group">
                    <label for="section-code">Class Code</label>
                    <input type="text" id="section-code" required placeholder="Enter the class code">
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary-button" id="cancel-enroll">Cancel</button>
                    <button type="submit" class="primary-button">Join Class</button>
                </div>
            </form>
        </div>
    `;

            DOM.showModal(modalContent);

            // Add event listeners
            document.querySelector('.close-button').addEventListener('click', () => DOM.hideModal());
            document.getElementById('cancel-enroll').addEventListener('click', () => DOM.hideModal());

            // Form submission
            document.getElementById('enroll-section-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const sectionCode = document.getElementById('section-code').value.trim();

                if (!sectionCode) {
                    showError("Please enter a class code.");
                    return;
                }

                DOM.showLoading("Joining class...");

                try {
                    await joinSection(sectionCode);
                    DOM.hideModal();
                    showInfo("Class joined successfully!");
                    await loadStudentSections();
                } catch (error) {
                    DOM.hideLoading();
                    showError(error.message, error);
                }
            });
        }

        // Join Section
        async function joinSection(sectionId) {
            try {
                // Check if section exists
                const sectionDoc = await firebase.firestore().collection('sections').doc(sectionId).get();
                if (!sectionDoc.exists) {
                    throw new Error("Class not found. Please check the code and try again.");
                }

                // Check if already enrolled
                const enrollmentQuery = await firebase.firestore().collection('enrollments')
                    .where('sectionId', '==', sectionId)
                    .where('studentId', '==', APP_STATE.currentUser.uid)
                    .get();

                if (!enrollmentQuery.empty) {
                    throw new Error("You are already enrolled in this class.");
                }

                // Create enrollment
                await firebase.firestore().collection('enrollments').add({
                    sectionId: sectionId,
                    studentId: APP_STATE.currentUser.uid,
                    enrolledAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                });

                // Update student count in section
                await firebase.firestore().collection('sections').doc(sectionId).update({
                    studentCount: firebase.firestore.FieldValue.increment(1)
                });

                return true;
            } catch (error) {
                throw error;
            }
        }

        // Render Student Sections View
        function renderStudentSectionsView() {
            DOM.clearAppContainer();

            // Header
            const header = document.createElement('header');
            header.className = 'app-header';
            header.innerHTML = `
        <button class="drawer-button" id="drawer-button"><i class="fas fa-bars"></i></button>
        <div class="logo">${CONFIG.appName}</div>
        <button class="enroll-button" id="enroll-button"><i class="fas fa-plus"></i> Enroll</button>
    `;

            // Main Content
            const main = document.createElement('main');
            main.className = 'dashboard-main';

            // Page Title
            const pageTitle = document.createElement('div');
            pageTitle.className = 'page-title';
            pageTitle.innerHTML = '<h2>My Classes</h2>';

            // Sections Grid
            const sectionsGrid = document.createElement('div');
            sectionsGrid.className = 'sections-grid';
            sectionsGrid.id = 'sections-grid';

            // Loading skeleton or sections
            if (APP_STATE.enrolledSections.length === 0) {
                sectionsGrid.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-book-open"></i></div>
                <h3>No Enrolled Classes</h3>
                <p>You haven't enrolled in any classes yet. Use the button above to join a class.</p>
                <button class="primary-button" id="enroll-empty-button">Enroll Now</button>
            </div>
        `;
            } else {
                APP_STATE.enrolledSections.forEach(section => {
                    const sectionCard = createStudentSectionCard(section);
                    sectionsGrid.appendChild(sectionCard);
                });
            }

            // Drawer
            const drawer = document.createElement('div');
            drawer.className = 'app-drawer';
            drawer.id = 'app-drawer';
            drawer.innerHTML = `
        <div class="drawer-header">
            <div class="user-info">
                <div class="user-avatar">${getInitials(APP_STATE.currentUser.displayName)}</div>
                <div class="user-details">
                    <div class="user-name">${APP_STATE.currentUser.displayName}</div>
                    <div class="user-role">Student</div>
                </div>
            </div>
        </div>
        <nav class="drawer-nav">
            <ul>
                <li class="${APP_STATE.currentView === 'student-dashboard' ? 'active' : ''}"><a href="#" data-view="student-dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="${APP_STATE.currentView === 'sections' ? 'active' : ''}"><a href="#" data-view="sections"><i class="fas fa-layer-group"></i> My Classes</a></li>
                <li class="${APP_STATE.currentView === 'attendance' ? 'active' : ''}"><a href="#" data-view="attendance"><i class="fas fa-calendar-check"></i> My Attendance</a></li>
                <li class="${APP_STATE.currentView === 'settings' ? 'active' : ''}"><a href="#" data-view="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>
        <div class="drawer-footer">
            <a href="#" id="signout-button"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
        </div>
    `;

            main.appendChild(pageTitle);
            main.appendChild(sectionsGrid);

            DOM.appContainer.appendChild(header);
            DOM.appContainer.appendChild(drawer);
            DOM.appContainer.appendChild(main);

            // Add event listeners
            document.getElementById('drawer-button').addEventListener('click', toggleDrawer);
            document.getElementById('enroll-button').addEventListener('click', showEnrollSectionForm);
            document.getElementById('signout-button').addEventListener('click', handleSignOut);

            if (document.getElementById('enroll-empty-button')) {
                document.getElementById('enroll-empty-button').addEventListener('click', showEnrollSectionForm);
            }

            // Drawer navigation
            document.querySelectorAll('.drawer-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.target.getAttribute('data-view');
                    navigateToView(view);
                });
            });
        }

        // Render Attendance View
        function renderAttendanceView() {
            DOM.clearAppContainer();

            // Header
            const header = document.createElement('header');
            header.className = 'app-header';
            header.innerHTML = `
        <button class="drawer-button" id="drawer-button"><i class="fas fa-bars"></i></button>
        <div class="logo">${CONFIG.appName}</div>
        <div class="header-spacer"></div>
    `;

            // Main Content
            const main = document.createElement('main');
            main.className = 'dashboard-main';

            // Page Title
            const pageTitle = document.createElement('div');
            pageTitle.className = 'page-title';
            pageTitle.innerHTML = '<h2>My Attendance</h2>';

            // Attendance Summary
            const attendanceSummary = document.createElement('div');
            attendanceSummary.className = 'attendance-summary';
            const totalRecords = APP_STATE.attendanceRecords.length;
            const presentCount = APP_STATE.attendanceRecords.filter(r => r.status === 'present').length;
            const absentCount = APP_STATE.attendanceRecords.filter(r => r.status === 'absent').length;
            const attendancePercent = totalRecords > 0 ? Math.round((presentCount / totalRecords) * 100) : 0;

            attendanceSummary.innerHTML = `
        <div class="summary-card">
            <div class="summary-value">${totalRecords}</div>
            <div class="summary-label">Total Sessions</div>
        </div>
        <div class="summary-card">
            <div class="summary-value">${presentCount}</div>
            <div class="summary-label">Present</div>
        </div>
        <div class="summary-card">
            <div class="summary-value">${absentCount}</div>
            <div class="summary-label">Absent</div>
        </div>
        <div class="summary-card">
            <div class="summary-value">${attendancePercent}%</div>
            <div class="summary-label">Attendance Rate</div>
        </div>
    `;

            // Attendance Chart
            const attendanceChart = document.createElement('div');
            attendanceChart.className = 'attendance-chart';
            attendanceChart.innerHTML = `
        <h3>Attendance by Class</h3>
        <div class="chart-container" id="attendance-chart">
            <canvas id="attendance-canvas"></canvas>
        </div>
    `;

            // Attendance List
            const attendanceList = document.createElement('div');
            attendanceList.className = 'attendance-list-container';
            attendanceList.innerHTML = `
        <h3>Recent Attendance</h3>
        <div class="attendance-list" id="attendance-list">
            ${APP_STATE.attendanceRecords.slice(0, 10).map(record => {
                const date = record.checkInTime.toDate();
                const section = APP_STATE.enrolledSections.find(s => s.id === record.sectionId);
                const sectionName = section ? section.name : 'Unknown Class';
                
                return `
                <div class="attendance-item">
                    <div class="attendance-date">
                        <div class="attendance-day">${formatDate(date)}</div>
                        <div class="attendance-time">${formatTime(date)}</div>
                    </div>
                    <div class="attendance-class">${sectionName}</div>
                    <div class="attendance-status">
                        <span class="status-badge ${record.status}">${record.status.charAt(0).toUpperCase() + record.status.slice(1)}</span>
                    </div>
                    <div class="attendance-distance">
                        ${record.distance ? `${Math.round(record.distance)}m` : 'N/A'}
                    </div>
                </div>
                `;
            }).join('')}
        </div>
    `;

            main.appendChild(pageTitle);
            main.appendChild(attendanceSummary);
            main.appendChild(attendanceChart);
            main.appendChild(attendanceList);

            // Drawer
            const drawer = document.createElement('div');
            drawer.className = 'app-drawer';
            drawer.id = 'app-drawer';
            drawer.innerHTML = `
        <div class="drawer-header">
            <div class="user-info">
                <div class="user-avatar">${getInitials(APP_STATE.currentUser.displayName)}</div>
                <div class="user-details">
                    <div class="user-name">${APP_STATE.currentUser.displayName}</div>
                    <div class="user-role">Student</div>
                </div>
            </div>
        </div>
        <nav class="drawer-nav">
            <ul>
                <li class="${APP_STATE.currentView === 'student-dashboard' ? 'active' : ''}"><a href="#" data-view="student-dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="${APP_STATE.currentView === 'sections' ? 'active' : ''}"><a href="#" data-view="sections"><i class="fas fa-layer-group"></i> My Classes</a></li>
                <li class="${APP_STATE.currentView === 'attendance' ? 'active' : ''}"><a href="#" data-view="attendance"><i class="fas fa-calendar-check"></i> My Attendance</a></li>
                <li class="${APP_STATE.currentView === 'settings' ? 'active' : ''}"><a href="#" data-view="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>
        <div class="drawer-footer">
            <a href="#" id="signout-button"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
        </div>
    `;

            DOM.appContainer.appendChild(header);
            DOM.appContainer.appendChild(drawer);
            DOM.appContainer.appendChild(main);

            // Render chart
            renderAttendanceChart();

            // Add event listeners
            document.getElementById('drawer-button').addEventListener('click', toggleDrawer);
            document.getElementById('signout-button').addEventListener('click', handleSignOut);

            // Drawer navigation
            document.querySelectorAll('.drawer-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.target.getAttribute('data-view');
                    navigateToView(view);
                });
            });
        }

        // Render Attendance Chart
        function renderAttendanceChart() {
            const canvas = document.getElementById('attendance-canvas');
            if (!canvas) return;

            // Group attendance by section
            const sectionStats = {};

            APP_STATE.attendanceRecords.forEach(record => {
                if (!sectionStats[record.sectionId]) {
                    const section = APP_STATE.enrolledSections.find(s => s.id === record.sectionId);
                    sectionStats[record.sectionId] = {
                        name: section ? section.name : 'Unknown',
                        present: 0,
                        total: 0
                    };
                }

                sectionStats[record.sectionId].total++;
                if (record.status === 'present') {
                    sectionStats[record.sectionId].present++;
                }
            });

            const sectionIds = Object.keys(sectionStats);
            const sectionNames = sectionIds.map(id => sectionStats[id].name);
            const attendanceRates = sectionIds.map(id => {
                return sectionStats[id].total > 0 ?
                    Math.round((sectionStats[id].present / sectionStats[id].total)) * 100 : 0;
            });

            // Create chart
            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sectionNames,
                    datasets: [{
                        label: 'Attendance Rate (%)',
                        data: attendanceRates,
                        backgroundColor: '#4CAF50',
                        borderColor: '#388E3C',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Render Settings View
        function renderSettingsView() {
            DOM.clearAppContainer();

            // Header
            const header = document.createElement('header');
            header.className = 'app-header';
            header.innerHTML = `
        <button class="drawer-button" id="drawer-button"><i class="fas fa-bars"></i></button>
        <div class="logo">${CONFIG.appName}</div>
        <div class="header-spacer"></div>
    `;

            // Main Content
            const main = document.createElement('main');
            main.className = 'dashboard-main';

            // Page Title
            const pageTitle = document.createElement('div');
            pageTitle.className = 'page-title';
            pageTitle.innerHTML = '<h2>Settings</h2>';

            // Settings Form
            const settingsForm = document.createElement('form');
            settingsForm.className = 'settings-form';
            settingsForm.id = 'settings-form';
            settingsForm.innerHTML = `
        <div class="settings-section">
            <h3><i class="fas fa-user"></i> Account</h3>
            <div class="form-group">
                <label for="display-name">Display Name</label>
                <input type="text" id="display-name" value="${APP_STATE.currentUser.displayName}" required>
                <p class="form-note">You can change your name once every ${CONFIG.nameChangeWindow} days.</p>
            </div>
            <button type="button" class="secondary-button" id="change-password-button">Change Password</button>
            <button type="button" class="secondary-button" id="delete-account-button">Delete Account</button>
        </div>
        <div class="settings-section">
            <h3><i class="fas fa-bell"></i> Notifications</h3>
            <div class="form-check">
                <input type="checkbox" id="enable-notifications" ${APP_STATE.settings.notifications ? 'checked' : ''}>
                <label for="enable-notifications">Enable Notifications</label>
            </div>
            <div class="form-check">
                <input type="checkbox" id="enable-reminders" ${APP_STATE.settings.notifications ? 'checked' : ''}>
                <label for="enable-reminders">Session Reminders</label>
            </div>
        </div>
        <div class="settings-section">
            <h3><i class="fas fa-paint-brush"></i> Appearance</h3>
            <div class="form-check">
                <input type="checkbox" id="dark-mode" ${APP_STATE.settings.darkMode ? 'checked' : ''}>
                <label for="dark-mode">Dark Mode</label>
            </div>
            <div class="form-group">
                <label for="font-size">Text Size</label>
                <select id="font-size">
                    <option value="small" ${APP_STATE.settings.fontSize === 'small' ? 'selected' : ''}>Small</option>
                    <option value="medium" ${APP_STATE.settings.fontSize === 'medium' ? 'selected' : ''}>Medium</option>
                    <option value="large" ${APP_STATE.settings.fontSize === 'large' ? 'selected' : ''}>Large</option>
                </select>
            </div>
        </div>
        <div class="settings-section">
            <h3><i class="fas fa-shield-alt"></i> Privacy</h3>
            <div class="form-check">
                <input type="checkbox" id="location-sharing" ${APP_STATE.settings.locationSharing ? 'checked' : ''}>
                <label for="location-sharing">Allow Location Sharing</label>
            </div>
            <div class="form-check">
                <input type="checkbox" id="keep-signed-in" ${APP_STATE.settings.keepSignedIn ? 'checked' : ''}>
                <label for="keep-signed-in">Keep Me Signed In</label>
            </div>
            <div class="privacy-links">
                <a href="${CONFIG.privacyPolicyURL}" target="_blank">Privacy Policy</a>
                <a href="${CONFIG.termsOfServiceURL}" target="_blank">Terms of Service</a>
            </div>
        </div>
        <div class="form-actions">
            <button type="submit" class="primary-button">Save Changes</button>
        </div>
    `;

            main.appendChild(pageTitle);
            main.appendChild(settingsForm);

            // Drawer
            const drawer = document.createElement('div');
            drawer.className = 'app-drawer';
            drawer.id = 'app-drawer';
            drawer.innerHTML = `
        <div class="drawer-header">
            <div class="user-info">
                <div class="user-avatar">${getInitials(APP_STATE.currentUser.displayName)}</div>
                <div class="user-details">
                    <div class="user-name">${APP_STATE.currentUser.displayName}</div>
                    <div class="user-role">${APP_STATE.currentRole === 'teacher' ? 'Teacher' : 'Student'}</div>
                </div>
            </div>
        </div>
        <nav class="drawer-nav">
            <ul>
                ${APP_STATE.currentRole === 'teacher' ? `
                <li class="${APP_STATE.currentView === 'teacher-dashboard' ? 'active' : ''}"><a href="#" data-view="teacher-dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="${APP_STATE.currentView === 'sections' ? 'active' : ''}"><a href="#" data-view="sections"><i class="fas fa-layer-group"></i> My Sections</a></li>
                <li class="${APP_STATE.currentView === 'students' ? 'active' : ''}"><a href="#" data-view="students"><i class="fas fa-users"></i> My Students</a></li>
                <li class="${APP_STATE.currentView === 'reports' ? 'active' : ''}"><a href="#" data-view="reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
                ` : `
                <li class="${APP_STATE.currentView === 'student-dashboard' ? 'active' : ''}"><a href="#" data-view="student-dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="${APP_STATE.currentView === 'sections' ? 'active' : ''}"><a href="#" data-view="sections"><i class="fas fa-layer-group"></i> My Classes</a></li>
                <li class="${APP_STATE.currentView === 'attendance' ? 'active' : ''}"><a href="#" data-view="attendance"><i class="fas fa-calendar-check"></i> My Attendance</a></li>
                `}
                <li class="${APP_STATE.currentView === 'settings' ? 'active' : ''}"><a href="#" data-view="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>
        <div class="drawer-footer">
            <a href="#" id="signout-button"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
        </div>
    `;

            DOM.appContainer.appendChild(header);
            DOM.appContainer.appendChild(drawer);
            DOM.appContainer.appendChild(main);

            // Add event listeners
            document.getElementById('drawer-button').addEventListener('click', toggleDrawer);
            document.getElementById('signout-button').addEventListener('click', handleSignOut);
            document.getElementById('change-password-button').addEventListener('click', showChangePasswordModal);
            document.getElementById('delete-account-button').addEventListener('click', showDeleteAccountModal);

            // Settings form submission
            document.getElementById('settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                DOM.showLoading("Saving settings...");

                try {
                    // Update display name if changed
                    const newDisplayName = document.getElementById('display-name').value.trim();
                    if (newDisplayName !== APP_STATE.currentUser.displayName) {
                        // Check when name was last changed
                        const now = new Date();
                        const lastChange = APP_STATE.currentUser.nameLastChanged ?
                            APP_STATE.currentUser.nameLastChanged.toDate() : null;

                        if (lastChange && (now - lastChange) < (CONFIG.nameChangeWindow * 24 * 60 * 60 * 1000)) {
                            throw new Error(`You can only change your name once every ${CONFIG.nameChangeWindow} days.`);
                        }

                        await firebase.auth().currentUser.updateProfile({
                            displayName: newDisplayName
                        });

                        await firebase.firestore().collection('users').doc(APP_STATE.currentUser.uid).update({
                            displayName: newDisplayName,
                            nameLastChanged: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        APP_STATE.currentUser.displayName = newDisplayName;
                    }

                    // Update settings
                    const updatedSettings = {
                        notifications: document.getElementById('enable-notifications').checked,
                        darkMode: document.getElementById('dark-mode').checked,
                        fontSize: document.getElementById('font-size').value,
                        locationSharing: document.getElementById('location-sharing').checked,
                        keepSignedIn: document.getElementById('keep-signed-in').checked
                    };

                    await firebase.firestore().collection('users').doc(APP_STATE.currentUser.uid).update({
                        settings: updatedSettings
                    });

                    APP_STATE.settings = updatedSettings;

                    // Apply theme changes
                    applyThemeSettings();

                    DOM.hideLoading();
                    showInfo("Settings saved successfully!");
                } catch (error) {
                    DOM.hideLoading();
                    showError("Failed to save settings.", error);
                }
            });
        }

        // Show Change Password Modal
        function showChangePasswordModal() {
            const modalContent = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Password</h3>
                <button class="close-button"><i class="fas fa-times"></i></button>
            </div>
            <form id="change-password-form">
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" required autocomplete="current-password">
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" required minlength="8" autocomplete="new-password">
                    <div class="password-strength" id="password-strength"></div>
                </div>
                <div class="form-group">
                    <label for="confirm-new-password">Confirm New Password</label>
                    <input type="password" id="confirm-new-password" required minlength="8" autocomplete="new-password">
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary-button" id="cancel-password-change">Cancel</button>
                    <button type="submit" class="primary-button">Change Password</button>
                </div>
            </form>
        </div>
    `;

            DOM.showModal(modalContent);

            // Add event listeners
            document.querySelector('.close-button').addEventListener('click', () => DOM.hideModal());
            document.getElementById('cancel-password-change').addEventListener('click', () => DOM.hideModal());

            // Password strength indicator
            const passwordInput = document.getElementById('new-password');
            const strengthIndicator = document.getElementById('password-strength');

            if (passwordInput && strengthIndicator) {
                passwordInput.addEventListener('input', () => {
                    const password = passwordInput.value;
                    const strength = calculatePasswordStrength(password);

                    strengthIndicator.innerHTML = '';
                    strengthIndicator.className = 'password-strength';

                    if (password.length > 0) {
                        const strengthBar = document.createElement('div');
                        strengthBar.className = `strength-bar strength-${strength.level}`;
                        strengthBar.style.width = `${strength.score * 25}%`;

                        const strengthText = document.createElement('span');
                        strengthText.textContent = strength.text;

                        strengthIndicator.appendChild(strengthBar);
                        strengthIndicator.appendChild(strengthText);
                        strengthIndicator.style.display = 'block';
                    } else {
                        strengthIndicator.style.display = 'none';
                    }
                });
            }

            // Form submission
            document.getElementById('change-password-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                DOM.showLoading("Changing password...");

                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-new-password').value;

                try {
                    // Validate inputs
                    if (newPassword !== confirmPassword) {
                        throw new Error("New passwords don't match.");
                    }

                    if (newPassword.length < 8) {
                        throw new Error("Password must be at least 8 characters.");
                    }

                    // Reauthenticate
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        APP_STATE.currentUser.email,
                        currentPassword
                    );

                    await firebase.auth().currentUser.reauthenticateWithCredential(credential);

                    // Update password
                    await firebase.auth().currentUser.updatePassword(newPassword);

                    DOM.hideLoading();
                    DOM.hideModal();
                    showInfo("Password changed successfully!");
                } catch (error) {
                    DOM.hideLoading();

                    let errorMessage = "Failed to change password.";
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = "Incorrect current password.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "Password is too weak. Please use a stronger password.";
                    }

                    showError(errorMessage, error);
                }
            });
        }

        // Show Delete Account Modal
        function showDeleteAccountModal() {
            showConfirmation(
                "Delete Account",
                "Are you sure you want to permanently delete your account? This will remove all your data and cannot be undone.",
                "Delete Account",
                "Cancel",
                () => {
                    // First prompt for password
                    showPasswordPrompt(
                        "Confirm Account Deletion",
                        "Please enter your password to confirm account deletion:",
                        async (password) => {
                                DOM.showLoading("Deleting account...");

                                try {
                                    // Reauthenticate
                                    const credential = firebase.auth.EmailAuthProvider.credential(
                                        APP_STATE.currentUser.email,
                                        password
                                    );

                                    await firebase.auth().currentUser.reauthenticateWithCredential(credential);

                                    // Delete user data
                                    if (APP_STATE.currentRole === 'teacher') {
                                        // Delete teacher's sections and related data
                                        const sectionsQuery = await firebase.firestore().collection('sections')
                                            .where('teacherId', '==', APP_STATE.currentUser.uid)
                                            .get();

                                        const batch = firebase.firestore().batch();

                                        sectionsQuery.forEach(doc => {
                                            batch.delete(doc.ref);
                                        });

                                        await batch.commit();
                                    }

                                    // Delete user document
                                    await firebase.firestore().collection('users').doc(APP_STATE.currentUser.uid).delete();

                                    // Delete auth user
                                    await firebase.auth().currentUser.delete();

                                    // Success
                                    DOM.hideLoading();
                                    showInfo("Account deleted successfully. Goodbye!");
                                    handleUserSignedOut();
                                } catch (error) {
                                    DOM.hideLoading();

                                    let errorMessage = "Failed to delete account.";
                                    if (error.code === 'auth/wrong-password') {
                                        errorMessage = "Incorrect password. Please try again.";
                                    }

                                    showError(errorMessage, error);
                                }
                            },
                            () => {
                                // Cancelled
                            }
                    );
                }
            );
        }

        // Show Password Prompt
        function showPasswordPrompt(title, message, confirmAction, cancelAction) {
            const modalContent = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>${title}</h3>
                <button class="close-button"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p>${message}</p>
                <div class="form-group">
                    <input type="password" id="confirm-password" required autocomplete="current-password">
                </div>
                <div id="password-error" class="error-message"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="secondary-button" id="cancel-password">Cancel</button>
                <button type="button" class="primary-button" id="confirm-password">Confirm</button>
            </div>
        </div>
    `;

            DOM.showModal(modalContent);

            // Add event listeners
            document.querySelector('.close-button').addEventListener('click', () => {
                DOM.hideModal();
                if (cancelAction) cancelAction();
            });

            document.getElementById('cancel-password').addEventListener('click', () => {
                DOM.hideModal();
                if (cancelAction) cancelAction();
            });

            document.getElementById('confirm-password').addEventListener('click', async () => {
                const password = document.getElementById('confirm-password').value;
                if (!password) {
                    document.getElementById('password-error').textContent = "Please enter your password.";
                    return;
                }

                try {
                    // Verify password
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        APP_STATE.currentUser.email,
                        password
                    );

                    await firebase.auth().currentUser.reauthenticateWithCredential(credential);
                    DOM.hideModal();
                    if (confirmAction) confirmAction(password);
                } catch (error) {
                    let errorMessage = "Password verification failed.";
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = "Incorrect password. Please try again.";
                    }

                    document.getElementById('password-error').textContent = errorMessage;
                }
            });
        }

        // Show Confirmation Dialog
        function showConfirmation(title, message, confirmText, cancelText, confirmAction, cancelAction) {
            const modalContent = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>${title}</h3>
                <button class="close-button"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p>${message}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="secondary-button" id="cancel-confirm">${cancelText}</button>
                <button type="button" class="primary-button" id="confirm-confirm">${confirmText}</button>
            </div>
        </div>
    `;

            DOM.showModal(modalContent);

            // Add event listeners
            const closeModal = () => {
                DOM.hideModal();
                if (cancelAction) cancelAction();
            };

            document.querySelector('.close-button').addEventListener('click', closeModal);
            document.getElementById('cancel-confirm').addEventListener('click', closeModal);
            document.getElementById('confirm-confirm').addEventListener('click', () => {
                DOM.hideModal();
                if (confirmAction) confirmAction();
            });
        }

        // Show Error Message
        function showError(message, error = null) {
            console.error(message, error);

            const errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            errorElement.innerHTML = `
        <div class="error-content">
            <i class="fas fa-exclamation-circle"></i>
            <span>${message}</span>
            ${error ? `<div class="error-details">${error.message || error}</div>` : ''}
        </div>
        <button class="close-error"><i class="fas fa-times"></i></button>
    `;

            // Insert at the top of the app container
            if (DOM.appContainer.firstChild) {
                DOM.appContainer.insertBefore(errorElement, DOM.appContainer.firstChild);
            } else {
                DOM.appContainer.appendChild(errorElement);
            }

            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (errorElement.parentNode) {
                    errorElement.classList.add('fade-out');
                    setTimeout(() => {
                        if (errorElement.parentNode) {
                            errorElement.parentNode.removeChild(errorElement);
                        }
                    }, 300);
                }
            }, 5000);

            // Manual close
            errorElement.querySelector('.close-error').addEventListener('click', () => {
                errorElement.classList.add('fade-out');
                setTimeout(() => {
                    if (errorElement.parentNode) {
                        errorElement.parentNode.removeChild(errorElement);
                    }
                }, 300);
            });
        }

        // Show Info Message
        function showInfo(message) {
            const infoElement = document.createElement('div');
            infoElement.className = 'info-message';
            infoElement.innerHTML = `
        <div class="info-content">
            <i class="fas fa-check-circle"></i>
            <span>${message}</span>
        </div>
        <button class="close-info"><i class="fas fa-times"></i></button>
    `;

            // Insert at the top of the app container
            if (DOM.appContainer.firstChild) {
                DOM.appContainer.insertBefore(infoElement, DOM.appContainer.firstChild);
            } else {
                DOM.appContainer.appendChild(infoElement);
            }

            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (infoElement.parentNode) {
                    infoElement.classList.add('fade-out');
                    setTimeout(() => {
                        if (infoElement.parentNode) {
                            infoElement.parentNode.removeChild(infoElement);
                        }
                    }, 300);
                }
            }, 3000);

            // Manual close
            infoElement.querySelector('.close-info').addEventListener('click', () => {
                infoElement.classList.add('fade-out');
                setTimeout(() => {
                    if (infoElement.parentNode) {
                        infoElement.parentNode.removeChild(infoElement);
                    }
                }, 300);
            });
        }

        // Toggle Drawer
        function toggleDrawer() {
            const drawer = document.getElementById('app-drawer');
            if (drawer) {
                drawer.classList.toggle('open');
                APP_STATE.drawerOpen = !APP_STATE.drawerOpen;
            }
        }

        // Navigate to View
        function navigateToView(view) {
            APP_STATE.currentView = view;

            switch (view) {
                case 'teacher-dashboard':
                    loadTeacherDashboard();
                    break;
                case 'sections':
                    if (APP_STATE.currentRole === 'teacher') {
                        renderSectionsView();
                    } else {
                        renderStudentSectionsView();
                    }
                    break;
                case 'students':
                    renderStudentsView();
                    break;
                case 'reports':
                    renderReportsView();
                    break;
                case 'section-details':
                    if (APP_STATE.currentRole === 'teacher') {
                        renderSectionDetailsView();
                    } else {
                        renderStudentSectionDetailsView();
                    }
                    break;
                case 'student-dashboard':
                    loadStudentDashboard();
                    break;
                case 'attendance':
                    renderAttendanceView();
                    break;
                case 'settings':
                    renderSettingsView();
                    break;
                default:
                    if (APP_STATE.currentUser) {
                        loadDashboard();
                    } else {
                        renderAuthView();
                    }
            }

            // Close drawer if open
            if (APP_STATE.drawerOpen) {
                toggleDrawer();
            }
        }

        // Load Settings
        async function loadSettings() {
            try {
                const userDoc = await firebase.firestore().collection('users').doc(APP_STATE.currentUser.uid).get();
                if (userDoc.exists && userDoc.data().settings) {
                    APP_STATE.settings = {
                        ...APP_STATE.settings,
                        ...userDoc.data().settings
                    };

                    // Apply theme settings
                    applyThemeSettings();
                }
            } catch (error) {
                console.error("Error loading settings:", error);
            }
        }

        // Apply Theme Settings
        function applyThemeSettings() {
            // Dark mode
            if (APP_STATE.settings.darkMode) {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }

            // Font size
            document.body.classList.remove('font-small', 'font-medium', 'font-large');
            document.body.classList.add(`font-${APP_STATE.settings.fontSize}`);
        }

        // Setup Theme
        function setupTheme() {
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!APP_STATE.settings.darkMode) {
                    document.body.classList.toggle('dark-theme', e.matches);
                }
            });

            // Apply initial theme
            if (!APP_STATE.settings.darkMode && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-theme');
            }
        }

        // Handle Sign Out
        async function handleSignOut() {
            try {
                DOM.showLoading("Signing out...");
                await firebase.auth().signOut();
            } catch (error) {
                console.error("Sign out error:", error);
            }
        }

        // Format Date
        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Format Time
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Format Schedule
        function formatSchedule(schedule) {
            if (!schedule) return 'No schedule';

            const days = Object.keys(schedule);
            if (days.length === 0) return 'No schedule';

            const firstDay = days[0];
            return `${firstDay.charAt(0).toUpperCase() + firstDay.slice(1)} ${schedule[firstDay].start}`;
        }

        // Get Initials
        function getInitials(name) {
            return name.split(' ')
                .map(part => part.charAt(0).toUpperCase())
                .join('')
                .substring(0, 2);
        }

        // Copy to Clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        // Generate QR Code
        function generateQRCode(container, text) {
            // Simple QR code generation using a library would be implemented here
            // For this example, we'll just show the text
            container.innerHTML = `<div class="qr-code">${text}</div>`;
        }

        // Load Scripts
        function loadScripts(urls, callback) {
            let loaded = 0;

            urls.forEach(url => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = () => {
                    loaded++;
                    if (loaded === urls.length) {
                        callback();
                    }
                };
                document.head.appendChild(script);
            });
        }

        // Register Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful');
                        })
                        .catch(err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }
        }

        // Check Location Permission
        function checkLocationPermission() {
            if ('geolocation' in navigator) {
                navigator.permissions.query({
                        name: 'geolocation'
                    })
                    .then(permissionStatus => {
                        APP_STATE.locationPermission = permissionStatus.state === 'granted';

                        permissionStatus.onchange = () => {
                            APP_STATE.locationPermission = permissionStatus.state === 'granted';
                        };
                    })
                    .catch(error => {
                        console.error("Error checking location permission:", error);
                    });
            }
        }

        // Check Notification Permission
        function checkNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    APP_STATE.notificationPermission = true;
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        APP_STATE.notificationPermission = permission === 'granted';
                    });
                }
            }
        }

        // Initialize the app
        initializeFirebase();
    </script>

</body>

</html>
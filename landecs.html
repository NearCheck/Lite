<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NearCheck Lite - Smart Attendance System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #007AFF;
            --primary-dark: #0062CC;
            --primary-light: rgba(0, 122, 255, 0.1);
            --secondary: #34C759;
            --error: #FF3B30;
            --error-light: rgba(255, 59, 48, 0.1);
            --warning: #FF9500;
            --warning-light: rgba(255, 149, 0, 0.1);
            --success: #34C759;
            --success-light: rgba(52, 199, 89, 0.1);
            --text: #1C1C1E;
            --text-secondary: #636366;
            --text-tertiary: #8E8E93;
            --background: #F2F2F7;
            --card-background: #FFFFFF;
            --border-color: #E5E5EA;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --box-shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --sidebar-width: 280px;
            --header-height: 64px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.3;
        }

        p {
            color: var(--text-secondary);
        }

        a {
            color: var(--primary);
            text-decoration: none;
            transition: var(--transition);
        }

        a:hover {
            opacity: 0.8;
        }

        /* Buttons */
        .button {
            padding: 10px 16px;
            border-radius: var(--border-radius-sm);
            border: none;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            outline: none;
            position: relative;
            overflow: hidden;
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button:focus {
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
        }

        .button-primary {
            background-color: var(--primary);
            color: white;
        }

        .button-primary:hover {
            background-color: var(--primary-dark);
        }

        .button-secondary {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .button-secondary:hover {
            background-color: var(--primary-light);
        }

        .button-danger {
            background-color: var(--error);
            color: white;
        }

        .button-danger:hover {
            background-color: #D70015;
        }

        .button-success {
            background-color: var(--success);
            color: white;
        }

        .button-success:hover {
            background-color: #2DBE50;
        }

        .button-warning {
            background-color: var(--warning);
            color: white;
        }

        .button-warning:hover {
            background-color: #E68A00;
        }

        /* Cards */
        .card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-sm);
            padding: 20px;
            margin-bottom: 16px;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .card:hover {
            box-shadow: var(--box-shadow);
        }

        /* Inputs */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            transition: var(--transition);
            background-color: white;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .input-group .input-hint {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        /* Auth Screen */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background-color: var(--background);
        }

        .auth-card {
            width: 100%;
            max-width: 440px;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            background-color: var(--card-background);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .auth-header p {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.5;
        }

        .auth-logo {
            width: 60px;
            height: 60px;
            background-color: var(--primary);
            color: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 24px;
            font-weight: bold;
        }

        .role-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .role-button {
            padding: 16px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            background-color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
        }

        .role-button:hover {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }

        .role-button i {
            color: var(--primary);
            font-size: 20px;
        }

        .auth-footer {
            text-align: center;
            margin-top: 24px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Dashboard Layout */
        .dashboard {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* Sidebar */
        .drawer {
            width: var(--sidebar-width);
            background-color: var(--card-background);
            box-shadow: var(--box-shadow);
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: transform 0.3s ease;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .drawer-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
            height: var(--header-height);
        }

        .drawer-header h2 {
            font-size: 18px;
            color: var(--primary);
        }

        .menu-toggle {
            cursor: pointer;
            font-size: 18px;
            color: var(--text-secondary);
            display: none;
            background: none;
            border: none;
        }

        .drawer-menu {
            padding: 16px 0;
            flex: 1;
            overflow-y: auto;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 15px;
            transition: var(--transition);
            margin: 0 8px;
            border-radius: var(--border-radius-sm);
        }

        .menu-item.active {
            color: var(--primary);
            background-color: var(--primary-light);
            font-weight: 500;
        }

        .menu-item:hover:not(.active) {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        .drawer-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin 0.3s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .content-header {
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            height: var(--header-height);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .content-header h1 {
            font-size: 20px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .content-body {
            flex: 1;
            padding: 24px;
            background-color: var(--background);
        }

        .greeting {
            margin-bottom: 24px;
            background-color: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-sm);
        }

        .greeting h2 {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .greeting p {
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* Section Cards */
        .section-carousel {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .section-card {
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .section-card:hover {
            transform: translateY(-4px);
        }

        .section-menu {
            position: absolute;
            top: 16px;
            right: 16px;
            color: var(--text-secondary);
            cursor: pointer;
            background: rgba(255, 255, 255, 0.8);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .section-menu:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .section-card h3 {
            margin-bottom: 8px;
            font-size: 17px;
        }

        .section-card p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .section-id {
            display: inline-block;
            background-color: var(--background);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-secondary);
            margin: 8px 0;
            font-family: monospace;
        }

        .section-actions {
            margin-top: 16px;
            display: flex;
            gap: 8px;
        }

        .teacher-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .teacher-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-sm);
        }

        .empty-state i {
            font-size: 48px;
            color: var(--text-tertiary);
            margin-bottom: 16px;
        }

        .empty-state h3 {
            margin-bottom: 8px;
        }

        .empty-state p {
            margin-bottom: 16px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-primary {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .badge-success {
            background-color: var(--success-light);
            color: var(--success);
        }

        .badge-warning {
            background-color: var(--warning-light);
            color: var(--warning);
        }

        .badge-danger {
            background-color: var(--error-light);
            color: var(--error);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: var(--box-shadow);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 1;
        }

        .modal-header h2 {
            font-size: 20px;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            position: sticky;
            bottom: 0;
            background-color: white;
        }

        /* QR Code */
        .qr-code-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .qr-code {
            display: inline-block;
            background-color: white;
            padding: 16px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .data-table th {
            text-align: left;
            padding: 12px 16px;
            background-color: var(--background);
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .drawer {
                transform: translateX(-100%);
            }

            .drawer.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .auth-card {
                padding: 30px;
            }

            .section-carousel {
                grid-template-columns: 1fr;
            }

            .modal {
                margin: 10px;
                max-height: 80vh;
            }

            .content-body {
                padding: 16px;
            }
        }

        @media (max-width: 576px) {
            .auth-card {
                padding: 24px;
            }

            .header-actions {
                flex-direction: column;
                align-items: flex-end;
            }

            .section-actions {
                flex-direction: column;
            }

            .modal-footer {
                flex-direction: column-reverse;
                gap: 8px;
            }

            .modal-footer .button {
                width: 100%;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        /* Utility Classes */
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mt-6 { margin-top: 24px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-secondary); }
        .d-flex { display: flex; }
        .align-items-center { align-items: center; }
        .justify-content-between { justify-content: space-between; }
        .w-100 { width: 100%; }
        .animated { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Firebase and QR Code Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDFBb1l7GHsPbCMT9_XI6Lqc88dxaAydTQ",
            authDomain: "lite-50af2.firebaseapp.com",
            databaseURL: "https://lite-50af2-default-rtdb.firebaseio.com",
            projectId: "lite-50af2",
            storageBucket: "lite-50af2.appspot.com",
            messagingSenderId: "259126907909",
            appId: "1:259126907909:web:9bde95a07abf54be42f86c",
            measurementId: "G-YH5ET7LGS8"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // App State
        let currentUser = null;
        let userRole = null;
        let currentView = 'auth';
        let sections = [];
        let students = [];
        let attendanceSessions = [];
        let activeSession = null;
        let activeSection = null;
        let geolocationPermission = null;

        // DOM Elements
        const appContainer = document.getElementById('app');

        // Initialize the app
        function initApp() {
            renderAuthScreen();
            setupAuthStateListener();
            checkGeolocationPermission();
        }

        // Check geolocation permission state
        function checkGeolocationPermission() {
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' })
                    .then(permissionStatus => {
                        geolocationPermission = permissionStatus.state;
                        permissionStatus.onchange = () => {
                            geolocationPermission = permissionStatus.state;
                        };
                    })
                    .catch(() => {
                        geolocationPermission = 'prompt';
                    });
            } else {
                geolocationPermission = 'prompt';
            }
        }

        // Auth State Listener
        function setupAuthStateListener() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await fetchUserData();
                    renderDashboard();
                } else {
                    currentUser = null;
                    userRole = null;
                    renderAuthScreen();
                }
            });
        }

        // Fetch User Data
        async function fetchUserData() {
            try {
                showLoading('Loading your data...');
                
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userRole = userDoc.data().role;

                    if (userRole === 'teacher') {
                        const sectionsSnapshot = await db.collection('sections')
                            .where('teacherId', '==', currentUser.uid)
                            .get();
                        sections = sectionsSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));

                        // Fetch students for each section
                        const studentsPromises = sections.map(async section => {
                            const studentsSnapshot = await db.collection('users')
                                .where('sections', 'array-contains', section.id)
                                .where('role', '==', 'student')
                                .get();
                            return studentsSnapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                        });

                        const studentsArrays = await Promise.all(studentsPromises);
                        students = studentsArrays.flat();
                    } else if (userRole === 'student') {
                        const userData = userDoc.data();
                        sections = [];

                        if (userData.sections && userData.sections.length > 0) {
                            const sectionsSnapshot = await db.collection('sections')
                                .where(firebase.firestore.FieldPath.documentId(), 'in', userData.sections)
                                .get();
                            sections = sectionsSnapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                        }
                    }
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                showError('Failed to fetch user data. Please refresh the page to try again.');
                console.error('Error fetching user data:', error);
            }
        }

        // Render Auth Screen
        function renderAuthScreen() {
            currentView = 'auth';
            appContainer.innerHTML = `
                <div class="auth-container">
                    <div class="auth-card card">
                        <div class="auth-header">
                            <div class="auth-logo">NC</div>
                            <h1>NearCheck Lite</h1>
                            <p>Smart geolocation-based attendance system for educators and students</p>
                        </div>
                        <div id="auth-content"></div>
                    </div>
                </div>
            `;

            renderRoleSelection();
        }

        // Render Role Selection
        function renderRoleSelection() {
            const authContent = document.getElementById('auth-content');
            authContent.innerHTML = `
                <div class="role-selector">
                    <button class="role-button" id="teacher-role-btn" aria-label="I'm a Teacher">
                        <span>I'm a Teacher</span>
                        <i class="fas fa-chalkboard-teacher" aria-hidden="true"></i>
                    </button>
                    <button class="role-button" id="student-role-btn" aria-label="I'm a Student">
                        <span>I'm a Student</span>
                        <i class="fas fa-user-graduate" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="auth-footer">
                    Already have an account? <a href="#" id="sign-in-link">Sign in</a>
                </div>
            `;

            document.getElementById('teacher-role-btn').addEventListener('click', () => renderSignUpForm('teacher'));
            document.getElementById('student-role-btn').addEventListener('click', () => renderSignUpForm('student'));
            document.getElementById('sign-in-link').addEventListener('click', (e) => {
                e.preventDefault();
                renderSignInForm();
            });
        }

        // Render Sign Up Form
        function renderSignUpForm(role) {
            const authContent = document.getElementById('auth-content');

            if (role === 'teacher') {
                authContent.innerHTML = `
                    <form id="signup-form">
                        <div class="input-group">
                            <label for="fullname">Full Name</label>
                            <input type="text" id="fullname" required aria-required="true">
                        </div>
                        <div class="input-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" required aria-required="true">
                        </div>
                        <div class="input-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" required minlength="6" aria-required="true">
                            <p class="input-hint">Minimum 6 characters</p>
                        </div>
                        <div class="input-group">
                            <label for="confirm-password">Confirm Password</label>
                            <input type="password" id="confirm-password" required minlength="6" aria-required="true">
                        </div>
                        <div class="input-group">
                            <label for="birthdate">Birthdate (Must be 20+)</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="birthdate-day" placeholder="DD" maxlength="2" style="flex: 1;" pattern="[0-9]*" inputmode="numeric">
                                <input type="text" id="birthdate-month" placeholder="MM" maxlength="2" style="flex: 1;" pattern="[0-9]*" inputmode="numeric">
                                <input type="text" id="birthdate-year" placeholder="YYYY" maxlength="4" style="flex: 2;" pattern="[0-9]*" inputmode="numeric">
                            </div>
                        </div>
                        <button type="submit" class="button button-primary w-100 mt-4">Create Account</button>
                    </form>
                    <div class="auth-footer">
                        Already have an account? <a href="#" id="sign-in-link">Sign in</a>
                    </div>
                `;

                // Add input masking and auto-tab for birthdate
                setupDateInputs();
            } else {
                // Student sign up
                authContent.innerHTML = `
                    <form id="signup-form">
                        <div class="input-group">
                            <label for="fullname">Full Name</label>
                            <input type="text" id="fullname" required aria-required="true">
                        </div>
                        <div class="input-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" required aria-required="true">
                        </div>
                        <div class="input-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" required minlength="6" aria-required="true">
                            <p class="input-hint">Minimum 6 characters</p>
                        </div>
                        <div class="input-group">
                            <label for="confirm-password">Confirm Password</label>
                            <input type="password" id="confirm-password" required minlength="6" aria-required="true">
                        </div>
                        <div class="input-group">
                            <label for="section-id">Section ID (optional)</label>
                            <input type="text" id="section-id" placeholder="Provided by your teacher">
                        </div>
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="age-confirm" required aria-required="true"> 
                                I confirm I'm 13 years or older
                            </label>
                        </div>
                        <button type="submit" class="button button-primary w-100 mt-4">Continue</button>
                    </form>
                    <div class="auth-footer">
                        Already have an account? <a href="#" id="sign-in-link">Sign in</a>
                    </div>
                `;

                // Try to get section ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const sectionId = urlParams.get('sectionid');
                if (sectionId) {
                    document.getElementById('section-id').value = sectionId;
                }
            }

            document.getElementById('signup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleSignUp(role);
            });

            document.getElementById('sign-in-link').addEventListener('click', (e) => {
                e.preventDefault();
                renderSignInForm();
            });
        }

        // Helper function for date input formatting
        function setupDateInputs() {
            const dayInput = document.getElementById('birthdate-day');
            const monthInput = document.getElementById('birthdate-month');
            const yearInput = document.getElementById('birthdate-year');

            // Auto-tab between fields
            dayInput.addEventListener('input', function() {
                if (this.value.length === 2) {
                    monthInput.focus();
                }
            });

            monthInput.addEventListener('input', function() {
                if (this.value.length === 2) {
                    yearInput.focus();
                }
            });

            // Only allow numbers
            [dayInput, monthInput, yearInput].forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key < '0' || e.key > '9') {
                        e.preventDefault();
                    }
                });

                // Prevent paste of non-numeric values
                input.addEventListener('paste', function(e) {
                    const pasteData = e.clipboardData.getData('text');
                    if (!/^\d+$/.test(pasteData)) {
                        e.preventDefault();
                    }
                });
            });
        }

        // Render Sign In Form
        function renderSignInForm() {
            const authContent = document.getElementById('auth-content');
            authContent.innerHTML = `
                <form id="signin-form">
                    <div class="input-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" required aria-required="true">
                    </div>
                    <div class="input-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required aria-required="true">
                    </div>
                    <div class="input-group">
                        <a href="#" id="forgot-password" style="font-size: 14px; text-align: right; display: block;">Forgot password?</a>
                    </div>
                    <button type="submit" class="button button-primary w-100">Sign In</button>
                </form>
                <div class="auth-footer">
                    New to NearCheck? <a href="#" id="sign-up-link">Sign up</a>
                </div>
            `;

            document.getElementById('signin-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleSignIn();
            });

            document.getElementById('sign-up-link').addEventListener('click', (e) => {
                e.preventDefault();
                renderRoleSelection();
            });

            document.getElementById('forgot-password').addEventListener('click', (e) => {
                e.preventDefault();
                showForgotPasswordModal();
            });
        }

        // Handle Sign Up
        async function handleSignUp(role) {
            const fullName = document.getElementById('fullname').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!fullName || !email || !password || !confirmPassword) {
                showError('Please fill all required fields');
                return;
            }

            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            // Additional validation for teachers (age verification)
            if (role === 'teacher') {
                const day = document.getElementById('birthdate-day').value;
                const month = document.getElementById('birthdate-month').value;
                const year = document.getElementById('birthdate-year').value;

                if (!day || !month || !year) {
                    showError('Please enter your complete birthdate');
                    return;
                }

                // Validate date
                const birthDate = new Date(`${year}-${month}-${day}`);
                if (isNaN(birthDate.getTime())) {
                    showError('Please enter a valid date');
                    return;
                }

                // Calculate age
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }

                if (age < 20) {
                    showError('You must be at least 20 years old to register as a teacher');
                    return;
                }
            }

            // Additional validation for students (age confirmation)
            if (role === 'student' && !document.getElementById('age-confirm').checked) {
                showError('You must confirm you are at least 13 years old');
                return;
            }

            try {
                showLoading('Creating account...');

                // Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Save additional user data in Firestore
                const userData = {
                    fullName,
                    email,
                    role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (role === 'student') {
                    const sectionId = document.getElementById('section-id').value.trim();
                    if (sectionId) {
                        userData.sections = [sectionId];
                    } else {
                        userData.sections = [];
                    }
                }

                await db.collection('users').doc(user.uid).set(userData);

                // Update user profile with display name
                await user.updateProfile({
                    displayName: fullName
                });

                hideLoading();

                // Redirect to dashboard
                currentUser = user;
                userRole = role;
                await fetchUserData();
                renderDashboard();
            } catch (error) {
                hideLoading();
                if (error.code === 'auth/email-already-in-use') {
                    showError('This email is already registered. Please sign in instead.');
                } else if (error.code === 'auth/weak-password') {
                    showError('Password should be at least 6 characters');
                } else if (error.code === 'auth/invalid-email') {
                    showError('Please enter a valid email address');
                } else {
                    showError(error.message || 'Account creation failed. Please try again.');
                }
            }
        }

        // Handle Sign In
        async function handleSignIn() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }

            try {
                showLoading('Signing in...');
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // Update current user with display name if available
                currentUser = userCredential.user;
                
                hideLoading();
            } catch (error) {
                hideLoading();
                if (error.code === 'auth/user-not-found') {
                    showError('No account found with this email. Please sign up.');
                } else if (error.code === 'auth/wrong-password') {
                    showError('Incorrect password. Please try again.');
                } else if (error.code === 'auth/too-many-requests') {
                    showError('Too many failed attempts. Please try again later or reset your password.');
                } else {
                    showError(error.message || 'Sign in failed. Please try again.');
                }
            }
        }

        // Render Dashboard
        function renderDashboard() {
            currentView = 'dashboard';
            appContainer.innerHTML = `
                <div class="dashboard">
                    <div class="drawer">
                        <div class="drawer-header">
                            <button class="menu-toggle" id="drawer-toggle" aria-label="Toggle menu">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h2>NearCheck</h2>
                        </div>
                        <div class="drawer-menu">
                            <a href="#" class="menu-item active" data-view="dashboard" aria-current="page">
                                <i class="fas fa-home"></i>
                                <span>Dashboard</span>
                            </a>
                            <a href="#" class="menu-item" data-view="sections">
                                <i class="fas fa-layer-group"></i>
                                <span>My Sections</span>
                            </a>
                            ${userRole === 'teacher' ? `
                                <a href="#" class="menu-item" data-view="students">
                                    <i class="fas fa-users"></i>
                                    <span>My Students</span>
                                </a>
                                <a href="#" class="menu-item" data-view="reports">
                                    <i class="fas fa-chart-bar"></i>
                                    <span>Attendance Reports</span>
                                </a>
                            ` : ''}
                            <a href="#" class="menu-item" data-view="permissions">
                                <i class="fas fa-shield-alt"></i>
                                <span>Permissions</span>
                            </a>
                            <a href="#" class="menu-item" data-view="account">
                                <i class="fas fa-user"></i>
                                <span>Account</span>
                            </a>
                        </div>
                        <div class="drawer-footer">
                            <button class="button button-danger" id="sign-out-btn">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Sign Out</span>
                            </button>
                        </div>
                    </div>
                    <div class="main-content">
                        <div class="content-header">
                            <h1>Dashboard</h1>
                            <button class="menu-toggle" id="mobile-drawer-toggle" aria-label="Toggle menu">
                                <i class="fas fa-bars"></i>
                            </button>
                        </div>
                        <div class="content-body" id="content-area"></div>
                    </div>
                </div>
            `;

            // Set up event listeners
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = item.getAttribute('data-view');
                    setActiveMenuItem(view);
                    renderContent(view);
                });
            });

            document.getElementById('sign-out-btn').addEventListener('click', () => {
                auth.signOut();
            });

            document.getElementById('drawer-toggle').addEventListener('click', toggleDrawer);
            document.getElementById('mobile-drawer-toggle').addEventListener('click', toggleDrawer);

            // Initialize responsive drawer state
            updateDrawerState();

            // Render initial content
            renderContent('dashboard');
        }

        // Toggle drawer visibility
        function toggleDrawer() {
            document.querySelector('.drawer').classList.toggle('open');
        }

        // Update drawer state based on screen size
        function updateDrawerState() {
            const drawer = document.querySelector('.drawer');
            if (window.innerWidth >= 992) {
                drawer.classList.add('open');
            } else {
                drawer.classList.remove('open');
            }
        }

        // Set Active Menu Item
        function setActiveMenuItem(view) {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                item.removeAttribute('aria-current');
                if (item.getAttribute('data-view') === view) {
                    item.classList.add('active');
                    item.setAttribute('aria-current', 'page');
                }
            });
        }

        // Render Content
        function renderContent(view) {
            const contentArea = document.getElementById('content-area');
            if (!contentArea) return;

            // Update page title
            document.querySelector('.content-header h1').textContent = view.charAt(0).toUpperCase() + view.slice(1).replace(/-/g, ' ');

            switch (view) {
                case 'dashboard':
                    renderDashboardContent();
                    break;
                case 'sections':
                    renderSectionsContent();
                    break;
                case 'students':
                    renderStudentsContent();
                    break;
                case 'reports':
                    renderReportsContent();
                    break;
                case 'permissions':
                    renderPermissionsContent();
                    break;
                case 'account':
                    renderAccountContent();
                    break;
                default:
                    renderDashboardContent();
            }
        }

        // Render Dashboard Content
        function renderDashboardContent() {
            const now = new Date();
            const hours = now.getHours();
            let greeting = 'Good morning';

            if (hours >= 12 && hours < 17) {
                greeting = 'Good afternoon';
            } else if (hours >= 17 || hours < 5) {
                greeting = 'Good evening';
            }

            const firstName = currentUser.displayName ? currentUser.displayName.split(' ')[0] : 'User';

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="greeting">
                    <h2>${greeting}, ${firstName}</h2>
                    <p>${now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
                
                ${userRole === 'teacher' ? `
                    <div class="header-actions" style="margin-bottom: 24px;">
                        <button class="button button-primary" id="create-section-btn">
                            <i class="fas fa-plus"></i>
                            <span>Create Section</span>
                        </button>
                    </div>
                ` : ''}
                
                ${sections.length > 0 ? `
                    <div class="section-carousel">
                        ${sections.map(section => `
                            <div class="section-card card" data-section-id="${section.id}">
                                <div class="section-menu" aria-label="Section options">
                                    <i class="fas fa-ellipsis-v"></i>
                                </div>
                                <h3>${section.name}</h3>
                                <p>${section.subject}</p>
                                <span class="section-id">${section.id}</span>
                                ${userRole === 'teacher' ? `
                                    <p>${section.students ? section.students.length : 0} students</p>
                                    <div class="section-actions">
                                        <button class="button button-primary start-session-btn" aria-label="Start attendance session for ${section.name}">
                                            Start Session
                                        </button>
                                    </div>
                                ` : `
                                    <div class="teacher-info">
                                        <div class="teacher-avatar">${section.teacherName ? section.teacherName.charAt(0) : 'T'}</div>
                                        <span>${section.teacherName || 'Teacher'}</span>
                                    </div>
                                    <div class="section-actions">
                                        <button class="button button-primary checkin-btn" aria-label="Check in to ${section.name}">
                                            Check In
                                        </button>
                                    </div>
                                `}
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="empty-state">
                        <i class="fas fa-layer-group"></i>
                        <h3>No Sections Found</h3>
                        <p>${userRole === 'teacher' ? 'Create your first section to get started with attendance tracking' : 'Join a section using an invitation link from your teacher to begin checking in'}</p>
                        ${userRole === 'teacher' ? `
                            <button class="button button-primary mt-4" id="create-section-btn-2">
                                Create Section
                            </button>
                        ` : `
                            <button class="button button-primary mt-4" id="join-section-btn">
                                Join Section
                            </button>
                        `}
                    </div>
                `}
            `;

            // Set up event listeners
            if (userRole === 'teacher') {
                const createSectionBtn = document.getElementById('create-section-btn') || document.getElementById('create-section-btn-2');
                if (createSectionBtn) {
                    createSectionBtn.addEventListener('click', () => showCreateSectionModal());
                }

                document.querySelectorAll('.start-session-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const sectionCard = e.target.closest('.section-card');
                        const sectionId = sectionCard.getAttribute('data-section-id');
                        const section = sections.find(s => s.id === sectionId);
                        showStartSessionModal(section);
                    });
                });
            } else {
                const joinSectionBtn = document.getElementById('join-section-btn');
                if (joinSectionBtn) {
                    joinSectionBtn.addEventListener('click', () => renderSectionsContent());
                }

                document.querySelectorAll('.checkin-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const sectionCard = e.target.closest('.section-card');
                        const sectionId = sectionCard.getAttribute('data-section-id');
                        const section = sections.find(s => s.id === sectionId);
                        handleStudentCheckIn(section);
                    });
                });
            }
        }

        // Render Sections Content
        function renderSectionsContent() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                ${userRole === 'teacher' ? `
                    <div class="header-actions" style="margin-bottom: 24px;">
                        <button class="button button-primary" id="create-section-btn">
                            <i class="fas fa-plus"></i>
                            <span>Create Section</span>
                        </button>
                    </div>
                ` : ''}
                
                ${sections.length > 0 ? `
                    <div class="section-list">
                        ${sections.map(section => `
                            <div class="card mb-4" data-section-id="${section.id}">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h3>${section.name}</h3>
                                    <div class="section-menu" aria-label="Section options">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </div>
                                </div>
                                <p class="text-muted">${section.subject}</p>
                                <p><strong>Schedule:</strong> ${section.schedule}</p>
                                <p><strong>Section ID:</strong> <span class="section-id">${section.id}</span></p>
                                
                                ${userRole === 'teacher' ? `
                                    <div class="section-actions mt-4" style="display: flex; gap: 8px;">
                                        <button class="button button-primary invite-students-btn">
                                            <i class="fas fa-user-plus"></i>
                                            <span>Invite Students</span>
                                        </button>
                                        <button class="button button-secondary manage-students-btn">
                                            <i class="fas fa-users-cog"></i>
                                            <span>Manage Students</span>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="empty-state">
                        <i class="fas fa-layer-group"></i>
                        <h3>No Sections Found</h3>
                        <p>${userRole === 'teacher' ? 'Create your first section to start managing attendance' : 'Join a section to begin checking in to classes'}</p>
                        ${userRole === 'teacher' ? `
                            <button class="button button-primary mt-4" id="create-section-btn-2">
                                Create Section
                            </button>
                        ` : `
                            <div class="input-group mt-4">
                                <input type="text" id="join-section-input" placeholder="Enter Section ID">
                                <button class="button button-primary w-100" id="join-section-btn">
                                    Join Section
                                </button>
                            </div>
                            <p class="text-center text-muted mt-2">Get the section ID from your teacher</p>
                        `}
                    </div>
                `}
            `;

            // Set up event listeners
            if (userRole === 'teacher') {
                const createSectionBtn = document.getElementById('create-section-btn') || document.getElementById('create-section-btn-2');
                if (createSectionBtn) {
                    createSectionBtn.addEventListener('click', () => showCreateSectionModal());
                }

                document.querySelectorAll('.invite-students-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const sectionCard = e.target.closest('.card');
                        const sectionId = sectionCard.getAttribute('data-section-id');
                        const section = sections.find(s => s.id === sectionId);
                        showInviteStudentsModal(section);
                    });
                });

                document.querySelectorAll('.manage-students-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const sectionCard = e.target.closest('.card');
                        const sectionId = sectionCard.getAttribute('data-section-id');
                        const section = sections.find(s => s.id === sectionId);
                        showManageStudentsModal(section);
                    });
                });
            } else {
                const joinSectionBtn = document.getElementById('join-section-btn');
                if (joinSectionBtn) {
                    joinSectionBtn.addEventListener('click', async () => {
                        const sectionId = document.getElementById('join-section-input').value.trim();
                        if (!sectionId) {
                            showError('Please enter a section ID');
                            return;
                        }

                        try {
                            showLoading('Joining section...');

                            // Verify section exists
                            const sectionDoc = await db.collection('sections').doc(sectionId).get();
                            if (!sectionDoc.exists) {
                                throw new Error('Section not found. Please check the ID and try again.');
                            }

                            // Add section to user's sections array
                            await db.collection('users').doc(currentUser.uid).update({
                                sections: firebase.firestore.FieldValue.arrayUnion(sectionId)
                            });

                            // Refresh data
                            await fetchUserData();
                            hideLoading();
                            renderContent('sections');
                        } catch (error) {
                            hideLoading();
                            showError(error.message);
                        }
                    });
                }
            }
        }

        // Render Students Content (Teacher only)
        function renderStudentsContent() {
            if (userRole !== 'teacher') return;

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                ${students.length > 0 ? `
                    <div class="students-list">
                        ${students.map(student => `
                            <div class="card mb-4" data-student-id="${student.id}">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h3>${student.fullName}</h3>
                                    <div class="student-menu" aria-label="Student options">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </div>
                                </div>
                                <p class="text-muted">${student.email}</p>
                                <p>Sections: ${student.sections ? student.sections.length : 0}</p>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No Students Found</h3>
                        <p>Students will appear here once they join your sections. Invite students to your sections to get started.</p>
                        <button class="button button-primary mt-4" id="invite-students-btn">
                            Invite Students
                        </button>
                    </div>
                `}
            `;

            const inviteStudentsBtn = document.getElementById('invite-students-btn');
            if (inviteStudentsBtn) {
                inviteStudentsBtn.addEventListener('click', () => {
                    if (sections.length > 0) {
                        renderContent('sections');
                    } else {
                        showCreateSectionModal();
                    }
                });
            }
        }

        // Render Reports Content (Teacher only)
        function renderReportsContent() {
            if (userRole !== 'teacher') return;

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="header-actions" style="margin-bottom: 24px;">
                    <button class="button button-primary" id="export-reports-btn">
                        <i class="fas fa-file-export"></i>
                        <span>Export</span>
                    </button>
                </div>
                
                <div class="reports-filters mb-4">
                    <div style="display: flex; gap: 12px;">
                        <select class="input-group" id="report-section-filter">
                            <option value="">All Sections</option>
                            ${sections.map(section => `
                                <option value="${section.id}">${section.name}</option>
                            `).join('')}
                        </select>
                        <select class="input-group" id="report-time-filter">
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                </div>
                
                <div class="reports-summary card mb-4">
                    <h3>Summary</h3>
                    <div style="display: flex; justify-content: space-between; margin-top: 16px;">
                        <div class="summary-item">
                            <p>Total Students</p>
                            <h2>${students.length}</h2>
                        </div>
                        <div class="summary-item">
                            <p>Average Attendance</p>
                            <h2>85%</h2>
                        </div>
                        <div class="summary-item">
                            <p>Sessions</p>
                            <h2>12</h2>
                        </div>
                    </div>
                </div>
                
                <div class="reports-chart card" style="padding: 20px; height: 300px;">
                    <h3>Attendance Trend</h3>
                    <div style="height: 200px; display: flex; align-items: center; justify-content: center;">
                        <p>Chart will be displayed here</p>
                    </div>
                </div>
            `;

            document.getElementById('export-reports-btn').addEventListener('click', () => {
                showExportReportsModal();
            });

            // Show/hide custom date range inputs
            document.getElementById('report-time-filter').addEventListener('change', (e) => {
                const customRangeGroup = document.getElementById('custom-range-group');
                if (e.target.value === 'custom' && customRangeGroup) {
                    customRangeGroup.style.display = 'block';
                } else if (customRangeGroup) {
                    customRangeGroup.style.display = 'none';
                }
            });
        }

        // Render Permissions Content
        function renderPermissionsContent() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="card mb-4">
                    <h3 class="mb-4">Geolocation Access</h3>
                    <p>NearCheck Lite requires geolocation access to verify your location when checking in to classes.</p>
                    
                    <div class="permission-status mt-4">
                        <h4>Current Status:</h4>
                        <div id="geolocation-status" class="mt-2">
                            ${geolocationPermission === 'granted' ? `
                                <span class="badge badge-success">
                                    <i class="fas fa-check-circle"></i> Granted
                                </span>
                                <p class="text-muted mt-2">You've granted location access. You can check in to classes.</p>
                            ` : geolocationPermission === 'denied' ? `
                                <span class="badge badge-danger">
                                    <i class="fas fa-times-circle"></i> Denied
                                </span>
                                <p class="text-muted mt-2">You've denied location access. You won't be able to check in to classes.</p>
                                <button class="button button-primary mt-2" id="open-settings-btn">
                                    Open Browser Settings
                                </button>
                            ` : `
                                <span class="badge badge-warning">
                                    <i class="fas fa-question-circle"></i> Not Determined
                                </span>
                                <p class="text-muted mt-2">Location access hasn't been requested yet. It will be requested when you try to check in.</p>
                            `}
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="mb-4">How Location Works</h3>
                    <p>When you check in to a class, NearCheck Lite will:</p>
                    <ul style="margin-top: 8px; padding-left: 20px;">
                        <li>Request permission to access your location (if not already granted)</li>
                        <li>Compare your location with the teacher's location</li>
                        <li>Verify you're within the allowed distance (typically 50-100 meters)</li>
                        <li>Record your attendance with timestamp and location data</li>
                    </ul>
                    <p class="mt-4">Your location data is only used for attendance verification and is not stored permanently.</p>
                </div>
            `;

            const openSettingsBtn = document.getElementById('open-settings-btn');
            if (openSettingsBtn) {
                openSettingsBtn.addEventListener('click', () => {
                    // This is a best-effort attempt to help users change settings
                    // Note: There's no standard way to open browser settings, this is just a guide
                    showModal({
                        title: 'Change Location Settings',
                        body: `
                            <p>To enable location access for NearCheck Lite:</p>
                            <ol style="margin-top: 8px; padding-left: 20px;">
                                <li>Open your browser settings</li>
                                <li>Navigate to Site Settings or Permissions</li>
                                <li>Find NearCheck Lite in the list of sites</li>
                                <li>Change the Location permission to "Allow"</li>
                                <li>Refresh this page</li>
                            </ol>
                            <p class="mt-4">The exact steps vary depending on your browser and device.</p>
                        `,
                        buttons: [
                            { text: 'OK', class: 'button-primary', action: 'close' }
                        ]
                    });
                });
            }
        }

        // Render Account Content
        function renderAccountContent() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="card mb-4">
                    <h3 class="mb-4">Personal Information</h3>
                    <div class="input-group">
                        <label for="account-name">Full Name</label>
                        <input type="text" id="account-name" value="${currentUser.displayName || ''}">
                    </div>
                    <div class="input-group">
                        <label for="account-email">Email</label>
                        <input type="email" id="account-email" value="${currentUser.email}" disabled>
                    </div>
                    <button class="button button-primary" id="save-account-btn">Save Changes</button>
                </div>
                
                <div class="card mb-4">
                    <h3 class="mb-4">Security</h3>
                    <button class="button button-secondary" id="change-password-btn">Change Password</button>
                </div>
                
                <div class="card">
                    <h3 class="mb-4">Danger Zone</h3>
                    <p class="mb-4">Deleting your account will permanently remove all your data from our systems.</p>
                    <button class="button button-danger" id="delete-account-btn">Delete Account</button>
                </div>
            `;

            document.getElementById('save-account-btn').addEventListener('click', async () => {
                const newName = document.getElementById('account-name').value.trim();

                if (!newName) {
                    showError('Please enter your name');
                    return;
                }

                try {
                    showLoading('Updating account...');
                    await currentUser.updateProfile({
                        displayName: newName
                    });

                    await db.collection('users').doc(currentUser.uid).update({
                        fullName: newName
                    });

                    hideLoading();
                    showSuccess('Account updated successfully');
                } catch (error) {
                    hideLoading();
                    showError(error.message || 'Failed to update account');
                }
            });

            document.getElementById('change-password-btn').addEventListener('click', () => {
                showChangePasswordModal();
            });

            document.getElementById('delete-account-btn').addEventListener('click', () => {
                showDeleteAccountModal();
            });
        }

        // Show Create Section Modal
        function showCreateSectionModal() {
            showModal({
                title: 'Create New Section',
                body: `
                    <form id="create-section-form">
                        <div class="input-group">
                            <label for="section-name">Section Name</label>
                            <input type="text" id="section-name" required placeholder="e.g. Computer Science 101">
                        </div>
                        <div class="input-group">
                            <label for="section-subject">Subject</label>
                            <input type="text" id="section-subject" required placeholder="e.g. Computer Science">
                        </div>
                        <div class="input-group">
                            <label for="section-schedule">Schedule</label>
                            <input type="text" id="section-schedule" placeholder="e.g. Mon, Wed, Fri 9:00-10:30 AM" required>
                        </div>
                        <div class="input-group">
                            <label for="section-range">Check-in Range (meters)</label>
                            <input type="number" id="section-range" value="50" min="5" max="150" required>
                            <p class="input-hint">Students must be within this distance to check in</p>
                        </div>
                    </form>
                `,
                buttons: [
                    { text: 'Cancel', class: 'button-secondary', action: 'close' },
                    { text: 'Create Section', class: 'button-primary', action: async () => {
                        const name = document.getElementById('section-name').value.trim();
                        const subject = document.getElementById('section-subject').value.trim();
                        const schedule = document.getElementById('section-schedule').value.trim();
                        const range = parseInt(document.getElementById('section-range').value);

                        if (!name || !subject || !schedule || !range) {
                            showError('Please fill all fields');
                            return false;
                        }

                        try {
                            showLoading('Creating section...');

                            // Get teacher's current location
                            const position = await getCurrentPositionWithPermission();

                            // Create section in Firestore
                            const sectionRef = await db.collection('sections').add({
                                name,
                                subject,
                                schedule,
                                checkInRange: range,
                                teacherId: currentUser.uid,
                                teacherName: currentUser.displayName || 'Teacher',
                                teacherLocation: new firebase.firestore.GeoPoint(position.coords.latitude, position.coords.longitude),
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                students: []
                            });

                            // Update local state
                            sections.push({
                                id: sectionRef.id,
                                name,
                                subject,
                                schedule,
                                checkInRange: range,
                                teacherId: currentUser.uid
                            });

                            hideLoading();
                            showSuccess('Section created successfully');
                            renderContent('sections');
                            return true;
                        } catch (error) {
                            hideLoading();
                            showError(error.message || 'Failed to create section');
                            return false;
                        }
                    }}
                ]
            });
        }

        // Show Start Session Modal
        function showStartSessionModal(section) {
            showModal({
                title: `Start Attendance Session - ${section.name}`,
                body: `
                    <p>You're about to start an attendance session for <strong>${section.name}</strong>.</p>
                    
                    <div class="input-group mt-4">
                        <label for="session-duration">Session Duration (minutes)</label>
                        <input type="number" id="session-duration" value="15" min="1" max="120">
                    </div>
                    
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="auto-end-checkbox" checked> Auto-end session after duration
                        </label>
                    </div>
                    
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="require-location-checkbox" checked> Require student location
                        </label>
                    </div>
                `,
                buttons: [
                    { text: 'Cancel', class: 'button-secondary', action: 'close' },
                    { text: 'Start Session', class: 'button-primary', action: async () => {
                        const duration = parseInt(document.getElementById('session-duration').value);
                        const autoEnd = document.getElementById('auto-end-checkbox').checked;
                        const requireLocation = document.getElementById('require-location-checkbox').checked;

                        if (!duration || duration < 1) {
                            showError('Please enter a valid duration');
                            return false;
                        }

                        try {
                            showLoading('Starting session...');

                            // Get teacher's current location
                            const position = await getCurrentPositionWithPermission();

                            // Create session in Firestore
                            const sessionRef = await db.collection('sessions').add({
                                sectionId: section.id,
                                teacherId: currentUser.uid,
                                startTime: firebase.firestore.FieldValue.serverTimestamp(),
                                endTime: null,
                                duration,
                                autoEnd,
                                requireLocation,
                                location: new firebase.firestore.GeoPoint(position.coords.latitude, position.coords.longitude),
                                range: section.checkInRange,
                                status: 'active',
                                attendees: []
                            });

                            // Update local state
                            activeSession = {
                                id: sessionRef.id,
                                sectionId: section.id,
                                startTime: new Date(),
                                duration,
                                autoEnd,
                                status: 'active'
                            };

                            hideLoading();
                            showSuccess('Attendance session started');
                            renderDashboardContent();
                            
                            // If auto-end is enabled, set timeout to end session
                            if (autoEnd) {
                                setTimeout(() => {
                                    endSession(sessionRef.id);
                                }, duration * 60 * 1000);
                            }
                            
                            return true;
                        } catch (error) {
                            hideLoading();
                            showError(error.message || 'Failed to start session');
                            return false;
                        }
                    }}
                ]
            });
        }

        // End Session
        async function endSession(sessionId) {
            try {
                await db.collection('sessions').doc(sessionId).update({
                    status: 'ended',
                    endTime: firebase.firestore.FieldValue.serverTimestamp()
                });

                activeSession = null;
                renderDashboardContent();
                showSuccess('Attendance session ended');
            } catch (error) {
                showError('Failed to end session: ' + error.message);
            }
        }

        // Show Invite Students Modal
        function showInviteStudentsModal(section) {
            const inviteLink = `${window.location.origin}${window.location.pathname}?sectionid=${section.id}`;
            const qr = qrcode(0, 'L');
            qr.addData(inviteLink);
            qr.make();
            const qrSvg = qr.createSvgTag(4);

            showModal({
                title: `Invite Students - ${section.name}`,
                body: `
                    <div class="qr-code-container">
                        <div class="qr-code" id="qr-code">${qrSvg}</div>
                        <p>Scan this QR code to join</p>
                    </div>
                    
                    <div class="input-group mt-4">
                        <label for="invite-link">Invitation Link</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="invite-link" value="${inviteLink}" readonly>
                            <button class="button button-secondary" id="copy-link-btn" aria-label="Copy invitation link">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="section-id">Section ID</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="section-id" value="${section.id}" readonly>
                            <button class="button button-secondary" id="copy-id-btn" aria-label="Copy section ID">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                `,
                buttons: [
                    { text: 'Done', class: 'button-primary', action: 'close' }
                ],
                onRender: (modal) => {
                    modal.querySelector('#copy-link-btn').addEventListener('click', () => {
                        const linkInput = document.getElementById('invite-link');
                        linkInput.select();
                        document.execCommand('copy');
                        showSuccess('Link copied to clipboard');
                    });

                    modal.querySelector('#copy-id-btn').addEventListener('click', () => {
                        const idInput = document.getElementById('section-id');
                        idInput.select();
                        document.execCommand('copy');
                        showSuccess('Section ID copied to clipboard');
                    });
                }
            });
        }

        // Show Manage Students Modal
        function showManageStudentsModal(section) {
            showModal({
                title: `Manage Students - ${section.name}`,
                body: `
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-list">
                                <tr>
                                    <td colspan="3" style="text-align: center; padding: 16px;">Loading students...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `,
                buttons: [
                    { text: 'Done', class: 'button-primary', action: 'close' }
                ],
                onRender: async (modal) => {
                    const studentsList = modal.querySelector('#students-list');

                    try {
                        const querySnapshot = await db.collection('users')
                            .where('sections', 'array-contains', section.id)
                            .where('role', '==', 'student')
                            .get();

                        studentsList.innerHTML = '';

                        if (querySnapshot.empty) {
                            studentsList.innerHTML = `
                                <tr>
                                    <td colspan="3" style="text-align: center; padding: 16px;">No students found in this section</td>
                                </tr>
                            `;
                            return;
                        }

                        querySnapshot.forEach((doc) => {
                            const student = doc.data();
                            studentsList.innerHTML += `
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center" style="gap: 8px;">
                                            <div style="width: 32px; height: 32px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center;">
                                                ${student.fullName ? student.fullName.charAt(0) : 'S'}
                                            </div>
                                            <div>
                                                <div style="font-weight: 500;">${student.fullName || 'Student'}</div>
                                                <div style="font-size: 12px; color: var(--text-tertiary);">${student.email}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge badge-success">Active</span>
                                    </td>
                                    <td>
                                        <button class="button button-danger" style="padding: 4px 8px; font-size: 12px;" data-student-id="${doc.id}">
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });

                        // Set up event listeners for remove buttons
                        modal.querySelectorAll('button[data-student-id]').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const studentId = e.target.getAttribute('data-student-id');
                                if (confirm('Are you sure you want to remove this student from the section?')) {
                                    try {
                                        showLoading('Removing student...');

                                        // Remove section from student's sections array
                                        await db.collection('users').doc(studentId).update({
                                            sections: firebase.firestore.FieldValue.arrayRemove(section.id)
                                        });

                                        // Refresh the list
                                        showManageStudentsModal(section);
                                        hideLoading();
                                        showSuccess('Student removed from section');
                                    } catch (error) {
                                        hideLoading();
                                        showError('Failed to remove student: ' + error.message);
                                    }
                                }
                            });
                        });
                    } catch (error) {
                        studentsList.innerHTML = `
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 16px; color: var(--error);">Error loading students: ${error.message}</td>
                            </tr>
                        `;
                    }
                }
            });
        }

        // Show Export Reports Modal
        function showExportReportsModal() {
            showModal({
                title: 'Export Attendance Data',
                body: `
                    <div class="input-group">
                        <label for="export-format">Format</label>
                        <select id="export-format">
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                            <option value="pdf">PDF (.pdf)</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="export-time-range">Time Range</label>
                        <select id="export-time-range">
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    
                    <div class="input-group" id="custom-range-group" style="display: none;">
                        <label for="export-start-date">Start Date</label>
                        <input type="date" id="export-start-date">
                        
                        <label for="export-end-date" style="margin-top: 8px;">End Date</label>
                        <input type="date" id="export-end-date">
                    </div>
                    
                    <div class="input-group">
                        <label for="export-section">Section</label>
                        <select id="export-section">
                            <option value="all">All Sections</option>
                            ${sections.map(section => `
                                <option value="${section.id}">${section.name}</option>
                            `).join('')}
                        </select>
                    </div>
                `,
                buttons: [
                    { text: 'Cancel', class: 'button-secondary', action: 'close' },
                    { text: 'Export Data', class: 'button-primary', action: () => {
                        // In a real app, this would generate and download the report
                        // For this demo, we'll just show a success message
                        showSuccess('Export request received. Data will be downloaded shortly.');
                        return true;
                    }}
                ],
                onRender: (modal) => {
                    modal.querySelector('#export-time-range').addEventListener('change', (e) => {
                        const customRangeGroup = modal.querySelector('#custom-range-group');
                        if (e.target.value === 'custom') {
                            customRangeGroup.style.display = 'block';
                        } else {
                            customRangeGroup.style.display = 'none';
                        }
                    });
                }
            });
        }

        // Show Change Password Modal
        function showChangePasswordModal() {
            showModal({
                title: 'Change Password',
                body: `
                    <div class="input-group">
                        <label for="current-password">Current Password</label>
                        <input type="password" id="current-password" required>
                    </div>
                    <div class="input-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" required minlength="6">
                        <p class="input-hint">Minimum 6 characters</p>
                    </div>
                    <div class="input-group">
                        <label for="confirm-new-password">Confirm New Password</label>
                        <input type="password" id="confirm-new-password" required minlength="6">
                    </div>
                `,
                buttons: [
                    { text: 'Cancel', class: 'button-secondary', action: 'close' },
                    { text: 'Change Password', class: 'button-primary', action: async () => {
                        const currentPassword = document.getElementById('current-password').value;
                        const newPassword = document.getElementById('new-password').value;
                        const confirmNewPassword = document.getElementById('confirm-new-password').value;

                        if (!currentPassword || !newPassword || !confirmNewPassword) {
                            showError('Please fill all fields');
                            return false;
                        }

                        if (newPassword !== confirmNewPassword) {
                            showError('New passwords do not match');
                            return false;
                        }

                        if (newPassword.length < 6) {
                            showError('Password must be at least 6 characters');
                            return false;
                        }

                        try {
                            showLoading('Changing password...');

                            // Reauthenticate user
                            const credential = firebase.auth.EmailAuthProvider.credential(
                                currentUser.email,
                                currentPassword
                            );

                            await currentUser.reauthenticateWithCredential(credential);

                            // Update password
                            await currentUser.updatePassword(newPassword);

                            hideLoading();
                            showSuccess('Password changed successfully');
                            return true;
                        } catch (error) {
                            hideLoading();
                            if (error.code === 'auth/wrong-password') {
                                showError('Current password is incorrect');
                            } else {
                                showError(error.message || 'Failed to change password');
                            }
                            return false;
                        }
                    }}
                ]
            });
        }

        // Show Delete Account Modal
        function showDeleteAccountModal() {
            showModal({
                title: 'Delete Account',
                body: `
                    <p>Are you sure you want to delete your account? This action cannot be undone.</p>
                    <p class="mb-4">All your data will be permanently removed from our systems.</p>
                    
                    <div class="input-group">
                        <label for="delete-password">Enter your password to confirm</label>
                        <input type="password" id="delete-password" required>
                    </div>
                `,
                buttons: [
                    { text: 'Cancel', class: 'button-secondary', action: 'close' },
                    { text: 'Delete Account', class: 'button-danger', action: async () => {
                        const password = document.getElementById('delete-password').value;

                        if (!password) {
                            showError('Please enter your password');
                            return false;
                        }

                        try {
                            showLoading('Deleting account...');

                            // Reauthenticate user
                            const credential = firebase.auth.EmailAuthProvider.credential(
                                currentUser.email,
                                password
                            );

                            await currentUser.reauthenticateWithCredential(credential);

                            // Delete user from Firebase Auth
                            await currentUser.delete();

                            // Delete user data from Firestore
                            await db.collection('users').doc(currentUser.uid).delete();

                            hideLoading();
                            showSuccess('Account deleted successfully');
                            
                            // User will be automatically signed out by the auth state listener
                            return true;
                        } catch (error) {
                            hideLoading();
                            if (error.code === 'auth/wrong-password') {
                                showError('Incorrect password');
                            } else {
                                showError(error.message || 'Failed to delete account');
                            }
                            return false;
                        }
                    }}
                ]
            });
        }

        // Show Forgot Password Modal
        function showForgotPasswordModal() {
            showModal({
                title: 'Reset Password',
                body: `
                    <p>Enter your email address and we'll send you a link to reset your password.</p>
                    
                    <div class="input-group mt-4">
                        <label for="reset-email">Email</label>
                        <input type="email" id="reset-email" required>
                    </div>
                `,
                buttons: [
                    { text: 'Cancel', class: 'button-secondary', action: 'close' },
                    { text: 'Send Reset Link', class: 'button-primary', action: async () => {
                        const email = document.getElementById('reset-email').value.trim();

                        if (!email) {
                            showError('Please enter your email address');
                            return false;
                        }

                        try {
                            showLoading('Sending reset link...');
                            await auth.sendPasswordResetEmail(email);
                            hideLoading();
                            showSuccess('Password reset link sent to your email');
                            return true;
                        } catch (error) {
                            hideLoading();
                            if (error.code === 'auth/user-not-found') {
                                showError('No account found with this email');
                            } else {
                                showError(error.message || 'Failed to send reset link');
                            }
                            return false;
                        }
                    }}
                ]
            });
        }

        // Generic Modal Function
        function showModal(options) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2>${options.title}</h2>
                        <button class="close-button" aria-label="Close">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${options.body}
                    </div>
                    <div class="modal-footer">
                        ${options.buttons.map(btn => `
                            <button class="button ${btn.class}" id="${btn.text.toLowerCase().replace(' ', '-')}-btn">
                                ${btn.text}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            setTimeout(() => {
                modal.classList.add('active');
            }, 10);

            // Set up event listeners
            const closeModal = () => {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            };

            modal.querySelector('.close-button').addEventListener('click', closeModal);

            options.buttons.forEach(btn => {
                const button = modal.querySelector(`#${btn.text.toLowerCase().replace(' ', '-')}-btn`);
                if (btn.action === 'close') {
                    button.addEventListener('click', closeModal);
                } else {
                    button.addEventListener('click', async () => {
                        const result = await btn.action();
                        if (result) {
                            closeModal();
                        }
                    });
                }
            });

            // Call onRender callback if provided
            if (options.onRender) {
                options.onRender(modal);
            }

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        // Handle Student Check-In
        async function handleStudentCheckIn(section) {
            try {
                showLoading('Preparing check-in...');

                // Check if there's an active session for this section
                const sessionsSnapshot = await db.collection('sessions')
                    .where('sectionId', '==', section.id)
                    .where('status', '==', 'active')
                    .get();

                if (sessionsSnapshot.empty) {
                    throw new Error('No active session found for this section');
                }

                const session = sessionsSnapshot.docs[0].data();
                const sessionId = sessionsSnapshot.docs[0].id;

                // Check if student already checked in
                if (session.attendees && session.attendees.includes(currentUser.uid)) {
                    throw new Error('You have already checked in to this session');
                }

                // Get student's current location if required
                let studentLocation = null;
                let distance = 0;
                
                if (session.requireLocation) {
                    const position = await getCurrentPositionWithPermission();
                    studentLocation = new firebase.firestore.GeoPoint(position.coords.latitude, position.coords.longitude);

                    // Calculate distance between teacher and student
                    distance = calculateDistance(
                        session.location.latitude,
                        session.location.longitude,
                        studentLocation.latitude,
                        studentLocation.longitude
                    );

                    if (distance > session.range) {
                        throw new Error(`You are too far from the check-in location (${Math.round(distance)}m away, maximum is ${session.range}m)`);
                    }
                }

                // Record attendance
                await db.collection('attendance').add({
                    sessionId,
                    sectionId: section.id,
                    studentId: currentUser.uid,
                    studentName: currentUser.displayName || 'Student',
                    checkInTime: firebase.firestore.FieldValue.serverTimestamp(),
                    location: studentLocation,
                    distance,
                    status: 'present',
                    deviceInfo: navigator.userAgent
                });

                // Add to session attendees
                await db.collection('sessions').doc(sessionId).update({
                    attendees: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });

                hideLoading();
                showSuccess('Checked in successfully!');
            } catch (error) {
                hideLoading();
                showError(error.message);
            }
        }

        // Get Current Position with Permission Handling
        async function getCurrentPositionWithPermission() {
            try {
                if (geolocationPermission === 'denied') {
                    throw new Error('Location access was denied. Please enable it in your browser settings to check in.');
                }

                if (geolocationPermission === 'prompt') {
                    showLoading('Requesting location access...');
                }

                const position = await getCurrentPosition();
                
                if (geolocationPermission === 'prompt') {
                    // If we got here, permission was granted
                    geolocationPermission = 'granted';
                    hideLoading();
                }
                
                return position;
            } catch (error) {
                if (geolocationPermission === 'prompt') {
                    hideLoading();
                }
                
                if (error.code === error.PERMISSION_DENIED) {
                    geolocationPermission = 'denied';
                    throw new Error('Location access was denied. Please enable it in your browser settings to check in.');
                } else if (error.code === error.POSITION_UNAVAILABLE) {
                    throw new Error('Location information is unavailable. Please try again or check your connection.');
                } else if (error.code === error.TIMEOUT) {
                    throw new Error('The request to get your location timed out. Please try again.');
                } else {
                    throw new Error('An unknown error occurred while getting your location.');
                }
            }
        }

        // Get Current Position
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by your browser'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => resolve(position),
                    (error) => reject(error), {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Calculate Distance Between Two Points (in meters)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const 1 = lat1 * Math.PI / 180;
            const 2 = lat2 * Math.PI / 180;
            const  = (lat2 - lat1) * Math.PI / 180;
            const  = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin( / 2) * Math.sin( / 2) +
                Math.cos(1) * Math.cos(2) *
                Math.sin( / 2) * Math.sin( / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        // Show Loading Indicator
        function showLoading(message = 'Loading...') {
            let loading = document.getElementById('loading-overlay');

            if (!loading) {
                loading = document.createElement('div');
                loading.id = 'loading-overlay';
                loading.style.position = 'fixed';
                loading.style.top = '0';
                loading.style.left = '0';
                loading.style.right = '0';
                loading.style.bottom = '0';
                loading.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                loading.style.display = 'flex';
                loading.style.alignItems = 'center';
                loading.style.justifyContent = 'center';
                loading.style.zIndex = '1000';
                loading.style.color = 'white';
                loading.style.fontSize = '18px';
                loading.style.backdropFilter = 'blur(4px)';

                loading.innerHTML = `
                    <div style="text-align: center;">
                        <div class="spinner" style="width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; margin: 0 auto 16px;"></div>
                        <p>${message}</p>
                    </div>
                `;

                document.body.appendChild(loading);

                // Add spin animation
                const style = document.createElement('style');
                style.innerHTML = `
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            } else {
                loading.querySelector('p').textContent = message;
                loading.style.display = 'flex';
            }
        }

        // Hide Loading Indicator
        function hideLoading() {
            const loading = document.getElementById('loading-overlay');
            if (loading) {
                loading.style.display = 'none';
            }
        }

        // Show Error Message
        function showError(message) {
            // Remove existing error messages
            document.querySelectorAll('.error-message').forEach(el => el.remove());

            const error = document.createElement('div');
            error.className = 'error-message animated';
            error.setAttribute('role', 'alert');
            error.setAttribute('aria-live', 'assertive');
            error.style.position = 'fixed';
            error.style.bottom = '20px';
            error.style.left = '50%';
            error.style.transform = 'translateX(-50%)';
            error.style.backgroundColor = 'var(--error)';
            error.style.color = 'white';
            error.style.padding = '12px 24px';
            error.style.borderRadius = 'var(--border-radius)';
            error.style.boxShadow = 'var(--box-shadow)';
            error.style.zIndex = '1000';
            error.style.display = 'flex';
            error.style.alignItems = 'center';
            error.style.gap = '8px';
            error.style.maxWidth = '90%';
            error.style.wordBreak = 'break-word';

            error.innerHTML = `
                <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(error);

            setTimeout(() => {
                error.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => {
                    error.remove();
                }, 300);
            }, 5000);

            // Add animations if not already present
            if (!document.getElementById('error-animations')) {
                const style = document.createElement('style');
                style.id = 'error-animations';
                style.innerHTML = `
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateX(-50%) translateY(10px); }
                        to { opacity: 1; transform: translateX(-50%) translateY(0); }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; transform: translateX(-50%) translateY(0); }
                        to { opacity: 0; transform: translateX(-50%) translateY(10px); }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Show Success Message
        function showSuccess(message) {
            // Remove existing success messages
            document.querySelectorAll('.success-message').forEach(el => el.remove());

            const success = document.createElement('div');
            success.className = 'success-message animated';
            success.setAttribute('role', 'status');
            success.setAttribute('aria-live', 'polite');
            success.style.position = 'fixed';
            success.style.bottom = '20px';
            success.style.left = '50%';
            success.style.transform = 'translateX(-50%)';
            success.style.backgroundColor = 'var(--success)';
            success.style.color = 'white';
            success.style.padding = '12px 24px';
            success.style.borderRadius = 'var(--border-radius)';
            success.style.boxShadow = 'var(--box-shadow)';
            success.style.zIndex = '1000';
            success.style.display = 'flex';
            success.style.alignItems = 'center';
            success.style.gap = '8px';
            success.style.maxWidth = '90%';
            success.style.wordBreak = 'break-word';

            success.innerHTML = `
                <i class="fas fa-check-circle" aria-hidden="true"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(success);

            setTimeout(() => {
                success.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => {
                    success.remove();
                }, 300);
            }, 5000);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', initApp);

        // Handle window resize for responsive drawer
        window.addEventListener('resize', () => {
            if (document.querySelector('.drawer')) {
                updateDrawerState();
            }
        });
    </script>
</body>
</html>


missing insuffecient permissions if i try to join to the class and also names, roles sudendly turn to students if im registered as teacher if i refresh if it can be automatically shift, also implements everything fix the entire rules with alll the app functinalities and everything needs the app to functions with firebase, rewrite the entire rules be precise and be accurate on whats you can take
